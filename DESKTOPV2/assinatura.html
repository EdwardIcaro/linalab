<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Assinatura - LinaX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .subscription-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .subscription-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .card-header h2 {
            font-size: 1.8rem;
            color: #333;
            margin: 0;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .status-badge.active {
            background: #d1fae5;
            color: #059669;
        }

        .status-badge.trial {
            background: #fef3c7;
            color: #d97706;
        }

        .status-badge.expired {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-badge.lifetime {
            background: #e9d5ff;
            color: #7c3aed;
        }

        /* Grid simples para info */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .info-block {
            padding: 0;
        }

        .info-block-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-block-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
        }

        .info-block-value.highlight {
            color: #00bcd4;
        }

        /* Pricing */
        .pricing-section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 40px;
        }

        .pricing-section h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
            margin: 0 0 20px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pricing-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 1rem;
        }

        .pricing-row:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .pricing-row.total {
            font-weight: 700;
            color: #00bcd4;
            font-size: 1.1rem;
            margin-top: 10px;
            padding-top: 15px;
        }

        /* Features simples */
        .features-section {
            margin-bottom: 40px;
        }

        .features-section h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
            margin: 0 0 20px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .features-list {
            list-style: none;
            padding: 0;
            margin: 0;
            columns: 2;
            gap: 30px;
        }

        .features-list li {
            padding: 10px 0;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            break-inside: avoid;
        }

        .features-list li:before {
            content: "✓";
            color: #10b981;
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 20px;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: #00bcd4;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: #0097a7;
        }

        .cancel-link {
            color: #ef4444;
            text-decoration: none;
            font-size: 0.95rem;
            padding: 12px 0;
            cursor: pointer;
            transition: opacity 0.3s;
            align-self: center;
        }

        .cancel-link:hover {
            opacity: 0.7;
            text-decoration: underline;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal h3 {
            font-size: 1.5rem;
            color: #333;
            margin: 0 0 20px 0;
        }

        .modal .description {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal .warning {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 25px;
            font-size: 0.9rem;
            color: #991b1b;
        }

        .modal .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 0;
            border-top: none;
        }

        .modal .actions .btn {
            flex: 1;
        }

        .modal .btn-cancel {
            background: #f0f0f0;
            color: #333;
        }

        .modal .btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal .btn-confirm:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }

        .empty-state h2 {
            font-size: 1.3rem;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #999;
            margin-bottom: 25px;
        }

        .empty-state .btn {
            margin: 0 auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error-message {
            background: #fee2e2;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .subscription-container {
                margin: 20px auto;
            }

            .subscription-card {
                padding: 25px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .features-list {
                columns: 1;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
<link rel="stylesheet" href="webapp-mobile.css">
<link rel="stylesheet" href="fix-responsive.css">
</head>
<body x-data="subscriptionApp()" x-init="loadSubscription()">
    <div class="subscription-container">
        <!-- Erro -->
        <template x-if="error">
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i> <span x-text="error"></span>
            </div>
        </template>

        <!-- Sucesso -->
        <template x-if="success">
            <div class="success-message">
                <i class="fas fa-check-circle"></i> <span x-text="success"></span>
            </div>
        </template>

        <!-- Loading -->
        <template x-if="loading">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Carregando assinatura...
            </div>
        </template>

        <!-- Card de Assinatura -->
        <template x-if="!loading && subscription">
            <div class="subscription-card">
                <div class="card-header">
                    <div>
                        <h2 x-text="`Plano ${subscription.plan.nome}`"></h2>
                    </div>
                    <span class="status-badge" :class="statusClass(subscription.status)" x-text="statusText(subscription.status)"></span>
                </div>

                <!-- Info Básica -->
                <div class="info-grid">
                    <div class="info-block">
                        <div class="info-block-label">Valor Mensal</div>
                        <div class="info-block-value highlight" x-text="`R$ ${(subscription.preco / 100).toFixed(2)}`"></div>
                    </div>

                    <div class="info-block">
                        <div class="info-block-label">Data de Contratação</div>
                        <div class="info-block-value" x-text="formatDate(subscription.startDate)"></div>
                    </div>

                    <template x-if="!subscription.isCurrentlyTrial && subscription.nextBillingDate">
                        <div class="info-block">
                            <div class="info-block-label">Próxima Cobrança</div>
                            <div class="info-block-value" x-text="formatDate(subscription.nextBillingDate)"></div>
                        </div>
                    </template>

                    <template x-if="subscription.isCurrentlyTrial && subscription.trialEndDate">
                        <div class="info-block">
                            <div class="info-block-label">Trial Encerra Em</div>
                            <div class="info-block-value" x-text="formatDate(subscription.trialEndDate)"></div>
                        </div>
                    </template>
                </div>

                <!-- Pricing Breakdown -->
                <template x-if="pricing">
                    <div class="pricing-section">
                        <h3>Detalhamento de Custos</h3>
                        <div class="pricing-row">
                            <span x-text="`Plano ${subscription.plan.nome}`"></span>
                            <strong x-text="`R$ ${(pricing.planPrice / 100).toFixed(2)}`"></strong>
                        </div>
                        <template x-if="pricing.addonsPrice > 0">
                            <div class="pricing-row">
                                <span>Add-ons</span>
                                <strong style="color: #f59e0b;" x-text="`+ R$ ${(pricing.addonsPrice / 100).toFixed(2)}`"></strong>
                            </div>
                        </template>
                        <div class="pricing-row total">
                            <span>Total Mensal</span>
                            <span x-text="`R$ ${(pricing.totalPrice / 100).toFixed(2)}`"></span>
                        </div>
                    </div>
                </template>

                <!-- Recursos -->
                <div class="features-section">
                    <h3>✓ Recursos Inclusos</h3>
                    <ul class="features-list">
                        <template x-for="feature in subscription.plan.features" :key="feature">
                            <li x-text="formatFeature(feature)"></li>
                        </template>
                    </ul>
                </div>

                <!-- Actions -->
                <div class="actions">
                    <button class="btn btn-primary" @click="goToConfigs()">
                        <i class="fas fa-sliders-h"></i> Configurações
                    </button>
                    <a class="cancel-link" @click="openCancelModal()">
                        Cancelar assinatura
                    </a>
                </div>
            </div>
        </template>

        <!-- Empty State -->
        <template x-if="!loading && !subscription">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h2>Nenhuma Assinatura Ativa</h2>
                <p>Você precisa de uma assinatura para acessar o LinaX</p>
                <button class="btn btn-primary" @click="window.location.href='planos.html'">
                    <i class="fas fa-star"></i> Escolher um Plano
                </button>
            </div>
        </template>
    </div>

    <!-- Modal de Cancelamento -->
    <div class="modal-overlay" :class="{ active: showCancelModal }" @click.self="closeCancelModal()">
        <div class="modal">
            <h3>⚠️ Cancelar Assinatura</h3>
            <div class="description">
                Você está prestes a cancelar sua assinatura. Isso significa que você perderá acesso a todas as funcionalidades do LinaX.
            </div>
            <div class="warning">
                <strong>Você perderá:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                    <li>Acesso a todas as features do plano</li>
                    <li>Possibilidade de criar novas empresas</li>
                    <li>Dados de análises e relatórios</li>
                </ul>
            </div>
            <template x-if="daysRemaining > 0">
                <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 15px; border-radius: 6px; margin-bottom: 25px; font-size: 0.9rem; color: #065f46;">
                    <strong>ℹ️ Dias Restantes:</strong> Você ainda tem <strong x-text="daysRemaining"></strong> dias de acesso restantes.
                </div>
            </template>
            <div class="actions">
                <button class="btn btn-cancel" @click="closeCancelModal()">
                    Manter Assinatura
                </button>
                <button class="btn btn-confirm" @click="confirmCancel()" :disabled="processing">
                    <template x-if="processing">
                        <i class="fas fa-spinner fa-spin"></i> Cancelando...
                    </template>
                    <template x-if="!processing">
                        <i class="fas fa-trash"></i> Sim, Cancelar
                    </template>
                </button>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        function subscriptionApp() {
            return {
                subscription: null,
                pricing: null,
                loading: true,
                processing: false,
                error: '',
                success: '',
                showCancelModal: false,
                daysRemaining: 0,

                async loadSubscription() {
                    try {
                        const response = await api.getMySubscription();
                        if (response.hasSubscription) {
                            this.subscription = response.subscription;

                            try {
                                const pricingResponse = await api.getPricingBreakdown();
                                if (pricingResponse.hasSubscription) {
                                    this.pricing = pricingResponse.pricing;
                                }
                            } catch (error) {
                                console.warn('Pricing não disponível:', error);
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao carregar assinatura:', error);
                        this.error = 'Erro ao carregar assinatura';
                    } finally {
                        this.loading = false;
                    }
                },

                statusClass(status) {
                    const map = {
                        'ACTIVE': 'active',
                        'TRIAL': 'trial',
                        'LIFETIME': 'lifetime',
                        'EXPIRED': 'expired',
                        'CANCELED': 'expired',
                        'PAST_DUE': 'expired'
                    };
                    return map[status] || 'expired';
                },

                statusText(status) {
                    const map = {
                        'ACTIVE': '✅ Ativa',
                        'TRIAL': '⏳ Em Trial',
                        'LIFETIME': '⭐ Vitalícia',
                        'EXPIRED': '❌ Expirada',
                        'CANCELED': '❌ Cancelada',
                        'PAST_DUE': '⚠️ Pagamento Pendente'
                    };
                    return map[status] || status;
                },

                formatDate(dateString) {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('pt-BR');
                },

                formatFeature(feature) {
                    const map = {
                        'suporte_24_7': 'Suporte 24/7',
                        'relatorios_pdf': 'Relatórios em PDF',
                        'gestao_vendas': 'Gestão de Vendas',
                        'controle_servicos': 'Controle de Serviços',
                        'organizacao_financeira': 'Organização Financeira',
                        'personalizacao_completa': 'Personalização Completa',
                        'painel_vitrine': 'Painel Vitrine',
                        'catalogo_servicos': 'Catálogo de Serviços',
                        'lina_whatsapp': 'Lina WhatsApp',
                        'notificacoes_automaticas': 'Notificações Automáticas',
                        'prioridade_suporte': 'Prioridade no Suporte'
                    };
                    return map[feature] || feature;
                },

                goToConfigs() {
                    window.location.href = 'configuracoes.html';
                },

                openCancelModal() {
                    // Calcular dias restantes
                    if (this.subscription?.nextBillingDate) {
                        const now = new Date();
                        const nextBilling = new Date(this.subscription.nextBillingDate);
                        const diff = nextBilling.getTime() - now.getTime();
                        this.daysRemaining = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    }
                    this.showCancelModal = true;
                },

                closeCancelModal() {
                    this.showCancelModal = false;
                },

                async confirmCancel() {
                    const confirmed = confirm(
                        'Tem certeza que deseja cancelar sua assinatura?\n\n' +
                        'Esta ação não pode ser desfeita imediatamente.'
                    );

                    if (!confirmed) return;

                    this.processing = true;
                    this.error = '';

                    try {
                        await api.cancelSubscription();

                        this.showCancelModal = false;
                        this.success = this.daysRemaining > 0
                            ? `✅ Assinatura cancelada. Você tem acesso até ${this.formatDate(this.subscription.nextBillingDate)}`
                            : '✅ Assinatura cancelada com sucesso';

                        setTimeout(() => {
                            window.location.href = 'planos.html';
                        }, 3000);
                    } catch (error) {
                        console.error('Erro ao cancelar:', error);
                        this.error = error.message || 'Erro ao cancelar assinatura';
                    } finally {
                        this.processing = false;
                    }
                }
            };
        }
    </script>
<script src="mobile-nav.js"></script>
<script src="webapp-bottom-nav.js"></script>
<nav class="bottom-navigation">
    <a href="index.html" class="bottom-nav-item" data-page="home" title="Dashboard">
        <i class="fas fa-home"></i>
        <span>Início</span>
    </a>
    <a href="ordens.html" class="bottom-nav-item" data-page="ordens" title="Minhas Ordens">
        <i class="fas fa-list-check"></i>
        <span>Ordens</span>
    </a>
    <a href="novaordem.html" class="bottom-nav-item" data-page="novaordem" title="Nova Ordem">
        <i class="fas fa-plus-circle"></i>
        <span>Nova</span>
    </a>
    <a href="clientes.html" class="bottom-nav-item" data-page="clientes" title="Clientes">
        <i class="fas fa-users"></i>
        <span>Clientes</span>
    </a>
    <a href="#" class="bottom-nav-item" data-page="menu" onclick="toggleMobileMenu(event)" title="Menu">
        <i class="fas fa-bars"></i>
        <span>Menu</span>
    </a>
</nav>
</body>
</html>
