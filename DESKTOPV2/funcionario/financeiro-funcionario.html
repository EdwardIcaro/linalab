<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lina X - Financeiro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0066cc;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #333;
      --border: #ddd;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --green: #10b981;
      --red: #ef4444;
      --blue: #3b82f6;
      --orange: #f59e0b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light);
      color: var(--dark);
    }

    /* HEADER */
    .header-funcionario {
      background: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--primary);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .logo-link {
      text-decoration: none;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .page-info h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .page-info p {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    .icon-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--dark);
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .icon-btn:hover {
      background: var(--light);
      color: var(--primary);
    }

    /* MAIN */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }

    /* BALANCE CARDS */
    .balance-hero {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1100px) {
      .balance-hero {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .balance-hero {
        grid-template-columns: 1fr;
      }
    }

    .balance-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }

    .balance-card.green::before { background: var(--green); }
    .balance-card.red::before { background: var(--red); }
    .balance-card.blue::before { background: var(--blue); }
    .balance-card.orange::before { background: var(--orange); }

    .balance-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .balance-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .balance-card.green .balance-value { color: var(--green); }
    .balance-card.red .balance-value { color: var(--red); }
    .balance-card.blue .balance-value { color: var(--blue); }
    .balance-card.orange .balance-value { color: var(--orange); }

    /* TABS */
    .tabs-container {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .tabs-header {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0;
      background: var(--light);
    }

    .tab-btn {
      flex: 1;
      padding: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
    }

    .tab-btn:hover {
      color: var(--primary);
      background: rgba(0, 102, 204, 0.05);
    }

    .tab-btn.active {
      color: var(--primary);
      background: white;
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .tabs-content {
      min-height: 300px;
    }

    .tab-pane {
      display: none;
      padding: 24px;
      animation: fadeIn 0.3s ease;
    }

    .tab-pane.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* FILTERS */
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-select,
    .filter-input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-select:focus,
    .filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .preset-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .preset-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s;
      color: #666;
    }

    .preset-btn:hover,
    .preset-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* TABLE */
    .table-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--light);
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--dark);
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--light);
    }

    /* ACTION BUTTONS */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      color: var(--dark);
    }

    .action-btn:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
      color: var(--primary);
    }

    .action-btn i {
      font-size: 24px;
    }

    .action-btn span {
      font-weight: 600;
      font-size: 14px;
      text-align: center;
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 20px;
      display: block;
    }

    .empty-state h2 {
      font-size: 20px;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: #0052a3;
    }

    /* LOADING */
    .loading-container {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      border: 4px solid var(--light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* STATUS BADGE */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pendente {
      background: rgba(255, 193, 7, 0.2);
      color: #ff9800;
    }

    .status-completo {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel,
    .btn-submit {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: var(--light);
      color: var(--dark);
    }

    .btn-cancel:hover {
      background: #e0e0e0;
    }

    .btn-submit {
      background: var(--primary);
      color: white;
    }

    .btn-submit:hover {
      background: #0052a3;
    }

    /* MENU */
    .menu-dropdown {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      min-width: 200px;
      z-index: 999;
      animation: slideUp 0.3s ease;
    }

    .menu-dropdown.active {
      display: block;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-dropdown a,
    .menu-dropdown button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--dark);
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .menu-dropdown a:hover,
    .menu-dropdown button:hover {
      background: var(--light);
      color: var(--primary);
    }

    .menu-dropdown button:last-child {
      color: var(--danger);
    }

    .menu-dropdown button:last-child:hover {
      background: rgba(220, 53, 69, 0.1);
    }

    /* OVERLAY */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }

    .overlay.active {
      display: block;
    }

    /* MOBILE NAV */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      height: 70px;
      z-index: 999;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #666;
      font-size: 11px;
      gap: 4px;
      transition: all 0.3s;
      border: none;
      background: none;
      cursor: pointer;
      border-top: 3px solid transparent;
    }

    .nav-item:hover {
      color: var(--primary);
    }

    .nav-item.active {
      color: var(--primary);
      border-top-color: var(--primary);
    }

    .nav-item i {
      font-size: 24px;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 20px;
      right: 20px;
      max-width: 400px;
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1001;
      transform: translateY(120px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateY(0);
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-success i {
      color: var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--danger);
    }

    .toast-error i {
      color: var(--danger);
    }

    /* CONFIRM DIALOG */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .confirm-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
    }

    .confirm-box {
      position: relative;
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .confirm-box h2 {
      font-size: 18px;
      margin-bottom: 12px;
    }

    .confirm-box p {
      color: #666;
      margin-bottom: 24px;
    }

    .confirm-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn-cancel,
    .btn-confirm {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: var(--light);
      color: var(--dark);
    }

    .btn-cancel:hover {
      background: #e0e0e0;
    }

    .btn-confirm {
      background: var(--primary);
      color: white;
    }

    .btn-confirm:hover {
      background: #0052a3;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .main-container {
        padding: 16px;
        padding-bottom: 100px;
      }

      .balance-hero {
        grid-template-columns: repeat(2, 1fr);
      }

      .tab-btn {
        font-size: 12px;
        padding: 12px;
      }

      .tabs-header {
        overflow-x: auto;
      }

      .action-buttons {
        grid-template-columns: repeat(2, 1fr);
      }

      th, td {
        padding: 8px 12px;
        font-size: 12px;
      }

      .filters {
        flex-direction: column;
      }

      .filter-select,
      .filter-input {
        width: 100%;
      }

      .preset-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div id="header"></div>

  <!-- MENU -->
  <div id="menu"></div>
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <!-- MAIN CONTENT -->
  <main class="main-container">
    <!-- BALANCE CARDS -->
    <section class="balance-hero" id="balanceCards"></section>

    <!-- TABS CONTAINER -->
    <section class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" data-tab="movimentacoes" onclick="switchTab('movimentacoes')">
          <i class="fas fa-exchange-alt"></i>
          <span>Movimentações</span>
        </button>
        <button class="tab-btn" data-tab="caixa" onclick="switchTab('caixa')">
          <i class="fas fa-cash-register"></i>
          <span>Controle de Caixa</span>
        </button>
        <button class="tab-btn" data-tab="pendencias" onclick="switchTab('pendencias')">
          <i class="fas fa-clock"></i>
          <span>Pendências</span>
        </button>
      </div>

      <div class="tabs-content">
        <div id="tab-movimentacoes" class="tab-pane active"></div>
        <div id="tab-caixa" class="tab-pane"></div>
        <div id="tab-pendencias" class="tab-pane"></div>
      </div>
    </section>
  </main>

  <!-- MOBILE NAV -->
  <nav id="mobileNav"></nav>

  <!-- TRANSACTION MODAL -->
  <div id="transactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Lançar Transação</h2>
        <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
      </div>
      <form id="transactionForm" onsubmit="submitTransaction(event)">
        <div class="form-group">
          <label>Descrição</label>
          <input type="text" id="transactionDescription" required placeholder="Ex: Compra de material">
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" id="transactionValue" required placeholder="0.00" step="0.01" min="0">
        </div>
        <input type="hidden" id="transactionType" value="">
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closeTransactionModal()">Cancelar</button>
          <button type="submit" class="btn-submit">Lançar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="../api.js"></script>
  <script src="utils-funcionario.js"></script>

  <script>
    // PAGE CONFIGURATION
    const PAGE_TITLE = 'Financeiro';
    const PAGE_ACTIVE = 'financeiro';

    let currentTab = 'movimentacoes';
    let currentTransactionType = '';
    let filters = {
      dataInicio: new Date().toISOString().split('T')[0],
      dataFim: new Date().toISOString().split('T')[0],
      tipo: '',
      preset: 'today'
    };

    // INITIALIZE
    document.addEventListener('DOMContentLoaded', async () => {
      if (!validateFuncionarioAccess()) return;

      const permissoes = JSON.parse(localStorage.getItem('permissoes') || '[]');
      if (!permissoes.includes('ver_financeiro')) {
        showToast('Você não tem permissão para visualizar o financeiro', 'error');
        setTimeout(() => {
          window.location.href = '../index-funcionario.html';
        }, 1500);
        return;
      }

      document.getElementById('header').innerHTML = createFuncionarioHeader(PAGE_TITLE);
      document.getElementById('menu').innerHTML = createFuncionarioMenu();
      document.getElementById('mobileNav').innerHTML = createMobileNav(PAGE_ACTIVE);

      await loadUserInfo();

      await loadBalanceCards();
      await loadMovimentacoes();
    });

    // SWITCH TAB
    async function switchTab(tab) {
      // Update UI
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });

      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });
      document.getElementById(`tab-${tab}`).classList.add('active');

      currentTab = tab;

      // Load data
      switch(tab) {
        case 'movimentacoes':
          await loadMovimentacoes();
          break;
        case 'caixa':
          await loadCaixa();
          break;
        case 'pendencias':
          await loadPendencias();
          break;
      }
    }

    // LOAD BALANCE CARDS
    async function loadBalanceCards() {
      const container = document.getElementById('balanceCards');

      try {
        const response = await window.api.getResumoDia();
        const resumo = response || {};

        const saldo = resumo.saldo || 0;
        const entrada = resumo.entrada || 0;
        const saida = resumo.saida || 0;
        const pendentes = resumo.pendentes || 0;

        container.innerHTML = `
          <div class="balance-card green">
            <div class="balance-label">Saldo Atual</div>
            <div class="balance-value">${formatCurrency(saldo)}</div>
          </div>
          <div class="balance-card blue">
            <div class="balance-label">Entrada</div>
            <div class="balance-value">${formatCurrency(entrada)}</div>
          </div>
          <div class="balance-card orange">
            <div class="balance-label">Saída</div>
            <div class="balance-value">${formatCurrency(saida)}</div>
          </div>
          <div class="balance-card red">
            <div class="balance-label">Pendentes</div>
            <div class="balance-value">${formatCurrency(pendentes)}</div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao carregar balanço:', error);
        container.innerHTML = '<div class="empty-state"><p>Erro ao carregar balanço</p></div>';
      }
    }

    // LOAD MOVIMENTAÇÕES
    async function loadMovimentacoes() {
      const container = document.getElementById('tab-movimentacoes');

      try {
        container.innerHTML = createLoading();

        const response = await window.api.getHistoricoCaixa({
          dataInicio: filters.dataInicio,
          dataFim: filters.dataFim,
          tipo: filters.tipo
        });

        const movimentacoes = response.historico || [];

        let filterHtml = `
          <div class="filters">
            <input type="date" class="filter-input" id="dataInicio" value="${filters.dataInicio}" onchange="updateDateFilter()">
            <input type="date" class="filter-input" id="dataFim" value="${filters.dataFim}" onchange="updateDateFilter()">
            <select class="filter-select" id="tipoFilter" onchange="updateTipoFilter()">
              <option value="">Todos os tipos</option>
              <option value="entrada">Entrada</option>
              <option value="saida">Saída</option>
            </select>
          </div>
          <div class="preset-buttons">
            <button class="preset-btn ${filters.preset === 'today' ? 'active' : ''}" onclick="applyPreset('today')">Hoje</button>
            <button class="preset-btn ${filters.preset === 'week' ? 'active' : ''}" onclick="applyPreset('week')">Esta Semana</button>
            <button class="preset-btn ${filters.preset === 'month' ? 'active' : ''}" onclick="applyPreset('month')">Este Mês</button>
          </div>
        `;

        if (movimentacoes.length === 0) {
          container.innerHTML = filterHtml + createEmptyState(
            'fa-inbox',
            'Nenhuma movimentação',
            'Não há movimentações neste período.'
          );
          return;
        }

        let html = filterHtml + `
          <div class="table-container">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                  </tr>
                </thead>
                <tbody>
        `;

        movimentacoes.forEach(mov => {
          const tipoLabel = mov.tipo === 'entrada' ? 'Entrada' : 'Saída';
          const tipoClass = mov.tipo === 'entrada' ? 'status-completo' : 'status-pendente';
          html += `
            <tr>
              <td>${formatDate(mov.data)}</td>
              <td>${mov.descricao || '-'}</td>
              <td><span class="status-badge ${tipoClass}">${tipoLabel}</span></td>
              <td>${formatCurrency(mov.valor)}</td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        container.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar movimentações:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar as movimentações.',
          'Tentar novamente',
          'loadMovimentacoes()'
        );
      }
    }

    // LOAD CONTROLE DE CAIXA
    async function loadCaixa() {
      const container = document.getElementById('tab-caixa');

      try {
        container.innerHTML = `
          <div class="action-buttons">
            <button class="action-btn" onclick="openTransactionModal('despesa')">
              <i class="fas fa-receipt"></i>
              <span>Lançar Despesa</span>
            </button>
            <button class="action-btn" onclick="openTransactionModal('sangria')">
              <i class="fas fa-money-bill"></i>
              <span>Sangria</span>
            </button>
            <button class="action-btn" onclick="openTransactionModal('suprimento')">
              <i class="fas fa-plus-circle"></i>
              <span>Suprimento</span>
            </button>
            <button class="action-btn" onclick="closeCashRegister()">
              <i class="fas fa-check-circle"></i>
              <span>Fechar Caixa</span>
            </button>
          </div>
          <div id="caixaHistory"></div>
        `;

        // Load recent transactions for cash control
        const response = await window.api.getHistoricoCaixa({
          dataInicio: new Date().toISOString().split('T')[0],
          dataFim: new Date().toISOString().split('T')[0],
          tipo: ''
        });

        const movimentacoes = response.historico || [];
        let historyHtml = '';

        if (movimentacoes.length > 0) {
          historyHtml = `
            <h3 style="margin-bottom: 16px;">Movimentações de Hoje</h3>
            <div class="table-container">
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>Hora</th>
                      <th>Descrição</th>
                      <th>Tipo</th>
                      <th>Valor</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          movimentacoes.forEach(mov => {
            const tipoLabel = mov.tipo === 'entrada' ? 'Entrada' : 'Saída';
            const tipoClass = mov.tipo === 'entrada' ? 'status-completo' : 'status-pendente';
            const time = new Date(mov.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            historyHtml += `
              <tr>
                <td>${time}</td>
                <td>${mov.descricao || '-'}</td>
                <td><span class="status-badge ${tipoClass}">${tipoLabel}</span></td>
                <td>${formatCurrency(mov.valor)}</td>
              </tr>
            `;
          });

          historyHtml += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        document.getElementById('caixaHistory').innerHTML = historyHtml;
      } catch (error) {
        console.error('Erro ao carregar controle de caixa:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar o controle de caixa.',
          'Tentar novamente',
          'loadCaixa()'
        );
      }
    }

    // LOAD PENDÊNCIAS
    async function loadPendencias() {
      const container = document.getElementById('tab-pendencias');

      try {
        container.innerHTML = createLoading();

        const response = await window.api.getOrdens(1, 100, '', 'AGUARDANDO_PAGAMENTO');
        const ordens = response.data || response.ordens || [];

        if (ordens.length === 0) {
          container.innerHTML = createEmptyState(
            'fa-check-circle',
            'Sem pendências',
            'Não há ordens aguardando pagamento.'
          );
          return;
        }

        let html = `
          <div class="table-container">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Veículo</th>
                    <th>Valor</th>
                    <th>Data</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
        `;

        ordens.forEach(ordem => {
          html += `
            <tr>
              <td>#${ordem.numeroOrdem || ordem.id.substring(0, 8)}</td>
              <td>${ordem.cliente?.nome || '-'}</td>
              <td>${ordem.veiculo?.placa || '-'}</td>
              <td>${formatCurrency(ordem.valorTotal || ordem.valor)}</td>
              <td>${formatDate(ordem.createdAt)}</td>
              <td><span class="status-badge status-pendente">AGUARDANDO</span></td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        container.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar pendências:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar as pendências.',
          'Tentar novamente',
          'loadPendencias()'
        );
      }
    }

    // TRANSACTION MODAL
    function openTransactionModal(type) {
      currentTransactionType = type;
      const modal = document.getElementById('transactionModal');
      const title = document.getElementById('modalTitle');
      const typeInput = document.getElementById('transactionType');

      let titleText = '';
      switch(type) {
        case 'despesa':
          titleText = 'Lançar Despesa';
          break;
        case 'sangria':
          titleText = 'Sangria';
          break;
        case 'suprimento':
          titleText = 'Suprimento';
          break;
      }

      title.textContent = titleText;
      typeInput.value = type;

      document.getElementById('transactionForm').reset();
      modal.classList.add('active');
    }

    function closeTransactionModal() {
      document.getElementById('transactionModal').classList.remove('active');
      document.getElementById('transactionForm').reset();
    }

    async function submitTransaction(event) {
      event.preventDefault();

      const description = document.getElementById('transactionDescription').value;
      const value = parseFloat(document.getElementById('transactionValue').value);
      const type = document.getElementById('transactionType').value;

      if (!description || !value) {
        showToast('Preencha todos os campos', 'error');
        return;
      }

      try {
        const transactionData = {
          descricao: description,
          valor: value,
          tipo: type === 'despesa' ? 'saida' : 'entrada',
          data: new Date().toISOString(),
          tipo_transacao: type
        };

        await window.api.createCaixaMovimento(transactionData);

        showToast('Transação lançada com sucesso!', 'success');
        closeTransactionModal();
        await loadBalanceCards();
        await loadCaixa();
      } catch (error) {
        console.error('Erro ao lançar transação:', error);
        showToast('Erro ao lançar transação', 'error');
      }
    }

    async function closeCashRegister() {
      showConfirm(
        'Fechar Caixa',
        'Tem certeza que deseja fechar o caixa? Esta ação não pode ser desfeita.',
        async () => {
          try {
            await window.api.closeCaixa();
            showToast('Caixa fechado com sucesso!', 'success');
            await loadBalanceCards();
            await loadCaixa();
          } catch (error) {
            console.error('Erro ao fechar caixa:', error);
            showToast('Erro ao fechar caixa', 'error');
          }
        }
      );
    }

    // FILTER FUNCTIONS
    function updateDateFilter() {
      filters.dataInicio = document.getElementById('dataInicio').value;
      filters.dataFim = document.getElementById('dataFim').value;
      filters.preset = '';
      loadMovimentacoes();
    }

    function updateTipoFilter() {
      filters.tipo = document.getElementById('tipoFilter').value;
      loadMovimentacoes();
    }

    function applyPreset(preset) {
      const dates = getDatePreset(preset);
      filters.dataInicio = dates.dataInicio;
      filters.dataFim = dates.dataFim;
      filters.preset = preset;

      const dataInicioInput = document.getElementById('dataInicio');
      const dataFimInput = document.getElementById('dataFim');
      if (dataInicioInput) dataInicioInput.value = dates.dataInicio;
      if (dataFimInput) dataFimInput.value = dates.dataFim;

      // Update preset button states
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.innerText.toLowerCase().includes(preset));
      });

      loadMovimentacoes();
    }
  </script>
</body>
</html>
