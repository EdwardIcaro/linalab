<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lina X - Financeiro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0066cc;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #333;
      --border: #ddd;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --green: #10b981;
      --red: #ef4444;
      --blue: #3b82f6;
      --orange: #f59e0b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--light);
      color: var(--dark);
    }

    /* HEADER */
    .header-funcionario {
      background: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--primary);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .logo-link {
      text-decoration: none;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .page-info h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .page-info p {
      font-size: 12px;
      color: #666;
      margin: 0;
    }

    .icon-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--dark);
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .icon-btn:hover {
      background: var(--light);
      color: var(--primary);
    }

    /* MAIN */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px;
    }

    /* BALANCE CARDS */
    .balance-hero {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1100px) {
      .balance-hero {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .balance-hero {
        grid-template-columns: 1fr;
      }
    }

    .balance-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }

    .balance-card.green::before { background: var(--green); }
    .balance-card.red::before { background: var(--red); }
    .balance-card.orange::before { background: var(--orange); }

    .balance-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .balance-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .balance-card.green .balance-value { color: var(--green); }
    .balance-card.red .balance-value { color: var(--red); }
    .balance-card.orange .balance-value { color: var(--orange); }

    /* TABS */
    .tabs-container {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .tabs-header {
      display: flex;
      border-bottom: 1px solid var(--border);
      padding: 0;
      background: var(--light);
    }

    .tab-btn {
      flex: 1;
      padding: 16px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--primary);
      background: rgba(0, 102, 204, 0.05);
    }

    .tab-btn.active {
      color: var(--primary);
      background: white;
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
    }

    .tabs-content {
      min-height: 300px;
    }

    .tab-pane {
      display: none;
      padding: 24px;
      animation: fadeIn 0.3s ease;
    }

    .tab-pane.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* COMISS√ïES SECTION */
    .comissoes-filters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    @media (max-width: 768px) {
      .comissoes-filters {
        grid-template-columns: 1fr;
      }
    }

    .comissoes-filters label {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
    }

    .comissoes-filters input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }

    .comissoes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 1024px) {
      .comissoes-grid {
        grid-template-columns: 1fr;
      }
    }

    .comissoes-column {
      background: white;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .comissoes-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .comissoes-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .comissoes-icon.creditos {
      background: var(--green);
    }

    .comissoes-icon.debitos {
      background: var(--red);
    }

    .comissoes-header h3 {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
      margin: 0;
    }

    .comissoes-badge {
      background: rgba(0, 102, 204, 0.1);
      color: var(--primary);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .comissoes-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
      background: var(--light);
      margin-bottom: 12px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .comissoes-item:hover {
      box-shadow: var(--shadow);
      transform: translateX(4px);
    }

    .comissoes-item-details {
      flex: 1;
      min-width: 0;
    }

    .comissoes-item-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--dark);
    }

    .comissoes-item-subtitle {
      font-size: 12px;
      color: #666;
    }

    .comissoes-item-value {
      font-size: 16px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .comissoes-item-value.credito {
      color: var(--green);
    }

    .comissoes-item-value.debito {
      color: var(--red);
    }

    .comissoes-summary {
      background: linear-gradient(135deg, var(--primary) 0%, #0052a3 100%);
      border-radius: 8px;
      padding: 24px;
      color: white;
      margin-bottom: 24px;
    }

    .comissoes-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .comissoes-summary-row:last-child {
      border-bottom: none;
      padding-top: 16px;
      margin-top: 8px;
      border-top: 2px solid rgba(255, 255, 255, 0.3);
    }

    .comissoes-summary-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .comissoes-summary-value {
      font-size: 18px;
      font-weight: 700;
    }

    .comissoes-summary-total {
      font-size: 28px;
      font-weight: 700;
    }

    /* ACTION BUTTONS */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .action-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
      transform: translateY(-2px);
      color: var(--primary);
    }

    .action-btn i {
      font-size: 24px;
    }

    .action-btn span {
      font-weight: 600;
      font-size: 14px;
      text-align: center;
    }

    /* FILTERS */
    .filters {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-select,
    .filter-input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    .filter-select:focus,
    .filter-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .preset-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .preset-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
    }

    .preset-btn:hover,
    .preset-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* TABLE */
    .table-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--light);
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    tbody tr:hover {
      background: var(--light);
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 20px;
      display: block;
    }

    .empty-state h2 {
      font-size: 20px;
      color: var(--dark);
      margin-bottom: 8px;
    }

    /* LOADING */
    .loading-container {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      border: 4px solid var(--light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* STATUS BADGE */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pendente {
      background: rgba(255, 193, 7, 0.2);
      color: #ff9800;
    }

    .status-completo {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel,
    .btn-submit {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-cancel {
      background: var(--light);
      color: var(--dark);
    }

    .btn-cancel:hover {
      background: #e0e0e0;
    }

    .btn-submit {
      background: var(--primary);
      color: white;
    }

    .btn-submit:hover {
      background: #0052a3;
    }

    /* MENU */
    .menu-dropdown {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      min-width: 200px;
      z-index: 999;
      animation: slideUp 0.3s ease;
    }

    .menu-dropdown.active {
      display: block;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .menu-dropdown a,
    .menu-dropdown button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--dark);
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .menu-dropdown a:hover,
    .menu-dropdown button:hover {
      background: var(--light);
      color: var(--primary);
    }

    .menu-dropdown button:last-child {
      color: var(--danger);
    }

    /* OVERLAY */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }

    .overlay.active {
      display: block;
    }

    /* MOBILE NAV */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      height: 70px;
      z-index: 999;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #666;
      font-size: 11px;
      gap: 4px;
      transition: all 0.3s;
      border: none;
      background: none;
      cursor: pointer;
      border-top: 3px solid transparent;
    }

    .nav-item:hover {
      color: var(--primary);
    }

    .nav-item.active {
      color: var(--primary);
      border-top-color: var(--primary);
    }

    .nav-item i {
      font-size: 24px;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 20px;
      right: 20px;
      max-width: 400px;
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1001;
      transform: translateY(120px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateY(0);
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-success i {
      color: var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--danger);
    }

    .toast-error i {
      color: var(--danger);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .main-container {
        padding: 16px;
        padding-bottom: 100px;
      }

      th, td {
        padding: 8px 12px;
        font-size: 12px;
      }

      .filters {
        flex-direction: column;
      }

      .filter-select,
      .filter-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div id="header"></div>

  <!-- MENU -->
  <div id="menu"></div>
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <!-- MAIN CONTENT -->
  <main class="main-container">
    <!-- BALANCE CARDS -->
    <section class="balance-hero" id="balanceCards"></section>

    <!-- TABS CONTAINER -->
    <section class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" data-tab="movimentacoes" onclick="switchTab('movimentacoes')">
          <i class="fas fa-exchange-alt"></i>
          <span>Movimenta√ß√µes</span>
        </button>
        <button class="tab-btn" data-tab="caixa" onclick="switchTab('caixa')">
          <i class="fas fa-cash-register"></i>
          <span>Controle de Caixa</span>
        </button>
        <button class="tab-btn" data-tab="comissoes" onclick="switchTab('comissoes')">
          <i class="fas fa-coins"></i>
          <span>Comiss√µes</span>
        </button>
        <button class="tab-btn" data-tab="pendencias" onclick="switchTab('pendencias')">
          <i class="fas fa-clock"></i>
          <span>Pend√™ncias</span>
        </button>
      </div>

      <div class="tabs-content">
        <div id="tab-movimentacoes" class="tab-pane active"></div>
        <div id="tab-caixa" class="tab-pane"></div>
        <div id="tab-comissoes" class="tab-pane"></div>
        <div id="tab-pendencias" class="tab-pane"></div>
      </div>
    </section>
  </main>

  <!-- MOBILE NAV -->
  <nav id="mobileNav"></nav>

  <!-- TRANSACTION MODAL -->
  <div id="transactionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Lan√ßar Transa√ß√£o</h2>
        <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
      </div>
      <form id="transactionForm" onsubmit="submitTransaction(event)">
        <div class="form-group">
          <label>Descri√ß√£o</label>
          <input type="text" id="transactionDescription" required placeholder="Ex: Compra de material">
        </div>
        <div class="form-group">
          <label>Forma de Pagamento</label>
          <select id="transactionFormaPagamento" required>
            <option value="">Selecione...</option>
            <option value="DINHEIRO">Dinheiro</option>
            <option value="CARTAO">Cart√£o</option>
            <option value="PIX">Pix</option>
            <option value="NFE">NFe</option>
            <option value="CHEQUE">Cheque</option>
          </select>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" id="transactionValue" required placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-group" id="fornecedorGroup" style="display: none;">
          <label>Fornecedor (Opcional)</label>
          <input type="text" id="transactionFornecedor" placeholder="Nome do fornecedor">
        </div>
        <input type="hidden" id="transactionType" value="">
        <div class="modal-buttons">
          <button type="button" class="btn-cancel" onclick="closeTransactionModal()">Cancelar</button>
          <button type="submit" class="btn-submit">Lan√ßar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="../api.js"></script>
  <script src="utils-funcionario.js"></script>

  <script>
    // PAGE CONFIGURATION
    const PAGE_TITLE = 'Financeiro';
    const PAGE_ACTIVE = 'financeiro';

    let currentTab = 'movimentacoes';
    let currentTransactionType = '';
    let filters = {
      dataInicio: new Date().toISOString().split('T')[0],
      dataFim: new Date().toISOString().split('T')[0],
      tipo: '',
      preset: 'today'
    };

    // INITIALIZE
    document.addEventListener('DOMContentLoaded', async () => {
      if (!validateFuncionarioAccess()) return;

      const permissoes = JSON.parse(localStorage.getItem('permissoes') || '[]');
      if (!permissoes.includes('ver_financeiro')) {
        showToast('Voc√™ n√£o tem permiss√£o para visualizar o financeiro', 'error');
        setTimeout(() => {
          window.location.href = '../index-funcionario.html';
        }, 1500);
        return;
      }

      document.getElementById('header').innerHTML = createFuncionarioHeader(PAGE_TITLE);
      document.getElementById('menu').innerHTML = createFuncionarioMenu();
      document.getElementById('mobileNav').innerHTML = createMobileNav(PAGE_ACTIVE);

      await loadUserInfo();

      await loadBalanceCards();
      await loadMovimentacoes();
    });

    // SWITCH TAB
    async function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });

      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
      });
      document.getElementById(`tab-${tab}`).classList.add('active');

      currentTab = tab;

      switch(tab) {
        case 'movimentacoes':
          await loadMovimentacoes();
          break;
        case 'caixa':
          await loadCaixa();
          break;
        case 'comissoes':
          await loadMinhasComissoes();
          break;
        case 'pendencias':
          await loadPendencias();
          break;
      }
    }

    // LOAD BALANCE CARDS
    async function loadBalanceCards() {
      const container = document.getElementById('balanceCards');

      try {
        const response = await window.api.getResumoDia();
        const resumo = response || {};

        const totalRecebido = resumo.faturamentoDia || 0;
        const totalSaidas = resumo.totalSaidas || 0;
        const pendentes = resumo.pending || 0;

        container.innerHTML = `
          <div class="balance-card green">
            <div class="balance-label">Total Recebido</div>
            <div class="balance-value">${formatCurrency(totalRecebido)}</div>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
              üí∞ ${formatCurrency(resumo.totalDinheiro || 0)} | üí≥ ${formatCurrency(resumo.totalCartao || 0)} | üì± ${formatCurrency(resumo.totalPix || 0)}
            </div>
          </div>
          <div class="balance-card red">
            <div class="balance-label">Total de Sa√≠das</div>
            <div class="balance-value">${formatCurrency(totalSaidas)}</div>
          </div>
          <div class="balance-card orange">
            <div class="balance-label">Pend√™ncias</div>
            <div class="balance-value">${formatCurrency(pendentes)}</div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao carregar balan√ßo:', error);
        container.innerHTML = '<div class="empty-state"><p>Erro ao carregar balan√ßo</p></div>';
      }
    }

    // LOAD MOVIMENTA√á√ïES
    async function loadMovimentacoes() {
      const container = document.getElementById('tab-movimentacoes');

      try {
        container.innerHTML = createLoading();

        const response = await window.api.getHistoricoCaixa({
          dataInicio: filters.dataInicio,
          dataFim: filters.dataFim,
          tipo: filters.tipo
        });

        const movimentacoes = response.historico || [];

        let filterHtml = `
          <div class="filters">
            <input type="date" class="filter-input" id="dataInicio" value="${filters.dataInicio}" onchange="updateDateFilter()">
            <input type="date" class="filter-input" id="dataFim" value="${filters.dataFim}" onchange="updateDateFilter()">
            <select class="filter-select" id="tipoFilter" onchange="updateTipoFilter()">
              <option value="">Todos os tipos</option>
              <option value="entrada">Entrada</option>
              <option value="saida">Sa√≠da</option>
            </select>
          </div>
          <div class="preset-buttons">
            <button class="preset-btn ${filters.preset === 'today' ? 'active' : ''}" onclick="applyPreset('today')">Hoje</button>
            <button class="preset-btn ${filters.preset === 'week' ? 'active' : ''}" onclick="applyPreset('week')">Esta Semana</button>
            <button class="preset-btn ${filters.preset === 'month' ? 'active' : ''}" onclick="applyPreset('month')">Este M√™s</button>
          </div>
        `;

        if (movimentacoes.length === 0) {
          container.innerHTML = filterHtml + createEmptyState(
            'fa-inbox',
            'Nenhuma movimenta√ß√£o',
            'N√£o h√° movimenta√ß√µes neste per√≠odo.'
          );
          return;
        }

        let html = filterHtml + `
          <div class="table-container">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                  </tr>
                </thead>
                <tbody>
        `;

        movimentacoes.forEach(mov => {
          const tipoLabel = mov.tipo === 'entrada' ? 'Entrada' : 'Sa√≠da';
          const tipoClass = mov.tipo === 'entrada' ? 'status-completo' : 'status-pendente';
          html += `
            <tr>
              <td>${formatDate(mov.data)}</td>
              <td>${mov.descricao || '-'}</td>
              <td><span class="status-badge ${tipoClass}">${tipoLabel}</span></td>
              <td>${formatCurrency(mov.valor)}</td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        container.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar movimenta√ß√µes:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar as movimenta√ß√µes.',
          'Tentar novamente',
          'loadMovimentacoes()'
        );
      }
    }

    // LOAD CONTROLE DE CAIXA
    async function loadCaixa() {
      const container = document.getElementById('tab-caixa');

      try {
        container.innerHTML = `
          <div class="action-buttons">
            <button class="action-btn" onclick="openTransactionModal('despesa')">
              <i class="fas fa-receipt"></i>
              <span>Lan√ßar Despesa</span>
            </button>
            <button class="action-btn" onclick="openTransactionModal('sangria')">
              <i class="fas fa-money-bill"></i>
              <span>Sangria</span>
            </button>
            <button class="action-btn" onclick="openTransactionModal('suprimento')">
              <i class="fas fa-plus-circle"></i>
              <span>Suprimento</span>
            </button>
            <button class="action-btn" onclick="closeCashRegister()">
              <i class="fas fa-check-circle"></i>
              <span>Fechar Caixa</span>
            </button>
          </div>
          <div id="caixaHistory"></div>
        `;

        const response = await window.api.getHistoricoCaixa({
          dataInicio: new Date().toISOString().split('T')[0],
          dataFim: new Date().toISOString().split('T')[0],
          tipo: ''
        });

        const movimentacoes = response.historico || [];
        let historyHtml = '';

        if (movimentacoes.length > 0) {
          historyHtml = `
            <h3 style="margin-bottom: 16px;">Movimenta√ß√µes de Hoje</h3>
            <div class="table-container">
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>Hora</th>
                      <th>Descri√ß√£o</th>
                      <th>Tipo</th>
                      <th>Valor</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          movimentacoes.forEach(mov => {
            const tipoLabel = mov.tipo === 'entrada' ? 'Entrada' : 'Sa√≠da';
            const tipoClass = mov.tipo === 'entrada' ? 'status-completo' : 'status-pendente';
            const time = new Date(mov.data).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            historyHtml += `
              <tr>
                <td>${time}</td>
                <td>${mov.descricao || '-'}</td>
                <td><span class="status-badge ${tipoClass}">${tipoLabel}</span></td>
                <td>${formatCurrency(mov.valor)}</td>
              </tr>
            `;
          });

          historyHtml += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        document.getElementById('caixaHistory').innerHTML = historyHtml;
      } catch (error) {
        console.error('Erro ao carregar controle de caixa:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar o controle de caixa.',
          'Tentar novamente',
          'loadCaixa()'
        );
      }
    }

    // LOAD MINHAS COMISS√ïES
    async function loadMinhasComissoes() {
      const container = document.getElementById('tab-comissoes');

      try {
        container.innerHTML = createLoading();

        // Get current user's lavador data
        const lavador = await getUserLavador();
        if (!lavador) {
          container.innerHTML = createEmptyState(
            'fa-user-slash',
            'Perfil n√£o encontrado',
            'Seu perfil de funcion√°rio n√£o foi encontrado no sistema.'
          );
          return;
        }

        // Get commission data
        const dataInicio = new Date();
        dataInicio.setDate(dataInicio.getDate() - 30); // Last 30 days
        const dataInicioStr = dataInicio.toISOString().split('T')[0];
        const dataFimStr = new Date().toISOString().split('T')[0];

        const response = await window.api.getDadosComissao({
          lavadorId: lavador.id,
          dataInicio: dataInicioStr,
          dataFim: dataFimStr
        });

        const comissoes = response.comissoes || [];
        const adiantamentos = response.adiantamentos || [];
        const debitosOS = response.debitosOS || [];

        let html = `
          <div class="comissoes-filters">
            <div>
              <label>Data In√≠cio</label>
              <input type="date" id="comissaoDataInicio" value="${dataInicioStr}" onchange="reloadComissoes()">
            </div>
            <div>
              <label>Data Fim</label>
              <input type="date" id="comissaoDataFim" value="${dataFimStr}" onchange="reloadComissoes()">
            </div>
          </div>

          <div class="comissoes-grid">
            <!-- CR√âDITOS -->
            <div class="comissoes-column">
              <div class="comissoes-header">
                <div class="comissoes-icon creditos">
                  <i class="fas fa-plus"></i>
                </div>
                <h3>Cr√©ditos</h3>
                <span class="comissoes-badge" id="creditsBadge">${comissoes.filter(c => hasWasherInOrder(c, lavador.id)).length}</span>
              </div>
              <div id="creditos-list">
                ${renderComissoesList(comissoes, lavador.id)}
              </div>
            </div>

            <!-- D√âBITOS -->
            <div class="comissoes-column">
              <div class="comissoes-header">
                <div class="comissoes-icon debitos">
                  <i class="fas fa-minus"></i>
                </div>
                <h3>D√©bitos</h3>
                <span class="comissoes-badge" id="debitsBadge">${adiantamentos.length + debitosOS.filter(d => hasWasherInOrder(d, lavador.id)).length}</span>
              </div>
              <div id="debitos-list">
                ${renderDebitosList(adiantamentos, debitosOS, lavador.id)}
              </div>
            </div>
          </div>

          <!-- RESUMO -->
          <div class="comissoes-summary">
            <div class="comissoes-summary-row">
              <span class="comissoes-summary-label">Total de Comiss√µes</span>
              <span class="comissoes-summary-value" id="summary-creditos">${formatCurrency(calculateTotalComissoes(comissoes, lavador.id))}</span>
            </div>
            <div class="comissoes-summary-row">
              <span class="comissoes-summary-label">Total de D√©bitos</span>
              <span class="comissoes-summary-value" id="summary-debitos">- ${formatCurrency(calculateTotalDebitos(adiantamentos, debitosOS, lavador.id))}</span>
            </div>
            <div class="comissoes-summary-row">
              <span class="comissoes-summary-label">Saldo Estimado</span>
              <span class="comissoes-summary-total" id="summary-total">${formatCurrency(calculateSaldoComissoes(comissoes, adiantamentos, debitosOS, lavador.id))}</span>
            </div>
          </div>

          <div style="padding: 20px; background: var(--light); border-radius: 8px; text-align: center; color: #666; font-size: 13px;">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            Este √© um resumo das suas comiss√µes. Valores finais sujeitos a confirma√ß√£o administrativa.
          </div>
        `;

        container.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar comiss√µes:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar suas comiss√µes.',
          'Tentar novamente',
          'loadMinhasComissoes()'
        );
      }
    }

    // HELPER FUNCTIONS FOR COMISS√ïES
    function hasWasherInOrder(order, washerId) {
      if (!order) return false;
      if (order.lavadorId === washerId) return true;
      if (Array.isArray(order.lavadores)) {
        return order.lavadores.some(l => (l.id || l.value || l) === washerId);
      }
      return false;
    }

    function getWasherShare(order, washerId) {
      if (!order || !washerId) return 0;

      const washers = [];
      if (Array.isArray(order.lavadores) && order.lavadores.length > 0) {
        washers.push(...order.lavadores.map(lav => ({
          id: lav.id || lav.value || lav,
          nome: lav.nome || lav.name,
          ganho: typeof lav.ganho === 'number' ? lav.ganho : undefined
        })));
      } else if (order.lavadorId) {
        washers.push({ id: order.lavadorId, nome: order.lavador?.nome });
      }

      const existing = washers.find(w => w.id === washerId && typeof w.ganho === 'number');
      if (existing) return existing.ganho;

      if (washers.length === 0) return 0;

      const percent = order?.lavador?.comissao || (order?.comissao && order?.valorTotal ? (order.comissao / order.valorTotal) * 100 : 0);
      const totalCents = Math.round((order?.valorTotal || 0) * (percent / 100) * 100);
      if (totalCents <= 0) return 0;

      const base = Math.floor(totalCents / washers.length);
      let remainder = totalCents % washers.length;

      const shareMap = {};
      washers.forEach(washer => {
        let cents = base;
        if (remainder > 0) {
          cents += 1;
          remainder -= 1;
        }
        shareMap[washer.id] = cents / 100;
      });

      return shareMap[washerId] || 0;
    }

    function renderComissoesList(comissoes, washerId) {
      const items = (comissoes || []).map(c => {
        const share = getWasherShare(c, washerId);
        if (!share || share <= 0) return null;
        return `
          <div class="comissoes-item">
            <div class="comissoes-item-details">
              <div class="comissoes-item-title">OS #${c.numeroOrdem} - ${c.veiculo?.modelo || 'Sem Modelo'}</div>
              <div class="comissoes-item-subtitle">Finalizada em: ${new Date(c.dataFim).toLocaleDateString('pt-BR')}</div>
            </div>
            <span class="comissoes-item-value credito">${formatCurrency(share)}</span>
          </div>
        `;
      }).filter(Boolean);

      return items.length > 0
        ? items.join('')
        : '<div style="padding: 20px; text-align: center; color: #999;"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>Nenhuma comiss√£o no per√≠odo.</div>';
    }

    function renderDebitosList(adiantamentos, debitosOS, washerId) {
      const adiantamentoItems = (adiantamentos || []).map(a => `
        <div class="comissoes-item">
          <div class="comissoes-item-details">
            <div class="comissoes-item-title">${a.descricao || 'Adiantamento (Vale)'}</div>
            <div class="comissoes-item-subtitle">Data: ${a.data ? new Date(a.data).toLocaleDateString('pt-BR') : 'Sem data'}</div>
          </div>
          <span class="comissoes-item-value debito">${formatCurrency(a.valor)}</span>
        </div>
      `);

      const debitoItems = (debitosOS || []).map(d => {
        const share = getWasherShare(d, washerId);
        if (!share || share <= 0) return null;
        return `
          <div class="comissoes-item">
            <div class="comissoes-item-details">
              <div class="comissoes-item-title">D√©bito OS #${d.numeroOrdem} (${d.veiculo?.placa || 'S/ Placa'})</div>
              <div class="comissoes-item-subtitle">Finalizada em: ${new Date(d.dataFim).toLocaleDateString('pt-BR')}</div>
            </div>
            <span class="comissoes-item-value debito">${formatCurrency(share)}</span>
          </div>
        `;
      }).filter(Boolean);

      const allItems = [...adiantamentoItems, ...debitoItems];
      return allItems.length > 0
        ? allItems.join('')
        : '<div style="padding: 20px; text-align: center; color: #999;"><i class="fas fa-thumbs-up" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>Nenhum d√©bito no per√≠odo.</div>';
    }

    function calculateTotalComissoes(comissoes, washerId) {
      return (comissoes || []).reduce((total, c) => total + getWasherShare(c, washerId), 0);
    }

    function calculateTotalDebitos(adiantamentos, debitosOS, washerId) {
      const adiantamentoTotal = (adiantamentos || []).reduce((total, a) => total + a.valor, 0);
      const debitoOsTotal = (debitosOS || []).reduce((total, d) => total + getWasherShare(d, washerId), 0);
      return adiantamentoTotal + debitoOsTotal;
    }

    function calculateSaldoComissoes(comissoes, adiantamentos, debitosOS, washerId) {
      const creditos = calculateTotalComissoes(comissoes, washerId);
      const debitos = calculateTotalDebitos(adiantamentos, debitosOS, washerId);
      return creditos - debitos;
    }

    async function reloadComissoes() {
      const dataInicio = document.getElementById('comissaoDataInicio')?.value || new Date().toISOString().split('T')[0];
      const dataFim = document.getElementById('comissaoDataFim')?.value || new Date().toISOString().split('T')[0];

      const container = document.getElementById('tab-comissoes');
      container.innerHTML = createLoading();

      try {
        const lavador = await getUserLavador();
        if (!lavador) {
          container.innerHTML = createEmptyState('fa-user-slash', 'Perfil n√£o encontrado', 'Seu perfil de funcion√°rio n√£o foi encontrado.');
          return;
        }

        const response = await window.api.getDadosComissao({
          lavadorId: lavador.id,
          dataInicio,
          dataFim
        });

        // Reload the entire aba
        await loadMinhasComissoes();
      } catch (error) {
        console.error('Erro ao recarregar comiss√µes:', error);
        container.innerHTML = createEmptyState('fa-exclamation-triangle', 'Erro ao carregar', 'Houve um erro ao carregar suas comiss√µes.', 'Tentar novamente', 'reloadComissoes()');
      }
    }

    // LOAD PEND√äNCIAS
    async function loadPendencias() {
      const container = document.getElementById('tab-pendencias');

      try {
        container.innerHTML = createLoading();

        const response = await window.api.getOrdens(1, 100, '', 'AGUARDANDO_PAGAMENTO');
        const ordens = response.data || response.ordens || [];

        if (ordens.length === 0) {
          container.innerHTML = createEmptyState(
            'fa-check-circle',
            'Sem pend√™ncias',
            'N√£o h√° ordens aguardando pagamento.'
          );
          return;
        }

        let html = `
          <div class="table-container">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Ve√≠culo</th>
                    <th>Valor</th>
                    <th>Data</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
        `;

        ordens.forEach(ordem => {
          html += `
            <tr>
              <td>#${ordem.numeroOrdem || ordem.id.substring(0, 8)}</td>
              <td>${ordem.cliente?.nome || '-'}</td>
              <td>${ordem.veiculo?.placa || '-'}</td>
              <td>${formatCurrency(ordem.valorTotal || ordem.valor)}</td>
              <td>${formatDate(ordem.createdAt)}</td>
              <td><span class="status-badge status-pendente">AGUARDANDO</span></td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        container.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar pend√™ncias:', error);
        container.innerHTML = createEmptyState(
          'fa-exclamation-triangle',
          'Erro ao carregar',
          'Houve um erro ao carregar as pend√™ncias.',
          'Tentar novamente',
          'loadPendencias()'
        );
      }
    }

    // TRANSACTION MODAL
    function openTransactionModal(type) {
      currentTransactionType = type;
      const modal = document.getElementById('transactionModal');
      const title = document.getElementById('modalTitle');
      const fornecedorGroup = document.getElementById('fornecedorGroup');

      let titleText = '';
      switch(type) {
        case 'despesa':
          titleText = 'Lan√ßar Despesa';
          fornecedorGroup.style.display = 'block';
          break;
        case 'sangria':
          titleText = 'Sangria';
          fornecedorGroup.style.display = 'none';
          break;
        case 'suprimento':
          titleText = 'Suprimento';
          fornecedorGroup.style.display = 'none';
          break;
      }

      title.textContent = titleText;
      document.getElementById('transactionType').value = type;

      document.getElementById('transactionForm').reset();
      modal.classList.add('active');
    }

    function closeTransactionModal() {
      document.getElementById('transactionModal').classList.remove('active');
      document.getElementById('transactionForm').reset();
    }

    async function submitTransaction(event) {
      event.preventDefault();

      const description = document.getElementById('transactionDescription').value;
      const value = parseFloat(document.getElementById('transactionValue').value);
      const type = document.getElementById('transactionType').value;
      const formaPagamento = document.getElementById('transactionFormaPagamento').value;
      const fornecedor = document.getElementById('transactionFornecedor').value;

      if (!description || !value || !formaPagamento) {
        showToast('Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      try {
        const transactionData = {
          descricao: description,
          valor: value,
          tipo: type,
          formaPagamento: formaPagamento,
          fornecedorNome: fornecedor || undefined
        };

        await window.api.createSaida(transactionData);

        showToast('Transa√ß√£o lan√ßada com sucesso!', 'success');
        closeTransactionModal();
        await loadBalanceCards();
        await loadCaixa();
      } catch (error) {
        console.error('Erro ao lan√ßar transa√ß√£o:', error);
        showToast('Erro ao lan√ßar transa√ß√£o', 'error');
      }
    }

    async function closeCashRegister() {
      showConfirm(
        'Fechar Caixa',
        'Tem certeza que deseja fechar o caixa? Esta a√ß√£o n√£o pode ser desfeita.',
        async () => {
          try {
            const resumo = await window.api.getResumoDia();
            await window.api.createFechamento(resumo);
            showToast('Caixa fechado com sucesso!', 'success');
            await loadBalanceCards();
            await loadCaixa();
          } catch (error) {
            console.error('Erro ao fechar caixa:', error);
            showToast('Erro ao fechar caixa', 'error');
          }
        }
      );
    }

    // FILTER FUNCTIONS
    function updateDateFilter() {
      filters.dataInicio = document.getElementById('dataInicio').value;
      filters.dataFim = document.getElementById('dataFim').value;
      filters.preset = '';
      loadMovimentacoes();
    }

    function updateTipoFilter() {
      filters.tipo = document.getElementById('tipoFilter').value;
      loadMovimentacoes();
    }

    function applyPreset(preset) {
      const dates = getDatePreset(preset);
      filters.dataInicio = dates.dataInicio;
      filters.dataFim = dates.dataFim;
      filters.preset = preset;

      const dataInicioInput = document.getElementById('dataInicio');
      const dataFimInput = document.getElementById('dataFim');
      if (dataInicioInput) dataInicioInput.value = dates.dataInicio;
      if (dataFimInput) dataFimInput.value = dates.dataFim;

      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.innerText.toLowerCase().includes(preset));
      });

      loadMovimentacoes();
    }
  </script>
</body>
</html>
