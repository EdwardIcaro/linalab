<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinaX - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="webapp-mobile.css">
    <link rel="stylesheet" href="fix-responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==========================================
           CSS VARIABLES - Windows 11 Inspired Theme
           ========================================== */
        :root {
            --dashboard-bg: #f3f3f3;
            --dashboard-card: #ffffff;
            --dashboard-card-hover: #fafafa;
            --dashboard-border: rgba(0, 0, 0, 0.05);
            --dashboard-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            --dashboard-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.08);
            --dashboard-text: #1a1a1a;
            --dashboard-text-secondary: #5c5c5c;
            --dashboard-text-muted: #8c8c8c;

            /* Accent Colors */
            --accent-green: #10b981;
            --accent-green-light: rgba(16, 185, 129, 0.1);
            --accent-blue: #3b82f6;
            --accent-blue-light: rgba(59, 130, 246, 0.1);
            --accent-purple: #8b5cf6;
            --accent-purple-light: rgba(139, 92, 246, 0.1);
            --accent-orange: #f59e0b;
            --accent-orange-light: rgba(245, 158, 11, 0.1);
            --accent-cyan: #06b6d4;
            --accent-cyan-light: rgba(6, 182, 212, 0.1);

            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-blur: blur(20px);

            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        /* Dark mode support */
        [data-theme="dark"] {
            --dashboard-bg: #1a1a1a;
            --dashboard-card: #2d2d2d;
            --dashboard-card-hover: #333333;
            --dashboard-border: rgba(255, 255, 255, 0.05);
            --dashboard-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            --dashboard-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.3);
            --dashboard-text: #ffffff;
            --dashboard-text-secondary: #a0a0a0;
            --dashboard-text-muted: #6c6c6c;
            --glass-bg: rgba(45, 45, 45, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* Alpine.js cloak */
        [x-cloak] { display: none !important; }

        /* ==========================================
           DASHBOARD LAYOUT
           ========================================== */
        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ==========================================
           HERO HEADER
           ========================================== */
        .dashboard-hero {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            gap: 24px;
            flex-wrap: wrap;
        }

        .hero-greeting {
            flex: 1;
            min-width: 280px;
        }

        .hero-greeting .company-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--accent-cyan-light);
            color: var(--accent-cyan);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .hero-greeting h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--dashboard-text);
            margin-bottom: 4px;
        }

        .hero-greeting p {
            color: var(--dashboard-text-secondary);
            font-size: 15px;
        }

        .hero-datetime {
            text-align: right;
            min-width: 180px;
        }

        .hero-time {
            font-size: 36px;
            font-weight: 700;
            color: var(--dashboard-text);
            line-height: 1;
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
        }

        .hero-date {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            font-size: 14px;
            color: var(--dashboard-text-secondary);
        }

        .hero-date i {
            color: var(--accent-cyan);
        }

        /* ==========================================
           KPI CARDS GRID
           ========================================== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }

        .kpi-card {
            background: var(--dashboard-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--dashboard-border);
            box-shadow: var(--dashboard-shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--dashboard-shadow-hover);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .kpi-card.green::before { background: var(--accent-green); }
        .kpi-card.blue::before { background: var(--accent-blue); }
        .kpi-card.purple::before { background: var(--accent-purple); }
        .kpi-card.orange::before { background: var(--accent-orange); }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .kpi-card.green .kpi-icon { background: var(--accent-green-light); color: var(--accent-green); }
        .kpi-card.blue .kpi-icon { background: var(--accent-blue-light); color: var(--accent-blue); }
        .kpi-card.purple .kpi-icon { background: var(--accent-purple-light); color: var(--accent-purple); }
        .kpi-card.orange .kpi-icon { background: var(--accent-orange-light); color: var(--accent-orange); }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .kpi-trend.up {
            background: var(--accent-green-light);
            color: var(--accent-green);
        }

        .kpi-trend.down {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .kpi-label {
            font-size: 13px;
            color: var(--dashboard-text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dashboard-text);
            line-height: 1.1;
        }

        .kpi-subtext {
            font-size: 12px;
            color: var(--dashboard-text-muted);
            margin-top: 8px;
        }

        /* Skeleton for KPI */
        .kpi-skeleton {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            background: linear-gradient(90deg, var(--dashboard-border) 25%, transparent 50%, var(--dashboard-border) 75%);
            background-size: 200% 100%;
            border-radius: 6px;
        }

        @keyframes skeleton-pulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ==========================================
           MAIN CONTENT GRID
           ========================================== */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
        }

        @media (max-width: 1100px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ==========================================
           CHART SECTION
           ========================================== */
        .chart-card {
            background: var(--dashboard-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--dashboard-border);
            box-shadow: var(--dashboard-shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--accent-cyan-light);
            color: var(--accent-cyan);
        }

        .card-title h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dashboard-text);
        }

        .card-title p {
            font-size: 12px;
            color: var(--dashboard-text-muted);
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        /* ==========================================
           SIDEBAR (Quick Actions + Recent)
           ========================================== */
        .sidebar-stack {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Quick Actions */
        .quick-actions-card {
            background: var(--dashboard-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--dashboard-border);
            box-shadow: var(--dashboard-shadow);
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px 16px;
            background: var(--dashboard-card);
            border: 2px solid var(--dashboard-border);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--dashboard-text);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .action-btn:hover {
            border-color: var(--accent-cyan);
            background: var(--accent-cyan-light);
            transform: translateY(-2px);
        }

        .action-btn i {
            font-size: 24px;
            color: var(--accent-cyan);
        }

        .action-btn span {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent-cyan) 0%, #0891b2 100%);
            border-color: transparent;
            color: white;
            grid-column: 1 / -1;
            flex-direction: row;
            padding: 16px 24px;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
            background: linear-gradient(135deg, #0891b2 0%, var(--accent-cyan) 100%);
        }

        .action-btn.primary i {
            color: white;
            font-size: 20px;
        }

        .action-btn.primary span {
            font-size: 14px;
        }

        /* Recent Orders */
        .recent-card {
            background: var(--dashboard-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--dashboard-border);
            box-shadow: var(--dashboard-shadow);
            flex: 1;
        }

        .recent-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--dashboard-bg);
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .recent-item:hover {
            background: var(--dashboard-card-hover);
            transform: translateX(4px);
        }

        .recent-status {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .recent-status.completed { background: var(--accent-green-light); color: var(--accent-green); }
        .recent-status.progress { background: var(--accent-orange-light); color: var(--accent-orange); }
        .recent-status.pending { background: var(--accent-blue-light); color: var(--accent-blue); }

        .recent-info {
            flex: 1;
            min-width: 0;
        }

        .recent-info .plate {
            font-weight: 600;
            font-size: 13px;
            color: var(--dashboard-text);
        }

        .recent-info .service {
            font-size: 11px;
            color: var(--dashboard-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-value {
            text-align: right;
        }

        .recent-value .price {
            font-weight: 600;
            font-size: 13px;
            color: var(--accent-green);
        }

        .recent-value .time {
            font-size: 11px;
            color: var(--dashboard-text-muted);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 32px 16px;
            color: var(--dashboard-text-muted);
        }

        .empty-state i {
            font-size: 40px;
            opacity: 0.3;
            margin-bottom: 12px;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* Skeleton for list items */
        .recent-skeleton {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--dashboard-bg);
            border-radius: var(--radius-md);
        }

        .skeleton-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .skeleton-line {
            height: 12px;
            border-radius: 6px;
        }

        .skeleton-line.w-full { width: 100%; }
        .skeleton-line.w-3\/4 { width: 75%; }
        .skeleton-line.w-1\/2 { width: 50%; }

        /* ==========================================
           NOTIFICATIONS (keeping existing styles)
           ========================================== */
        .notification-list {
            padding: 0 8px 8px 8px;
        }

        .notification-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background-color: var(--dashboard-bg);
        }

        .notification-item.unread {
            background-color: var(--accent-cyan-light);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--accent-cyan);
        }

        .notification-icon {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .notification-icon.ordemCriada { background-color: #D1FAE5; color: #065F46; }
        .notification-icon.ordemEditada { background-color: #DBEAFE; color: #1E40AF; }
        .notification-icon.finalizacaoAutomatica { background-color: #FEF3C7; color: #92400E; }
        .notification-icon.ordemDeletada { background-color: #FEE2E2; color: #991B1B; }
        .notification-icon.info { background-color: #E5E7EB; color: #4B5563; }

        .notification-content p {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        /* View All Link */
        .view-all-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 12px;
            margin-top: 8px;
            color: var(--accent-cyan);
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .view-all-link:hover {
            background: var(--accent-cyan-light);
        }

        /* ==========================================
           RESPONSIVE ADJUSTMENTS
           ========================================== */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .dashboard-hero {
                flex-direction: column;
            }

            .hero-datetime {
                text-align: left;
            }

            .hero-date {
                justify-content: flex-start;
            }

            .hero-greeting h1 {
                font-size: 22px;
            }

            .kpi-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body data-permission="ver_dashboard">
    <!-- Modal de Bloqueio de Tela (Acesso Negado) -->
    <div id="screenLockModal" class="screen-lock-overlay">
        <div class="screen-lock-content">
            <i class="fas fa-lock screen-lock-icon"></i>
            <h2>Acesso Negado</h2>
            <p>Voce nao tem permissao para visualizar esta pagina. Redirecionando...</p>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <main class="main-content" x-data="dashboard()" x-init="init()" x-cloak>
        <div class="dashboard-container">
            <!-- Hero Header -->
            <div class="dashboard-hero">
                <div class="hero-greeting">
                    <div class="company-badge" x-show="companyName">
                        <i class="fas fa-building"></i>
                        <span x-text="companyName"></span>
                    </div>
                    <h1>
                        <span x-text="getGreeting()"></span>, <span x-text="userName || 'Usuario'"></span>!
                    </h1>
                    <p>Acompanhe os principais indicadores da sua operacao hoje.</p>
                </div>
                <div class="hero-datetime">
                    <div class="hero-time" x-text="currentTime">--:--</div>
                    <div class="hero-date">
                        <i class="fas fa-calendar-day"></i>
                        <span x-text="currentDate"></span>
                    </div>
                    <!-- Logout Button -->
                    <button
                        onclick="logout()"
                        class="btn-secondary"
                        style="margin-top: 12px; display: flex; align-items: center; gap: 8px;"
                        title="Sair do sistema"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </button>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="nav-menu-card">
                <!-- Quick Access Section -->
                <div class="nav-menu-quick-access">
                    <a href="index.html" class="quick-access-btn" title="Dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="ordens.html" class="quick-access-btn" title="Ordens">
                        <i class="fas fa-list-check"></i>
                        <span>Ordens</span>
                    </a>
                    <a href="clientes.html" class="quick-access-btn" title="Clientes">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="financeiro.html" class="quick-access-btn" title="Financeiro">
                        <i class="fas fa-chart-pie"></i>
                        <span>Financeiro</span>
                    </a>
                    <a href="configuracoes.html" class="quick-access-btn" title="Configura√ß√µes">
                        <i class="fas fa-cog"></i>
                        <span>Config</span>
                    </a>
                    <a href="perfil.html" class="quick-access-btn" title="Meu Perfil">
                        <i class="fas fa-user-circle"></i>
                        <span>Perfil</span>
                    </a>
                </div>

                <div class="nav-menu-links">
                    <a href="index.html" class="nav-menu-item active" data-permission="ver_dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="ordens.html" class="nav-menu-item" data-permission="gerenciar_ordens">
                        <i class="fas fa-list-alt"></i>
                        <span>Ordens</span>
                    </a>
                    <a href="novaordem.html" class="nav-menu-item" data-permission="gerenciar_ordens">
                        <i class="fas fa-plus-circle"></i>
                        <span>Nova Ordem</span>
                    </a>
                    <a href="clientes.html" class="nav-menu-item" data-permission="gerenciar_clientes">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="funcionarios.html" class="nav-menu-item" data-permission="gerenciar_funcionarios">
                        <i class="fas fa-user-tie"></i>
                        <span>Funcion√°rios</span>
                    </a>
                    <a href="financeiro.html" class="nav-menu-item" data-permission="ver_financeiro">
                        <i class="fas fa-chart-pie"></i>
                        <span>Financeiro</span>
                    </a>
                    <a href="configuracoes.html" class="nav-menu-item" data-permission="gerenciar_configuracoes">
                        <i class="fas fa-cog"></i>
                        <span>Configura√ß√µes</span>
                    </a>
                </div>
                <div class="nav-menu-actions">
                    <!-- Notification Bell -->
                    <div class="notification-wrapper">
                        <button id="notification-bell" class="icon-btn" title="Notifica√ß√µes">
                            <i class="fas fa-bell"></i>
                            <span id="notification-dot" class="notification-dot"></span>
                        </button>
                        <div id="notification-panel" class="notification-panel">
                            <div class="notification-panel-header">
                                <h4>Notifica√ß√µes</h4>
                                <button id="mark-all-read-btn" class="btn-link" style="font-size: 12px;">Marcar todas como lidas</button>
                            </div>
                            <div id="notification-list" class="notification-list">
                                <div class="empty-state">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>Nenhuma notifica√ß√£o</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Profile -->
                    <a href="perfil.html" class="nav-user-profile">
                        <div class="nav-user-avatar" x-text="getUserInitials()"></div>
                        <div class="nav-user-info">
                            <span class="nav-user-name" x-text="getUserName()"></span>
                            <span class="nav-user-role" x-text="getUserRole()"></span>
                        </div>
                    </a>

                    <!-- Logout Button -->
                    <button class="nav-logout-btn" @click="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </button>
                </div>
            </nav>

            <!-- KPI Cards Grid -->
            <section class="kpi-grid">
                <!-- Revenue Card -->
                <div class="kpi-card green">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="kpi-trend up" x-show="!isLoading && stats.revenue > 0">
                            <i class="fas fa-arrow-up"></i>
                            <span>Hoje</span>
                        </div>
                    </div>
                    <div class="kpi-label">Faturamento Hoje</div>
                    <template x-if="isLoading">
                        <div class="kpi-skeleton" style="height: 38px; width: 120px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="kpi-value" x-text="formatCurrency(stats.revenue)"></div>
                    </template>
                    <div class="kpi-subtext">Ordens finalizadas e pagas</div>
                </div>

                <!-- Vehicles Washed Card -->
                <div class="kpi-card blue">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-car"></i>
                        </div>
                    </div>
                    <div class="kpi-label">Veiculos Lavados</div>
                    <template x-if="isLoading">
                        <div class="kpi-skeleton" style="height: 38px; width: 60px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="kpi-value" x-text="stats.completed"></div>
                    </template>
                    <div class="kpi-subtext">Finalizados hoje</div>
                </div>

                <!-- Average Ticket Card -->
                <div class="kpi-card purple">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="kpi-label">Ticket Medio</div>
                    <template x-if="isLoading">
                        <div class="kpi-skeleton" style="height: 38px; width: 80px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="kpi-value" x-text="formatCurrency(stats.averageTicket)"></div>
                    </template>
                    <div class="kpi-subtext">Por veiculo</div>
                </div>

                <!-- In Progress Card -->
                <div class="kpi-card orange">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="kpi-trend up" x-show="!isLoading && stats.inProgress > 0" style="background: var(--accent-orange-light); color: var(--accent-orange);">
                            <i class="fas fa-sync-alt"></i>
                            <span>Ativo</span>
                        </div>
                    </div>
                    <div class="kpi-label">Em Andamento</div>
                    <template x-if="isLoading">
                        <div class="kpi-skeleton" style="height: 38px; width: 40px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="kpi-value" x-text="stats.inProgress"></div>
                    </template>
                    <div class="kpi-subtext">Aguardando conclusao</div>
                </div>
            </section>

            <!-- Main Content Grid -->
            <section class="content-grid">
                <!-- Chart Section -->
                <div class="chart-card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon">
                                <i class="fas fa-chart-area"></i>
                            </div>
                            <div>
                                <h3>Veiculos por Hora</h3>
                                <p>Distribuicao de atendimentos hoje</p>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="vehiclesChart" x-ref="chartCanvas"></canvas>
                    </div>
                </div>

                <!-- Sidebar Stack -->
                <div class="sidebar-stack">
                    <!-- Quick Actions -->
                    <div class="quick-actions-card">
                        <div class="card-header" style="margin-bottom: 16px;">
                            <div class="card-title">
                                <div class="card-title-icon" style="background: var(--accent-purple-light); color: var(--accent-purple);">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div>
                                    <h3>Acoes Rapidas</h3>
                                    <p>Acesso direto</p>
                                </div>
                            </div>
                        </div>
                        <div class="quick-actions-grid">
                            <a href="novaordem.html" class="action-btn primary" data-permission="gerenciar_ordens">
                                <i class="fas fa-plus-circle"></i>
                                <span>Nova Ordem</span>
                            </a>
                            <a href="clientes.html" class="action-btn" data-permission="gerenciar_clientes">
                                <i class="fas fa-user-plus"></i>
                                <span>Novo Cliente</span>
                            </a>
                            <a href="comissoes.html" class="action-btn" data-permission="ver_financeiro">
                                <i class="fas fa-hand-holding-usd"></i>
                                <span>Comissoes</span>
                            </a>
                            <a href="financeiro.html" class="action-btn" data-permission="ver_financeiro">
                                <i class="fas fa-cash-register"></i>
                                <span>Fechar Caixa</span>
                            </a>
                            <a href="ordens.html" class="action-btn" data-permission="gerenciar_ordens">
                                <i class="fas fa-list-check"></i>
                                <span>Ver Ordens</span>
                            </a>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="recent-card">
                        <div class="card-header">
                            <div class="card-title">
                                <div class="card-title-icon" style="background: var(--accent-green-light); color: var(--accent-green);">
                                    <i class="fas fa-clock-rotate-left"></i>
                                </div>
                                <div>
                                    <h3>Atividade Recente</h3>
                                    <p>Ultimas 5 ordens</p>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div class="recent-list" x-show="isLoadingRecent">
                            <template x-for="i in 3" :key="'skel-' + i">
                                <div class="recent-skeleton">
                                    <div class="skeleton-circle kpi-skeleton"></div>
                                    <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
                                        <div class="skeleton-line w-3/4 kpi-skeleton"></div>
                                        <div class="skeleton-line w-1/2 kpi-skeleton"></div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Recent List -->
                        <div class="recent-list" x-show="!isLoadingRecent">
                            <template x-if="recentOrders.length === 0">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhuma ordem hoje ainda</p>
                                </div>
                            </template>

                            <template x-for="order in recentOrders" :key="order.id">
                                <div class="recent-item">
                                    <div class="recent-status" :class="getStatusClass(order.status)">
                                        <i :class="getStatusIcon(order.status)"></i>
                                    </div>
                                    <div class="recent-info">
                                        <div class="plate" x-text="order.veiculo?.placa || 'S/ Placa'"></div>
                                        <div class="service" x-text="getMainService(order)"></div>
                                    </div>
                                    <div class="recent-value">
                                        <div class="price" x-text="formatCurrency(order.valorTotal)"></div>
                                        <div class="time" x-text="formatTime(order.createdAt)"></div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <a href="ordens.html" class="view-all-link" x-show="recentOrders.length > 0">
                            <span>Ver todas as ordens</span>
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Confirm Modal -->
    <div id="customConfirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center;">
                <h2 id="customConfirmTitle" class="modal-title"></h2>
            </div>
            <p id="customConfirmMessage" class="text-secondary mb-6"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button id="customCancelBtn" class="btn btn-secondary">Cancelar</button>
                <button id="customConfirmBtn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="utils.js"></script>
    <script src="theme.js"></script>

    <script>
        /**
         * ============================================================
         * Alpine.js Component: Dashboard
         * ============================================================
         *
         * The Command Center for car wash owners. Displays real-time KPIs,
         * a vehicles-per-hour chart, and recent activity.
         *
         * ALPINE.JS + CHART.JS INTERACTION:
         * ---------------------------------
         * Chart.js needs a canvas element and must be initialized AFTER
         * the DOM is ready. We use Alpine's init() lifecycle hook which
         * runs after x-init and the component is mounted.
         *
         * Key points:
         * 1. Store chart instance in component state (this.chartInstance)
         * 2. Initialize chart in init() after data is loaded
         * 3. Update chart with chartInstance.update() when data changes
         * 4. Use x-ref="chartCanvas" to get canvas element reference
         *
         * ============================================================
         */
        function dashboard() {
            return {
                // ==========================================
                // STATE
                // ==========================================
                isLoading: true,
                isLoadingRecent: true,

                // User & Company
                userName: '',
                companyName: '',

                // Date/Time
                currentTime: '--:--',
                currentDate: '',
                timeInterval: null,

                // Stats
                stats: {
                    revenue: 0,
                    completed: 0,
                    inProgress: 0,
                    averageTicket: 0
                },

                // Recent Orders
                recentOrders: [],

                // Chart
                chartInstance: null,
                hourlyData: [],

                // ==========================================
                // LIFECYCLE
                // ==========================================
                async init() {
                    try {
                        console.log('[Dashboard] init() starting...');

                        // Check authentication
                        if (!window.api.isAuthenticated()) {
                            console.warn('[Dashboard] ‚ö†Ô∏è Not authenticated - redirecting to login');
                            window.location.href = 'login.html';
                            return;
                        }
                        console.log('[Dashboard] ‚úÖ Authenticated');

                        // Handle initial redirect
                        this.handleInitialRedirect();

                        // Load user info
                        this.loadUserInfo();

                        // Start clock
                        this.updateDateTime();
                        this.timeInterval = setInterval(() => this.updateDateTime(), 1000);

                        // Initialize UI components
                        this.initializeUIComponents();

                        // Load data
                        await Promise.all([
                            this.loadDashboardStats(),
                            this.loadRecentOrders()
                        ]);

                        // Initialize chart after data is ready
                        this.$nextTick(() => {
                            this.initChart();
                        });

                        // Load notifications
                        this.initNotifications();

                        // Refresh data every 60 seconds
                        setInterval(() => {
                            this.loadDashboardStats();
                            this.loadRecentOrders();
                        }, 60000);

                        console.log('[Dashboard] ‚úÖ init() completed successfully');
                    } catch (error) {
                        console.error('[Dashboard] ‚ùå FATAL ERROR in init():', error);
                        console.error('[Dashboard] Error stack:', error.stack);
                        // Don't redirect - just show error and let page continue
                        if (typeof showToast === 'function') {
                            showToast('Erro ao inicializar dashboard. Veja o console.', 'error');
                        }
                    }
                },

                // ==========================================
                // INITIAL REDIRECT
                // ==========================================
                handleInitialRedirect() {
                    console.log('[Redirect] Checking for initial redirect...');

                    if (sessionStorage.getItem('initialRedirectDone')) {
                        console.log('[Redirect] ‚úÖ Already redirected this session - skipping');
                        return;
                    }

                    const defaultPage = localStorage.getItem('paginaInicialPadrao');
                    const currentPage = window.location.pathname.split('/').pop();

                    console.log('[Redirect] Default page:', defaultPage);
                    console.log('[Redirect] Current page:', currentPage);

                    if (defaultPage && defaultPage !== currentPage && defaultPage !== 'index.html') {
                        console.warn('[Redirect] ‚ö†Ô∏è REDIRECTING TO:', defaultPage, '- This may cause top bar to flash!');
                        sessionStorage.setItem('initialRedirectDone', 'true');
                        window.location.href = defaultPage;
                    } else {
                        console.log('[Redirect] ‚úÖ No redirect needed');
                    }
                },

                // ==========================================
                // USER INFO
                // ==========================================
                loadUserInfo() {
                    this.userName = localStorage.getItem('usuarioNome') || 'Usuario';
                    const empresaNome = localStorage.getItem('empresaNome');

                    // Set avatar
                    const avatar = document.getElementById('user-info-avatar');
                    if (avatar) {
                        avatar.textContent = this.userName.charAt(0).toUpperCase();
                    }

                    // Set dropdown info
                    const dropdown = document.getElementById('user-info-dropdown');
                    if (dropdown) {
                        dropdown.innerHTML = `
                            <div style="padding: 8px 12px;">
                                <p style="font-weight: 600; color: var(--dashboard-text);">${this.userName}</p>
                                <p style="font-size: 12px; color: var(--dashboard-text-secondary);">${empresaNome || 'N/A'}</p>
                            </div>
                        `;
                    }

                    // Fetch company name
                    this.loadCompanyName();
                },

                async loadCompanyName() {
                    const empresaId = localStorage.getItem('empresaId');
                    if (!empresaId) return;

                    try {
                        const empresa = await window.api.getEmpresaById(empresaId);
                        this.companyName = empresa.nome;
                        localStorage.setItem('empresaNome', empresa.nome);
                    } catch (error) {
                        console.error('Error loading company:', error);
                    }
                },

                // ==========================================
                // NAV MENU USER FUNCTIONS
                // ==========================================
                getUserInitials() {
                    const name = localStorage.getItem('usuarioNome') || 'U';
                    const parts = name.trim().split(' ');
                    if (parts.length >= 2) {
                        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
                    }
                    return name.charAt(0).toUpperCase();
                },

                getUserName() {
                    return localStorage.getItem('usuarioNome') || 'Usu√°rio';
                },

                getUserRole() {
                    const role = localStorage.getItem('userRole');
                    const roleNames = {
                        'LINA_OWNER': 'üëë Administrador Geral',
                        'OWNER': 'üëë Propriet√°rio',
                        'FUNCIONARIO': 'Funcion√°rio',
                        'LAVADOR': 'Lavador'
                    };
                    return roleNames[role] || 'Usu√°rio';
                },

                handleLogout() {
                    if (typeof logout === 'function') {
                        logout();
                    } else {
                        // Fallback if global logout function doesn't exist
                        if (confirm('Tem certeza que deseja sair do sistema?')) {
                            window.api.logout();
                        }
                    }
                },

                // ==========================================
                // DATE & TIME
                // ==========================================
                updateDateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    this.currentDate = now.toLocaleDateString('pt-BR', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long'
                    });
                },

                getGreeting() {
                    const hour = new Date().getHours();
                    if (hour < 12) return 'Bom dia';
                    if (hour < 18) return 'Boa tarde';
                    return 'Boa noite';
                },

                // ==========================================
                // DATA LOADING
                // ==========================================
                async loadDashboardStats() {
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        const filters = { dataInicio: today, dataFim: today };

                        const [statsData, activeData] = await Promise.all([
                            window.api.getOrdensStats(filters),
                            window.api.getOrdens(1, 1, '', 'PENDENTE,EM_ANDAMENTO,AGUARDANDO_PAGAMENTO')
                        ]);

                        this.stats.revenue = statsData.valorTotal || 0;
                        this.stats.completed = statsData.ordensFinalizadas || 0;
                        this.stats.inProgress = activeData.pagination?.total || 0;
                        this.stats.averageTicket = this.stats.completed > 0
                            ? this.stats.revenue / this.stats.completed
                            : 0;

                    } catch (error) {
                        console.error('Error loading stats:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async loadRecentOrders() {
                    try {
                        const today = new Date().toISOString().split('T')[0];
                        const response = await window.api.getOrdens(1, 5, '', '', '', '', today, today);
                        this.recentOrders = response.ordens || [];

                        // Build hourly data from recent orders for chart
                        this.buildHourlyData(response.ordens || []);
                    } catch (error) {
                        console.error('Error loading recent orders:', error);
                    } finally {
                        this.isLoadingRecent = false;
                    }
                },

                // ==========================================
                // CHART.JS INTEGRATION
                // ==========================================
                /**
                 * Initialize Chart.js instance
                 *
                 * This demonstrates how Alpine.js works with Chart.js:
                 * 1. We use $refs to get the canvas element
                 * 2. Chart is initialized in init() after DOM is ready
                 * 3. Chart instance is stored for later updates
                 * 4. Data updates use chartInstance.data + chartInstance.update()
                 */
                initChart() {
                    // Wait for DOM to be fully ready
                    this.$nextTick(() => {
                        // Add retry logic for canvas initialization
                        let chartRetries = 0;
                        const maxChartRetries = 3;

                        const attemptChartInit = () => {
                            chartRetries++;
                            setTimeout(() => {
                                try {
                                    // STEP 1: Destroy existing chart instance before creating new one
                                    // This prevents "Canvas is already in use" error
                                    if (this.chartInstance) {
                                        try {
                                            this.chartInstance.destroy();
                                        } catch (e) {
                                            console.warn('Failed to destroy chart instance:', e);
                                        }
                                        this.chartInstance = null;
                                    }

                                    // STEP 2: Canvas validation - ensure canvas element exists
                                    const canvas = this.$refs.chartCanvas;
                                    if (!canvas) {
                                        if (chartRetries < maxChartRetries) {
                                            console.warn(`[Chart] Canvas element not found - retrying (${chartRetries}/${maxChartRetries})`);
                                            attemptChartInit();
                                            return;
                                        }
                                        console.warn('[Chart] Canvas element not found after retries - skipping chart initialization');
                                        return;
                                    }

                            // CRITICAL FIX: Stop infinite recursion when canvas is not visible
                            // Check if canvas has dimensions (is visible)
                            if (canvas.clientWidth === 0 || canvas.clientHeight === 0) {
                                console.warn('[Chart] Canvas not visible - skipping chart initialization');
                                // DO NOT CALL this.initChart() RECURSIVELY - prevents stack overflow
                                return;
                            }

                            const ctx = canvas.getContext('2d');
                            if (!ctx) {
                                console.warn('Failed to get 2D context from canvas');
                                return;
                            }

                            // Generate hours for x-axis (8am to 8pm for car wash)
                            const hours = [];
                            for (let i = 8; i <= 20; i++) {
                                hours.push(`${i}:00`);
                            }

                            // STEP 3: CRITICAL - Unwrap Alpine.js Proxy into clean JavaScript array
                            // This prevents "Cannot read properties of null (reading 'save')" error
                            let cleanData;
                            try {
                                // Use real data if available, otherwise generate mock
                                const sourceData = this.hourlyData && this.hourlyData.length > 0
                                    ? this.hourlyData
                                    : this.generateMockHourlyData();

                                // Unwrap Alpine Proxy by deep cloning
                                cleanData = JSON.parse(JSON.stringify(sourceData));
                            } catch (e) {
                                console.warn('Failed to unwrap chart data:', e);
                                cleanData = null;
                            }

                            // STEP 4: Safety fallback - ensure we have valid data array
                            if (!cleanData || !Array.isArray(cleanData) || cleanData.length === 0) {
                                console.warn('No valid chart data, using zeros');
                                cleanData = new Array(13).fill(0); // 13 hours (8am to 8pm)
                            }

                            // Get CSS variable colors for theming
                            const computedStyle = getComputedStyle(document.documentElement);
                            const accentCyan = computedStyle.getPropertyValue('--accent-cyan').trim() || '#06b6d4';

                            // STEP 5: Initialize Chart.js with clean, unwrapped data
                            try {
                                this.chartInstance = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: hours,
                                        datasets: [{
                                            label: 'Veiculos',
                                            data: cleanData, // Use clean data, not Alpine Proxy
                                            borderColor: accentCyan,
                                            backgroundColor: `${accentCyan}20`,
                                            fill: true,
                                            tension: 0.4,
                                            pointBackgroundColor: accentCyan,
                                            pointBorderColor: '#fff',
                                            pointBorderWidth: 2,
                                            pointRadius: 4,
                                            pointHoverRadius: 6
                                        }]
                                    },
                                    options: {
                                        // CRITICAL: Disable ALL animations to prevent "save" error
                                        animation: false,
                                        responsiveAnimationDuration: 0,
                                        hover: {
                                            mode: null
                                        },
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: false
                                            },
                                            tooltip: {
                                                backgroundColor: '#1a1a1a',
                                                titleColor: '#fff',
                                                bodyColor: '#fff',
                                                padding: 12,
                                                cornerRadius: 8,
                                                displayColors: false,
                                                callbacks: {
                                                    label: (context) => `${context.raw} veiculo(s)`
                                                }
                                            }
                                        },
                                        scales: {
                                            x: {
                                                grid: {
                                                    display: false
                                                },
                                                ticks: {
                                                    color: '#8c8c8c',
                                                    font: {
                                                        size: 11
                                                    }
                                                }
                                            },
                                            y: {
                                                beginAtZero: true,
                                                grid: {
                                                    color: 'rgba(0, 0, 0, 0.05)'
                                                },
                                                ticks: {
                                                    color: '#8c8c8c',
                                                    font: {
                                                        size: 11
                                                    },
                                                    stepSize: 1
                                                }
                                            }
                                        },
                                        interaction: {
                                            intersect: false,
                                            mode: 'index'
                                        }
                                    }
                                });

                                console.log('[Chart] ‚úÖ Initialized successfully with', cleanData.length, 'data points');
                            } catch (error) {
                                console.error('[Chart] ‚ùå Failed to initialize:', error);
                                this.chartInstance = null;
                            }
                            }, 150); // 150ms delay for canvas stability
                        };

                        // Start chart initialization attempt
                        attemptChartInit();
                    });
                },

                /**
                 * Build hourly data from actual orders
                 * Updates both Alpine state and Chart.js instance
                 *
                 * CRITICAL FIX: Bypass Alpine reactivity completely
                 */
                buildHourlyData(orders) {
                    // MANDATORY GUARD: Exit early if no chart instance
                    if (!this.chartInstance) {
                        console.log('[Chart] No chart instance - skipping buildHourlyData');
                        return;
                    }

                    // CRITICAL: Unwrap Alpine proxy IMMEDIATELY before processing
                    const cleanOrders = JSON.parse(JSON.stringify(orders || []));

                    // Initialize array for hours 8-20
                    const hourCounts = new Array(13).fill(0);

                    // Count orders by hour using clean, unwrapped data
                    cleanOrders.forEach(order => {
                        try {
                            const hour = new Date(order.createdAt).getHours();
                            if (hour >= 8 && hour <= 20) {
                                hourCounts[hour - 8]++;
                            }
                        } catch (e) {
                            console.warn('[Chart] Invalid order date:', order?.createdAt);
                        }
                    });

                    // Update Alpine state with clean array (not proxy)
                    this.hourlyData = [...hourCounts]; // Use spread to avoid proxy

                    // CRITICAL: Access raw chart instance to bypass Alpine Proxy
                    // Alpine wraps objects in Proxies, causing Chart.js to crash
                    let rawChart;
                    try {
                        // Try Alpine.raw() first (Alpine v3.x)
                        rawChart = Alpine.raw ? Alpine.raw(this.chartInstance) : this.chartInstance;
                    } catch (e) {
                        // Fallback: Access the raw object through the proxy target
                        rawChart = this.chartInstance;
                    }

                    // Verify chart structure before updating
                    if (rawChart &&
                        rawChart.data &&
                        rawChart.data.datasets &&
                        rawChart.data.datasets[0] &&
                        typeof rawChart.update === 'function') {
                        try {
                            // CRITICAL: Create COMPLETELY NEW non-reactive data object
                            // This prevents ANY Alpine Proxy contamination
                            const cleanData = hourCounts.slice(); // Shallow copy for primitive array

                            // CRITICAL: Replace the ENTIRE data object, not just the array
                            // This ensures no Proxy objects remain in the chart
                            const newDataObject = {
                                labels: ['8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'],
                                datasets: [{
                                    label: 'Veiculos',
                                    data: cleanData,
                                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-cyan').trim() || '#06b6d4',
                                    backgroundColor: (getComputedStyle(document.documentElement).getPropertyValue('--accent-cyan').trim() || '#06b6d4') + '20',
                                    fill: true,
                                    tension: 0.4,
                                    pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-cyan').trim() || '#06b6d4',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }]
                            };

                            // Replace the entire data object (not individual properties)
                            rawChart.data = newDataObject;

                            // Use 'none' mode to skip animations (better performance)
                            rawChart.update('none');

                            console.log('[Chart] ‚úÖ Updated with', cleanData.length, 'data points');
                        } catch (e) {
                            console.error('[Chart] ‚ùå Failed to update chart data:', e);
                            console.error('[Chart] Error stack:', e.stack);
                            // Don't re-throw - just log and continue
                        }
                    } else {
                        console.warn('[Chart] ‚ö†Ô∏è Chart not fully initialized - skipping update');
                    }
                },

                /**
                 * Generate realistic mock data for demonstration
                 */
                generateMockHourlyData() {
                    const currentHour = new Date().getHours();
                    const data = [];

                    for (let i = 8; i <= 20; i++) {
                        if (i > currentHour) {
                            data.push(0); // Future hours
                        } else {
                            // Simulate typical car wash pattern: busy late morning and afternoon
                            let base = 2;
                            if (i >= 10 && i <= 12) base = 5; // Morning rush
                            if (i >= 14 && i <= 17) base = 4; // Afternoon
                            if (i === 12) base = 3; // Lunch dip

                            const variation = Math.floor(Math.random() * 3) - 1;
                            data.push(Math.max(0, base + variation));
                        }
                    }

                    return data;
                },

                // ==========================================
                // FORMATTERS & HELPERS
                // ==========================================
                formatCurrency(value) {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value || 0);
                },

                formatTime(dateString) {
                    return new Date(dateString).toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                getMainService(order) {
                    const service = order.items?.find(i => i.tipo === 'SERVICO');
                    return service?.servico?.nome || service?.nome || 'Servico';
                },

                getStatusClass(status) {
                    const classes = {
                        'FINALIZADO': 'completed',
                        'EM_ANDAMENTO': 'progress',
                        'AGUARDANDO_PAGAMENTO': 'pending',
                        'PENDENTE': 'pending',
                        'CANCELADO': 'cancelled'
                    };
                    return classes[status] || 'pending';
                },

                getStatusIcon(status) {
                    const icons = {
                        'FINALIZADO': 'fas fa-check',
                        'EM_ANDAMENTO': 'fas fa-hourglass-half',
                        'AGUARDANDO_PAGAMENTO': 'fas fa-hand-holding-usd',
                        'PENDENTE': 'fas fa-clock',
                        'CANCELADO': 'fas fa-times'
                    };
                    return icons[status] || 'fas fa-clock';
                },

                // ==========================================
                // UI COMPONENTS
                // ==========================================
                initializeUIComponents() {
                    // User menu
                    const trigger = document.getElementById('user-menu-trigger');
                    const dropdown = document.getElementById('user-menu-dropdown');
                    if (trigger && dropdown) {
                        trigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            dropdown.classList.toggle('active');
                        });
                        document.addEventListener('click', (e) => {
                            if (!dropdown.contains(e.target) && !trigger.contains(e.target)) {
                                dropdown.classList.remove('active');
                            }
                        });
                    }

                    // Permissions - DISABLED (permission system not implemented)
                    // if (typeof enforcePermission === 'function') {
                    //     enforcePermission('ver_dashboard');
                    // }
                    if (typeof updateMenuVisibility === 'function') {
                        updateMenuVisibility();
                    }

                    // Quick actions visibility
                    this.updateQuickActionsVisibility();

                    // Handle impersonation banner
                    if (typeof handleImpersonationBanner === 'function') {
                        handleImpersonationBanner();
                    }
                },

                updateQuickActionsVisibility() {
                    const buttons = document.querySelectorAll('.action-btn[data-permission]');
                    buttons.forEach(btn => {
                        const perm = btn.dataset.permission;
                        if (typeof hasPermission === 'function' && !hasPermission(perm)) {
                            btn.style.display = 'none';
                        }
                    });
                },

                // ==========================================
                // NOTIFICATIONS
                // ==========================================
                initNotifications() {
                    const bell = document.getElementById('notification-bell');
                    const panel = document.getElementById('notification-panel');
                    const dot = document.getElementById('notification-dot');
                    const markAllBtn = document.getElementById('mark-all-read-btn');

                    if (bell && panel) {
                        bell.addEventListener('click', (e) => {
                            e.stopPropagation();

                            // Calcula a posi√ß√£o do bot√£o do sino
                            const bellRect = bell.getBoundingClientRect();

                            // Posiciona o painel abaixo do sino, alinhado √† direita
                            panel.style.top = `${bellRect.bottom + 12}px`;
                            panel.style.right = `${window.innerWidth - bellRect.right}px`;

                            panel.classList.toggle('active');
                            if (panel.classList.contains('active')) {
                                dot.style.display = 'none';
                            }
                        });

                        document.addEventListener('click', (e) => {
                            if (!panel.contains(e.target) && !bell.contains(e.target)) {
                                panel.classList.remove('active');
                            }
                        });

                        // Reposiciona o painel ao redimensionar a janela
                        window.addEventListener('resize', () => {
                            if (panel.classList.contains('active')) {
                                const bellRect = bell.getBoundingClientRect();
                                panel.style.top = `${bellRect.bottom + 12}px`;
                                panel.style.right = `${window.innerWidth - bellRect.right}px`;
                            }
                        });
                    }

                    if (markAllBtn) {
                        markAllBtn.addEventListener('click', async () => {
                            try {
                                await window.api.marcarTodasComoLidas();
                                if (typeof showToast === 'function') {
                                    showToast('Todas as notificacoes foram marcadas como lidas.');
                                }
                                this.loadNotifications();
                            } catch (error) {
                                console.error('Error marking notifications:', error);
                            }
                        });
                    }

                    this.loadNotifications();
                    setInterval(() => this.loadNotifications(), 30000);
                },

                async loadNotifications() {
                    try {
                        const response = await window.api.getNotificacoes();
                        const notifications = response.notificacoes || [];
                        const list = document.getElementById('notification-list');
                        const dot = document.getElementById('notification-dot');

                        if (!list) return;

                        list.innerHTML = '';

                        if (notifications.length > 0) {
                            const hasUnread = notifications.some(n => !n.lida);
                            if (dot) dot.style.display = hasUnread ? 'block' : 'none';

                            notifications.forEach(n => {
                                const item = document.createElement('div');
                                item.className = `notification-item ${n.lida ? '' : 'unread'}`;
                                item.innerHTML = `
                                    <div class="notification-icon ${n.type || 'info'}">
                                        <i class="fas ${this.getNotificationIcon(n.type)}"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p>${n.mensagem}</p>
                                        <small class="text-secondary">
                                            ${new Date(n.createdAt).toLocaleDateString('pt-BR')} as
                                            ${new Date(n.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                                        </small>
                                    </div>
                                `;
                                list.appendChild(item);
                            });
                        } else {
                            if (dot) dot.style.display = 'none';
                            list.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>Nenhuma notificacao nova.</p></div>';
                        }
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                    }
                },

                getNotificationIcon(type) {
                    const icons = {
                        ordemCriada: 'fa-plus-circle',
                        ordemEditada: 'fa-pencil-alt',
                        ordemDeletada: 'fa-trash-alt',
                        finalizacaoAutomatica: 'fa-magic',
                        info: 'fa-info-circle'
                    };
                    return icons[type] || 'fa-info-circle';
                }
            };
        }

        // ==========================================
        // GLOBAL FUNCTIONS (needed for onclick handlers)
        // ==========================================
        function logout() {
            showCustomConfirm({
                title: 'Confirmar Saida',
                message: 'Tem certeza que deseja sair do sistema?',
                onConfirm: () => window.api.logout()
            });
        }

        // ==========================================
        // DEFENSIVE: COMPREHENSIVE VISIBILITY DIAGNOSTICS
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Diagnostics] DOMContentLoaded fired');

            // Check body/html visibility
            const bodyStyles = window.getComputedStyle(document.body);
            const htmlStyles = window.getComputedStyle(document.documentElement);

            console.log('[Diagnostics] Body styles:', {
                display: bodyStyles.display,
                visibility: bodyStyles.visibility,
                opacity: bodyStyles.opacity
            });

            console.log('[Diagnostics] HTML styles:', {
                display: htmlStyles.display,
                visibility: htmlStyles.visibility,
                opacity: htmlStyles.opacity
            });

            // Check for overlays
            const screenLock = document.getElementById('screenLockModal');
            if (screenLock) {
                const lockDisplay = window.getComputedStyle(screenLock).display;
                console.log('[Diagnostics] Screen lock overlay display:', lockDisplay);
                if (lockDisplay !== 'none') {
                    console.error('[Diagnostics] ‚ùå SCREEN LOCK IS ACTIVE! This is covering the page!');
                }
            }

            // Force body/html visible
            document.body.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;

            document.documentElement.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;

            console.log('[Layout] ‚úÖ No top bar - full screen dashboard layout');

            // Check Alpine.js initialization with retry logic
            let retries = 0;
            const maxRetries = 5;
            const checkAlpineInit = () => {
                retries++;
                console.log(`[Diagnostics] Checking Alpine.js initialization (attempt ${retries}/${maxRetries})...`);

                if (typeof Alpine === 'undefined') {
                    console.error('[Alpine] ‚ùå Alpine.js not loaded!');
                    return;
                }

                // Check if x-cloak was removed from main content
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    if (mainContent.hasAttribute('x-cloak')) {
                        // Alpine might still be initializing - retry
                        if (retries < maxRetries) {
                            console.warn(`[Alpine] ‚è≥ x-cloak still present - retrying (${retries}/${maxRetries})...`);
                            setTimeout(checkAlpineInit, 500);
                            return;
                        }

                        console.error('[Alpine] ‚ùå x-cloak still present after retries! Alpine.js failed to initialize.');
                        console.error('[Alpine] This means the dashboard() function likely threw an error.');
                        console.error('[Alpine] Check console for errors in dashboard init()');

                        // Force remove x-cloak to show content anyway
                        mainContent.removeAttribute('x-cloak');
                        console.warn('[Alpine] Manually removed x-cloak as fallback');
                    } else {
                        console.log('[Alpine] ‚úÖ x-cloak removed - Alpine.js initialized successfully');
                    }
                } else {
                    // Element not found - might be redirecting
                    if (retries < maxRetries) {
                        console.warn(`[Alpine] ‚è≥ Main content element not found - retrying (${retries}/${maxRetries})...`);
                        setTimeout(checkAlpineInit, 500);
                        return;
                    }
                    console.error('[Alpine] ‚ùå Main content element not found after retries - page may have redirected');
                }
            };

            // Start checking after a short delay to let page load
            setTimeout(checkAlpineInit, 1000);
        });
    </script>
    <script src="nav-menu-helper.js"></script>
    <script src="mobile-nav.js"></script>
    <script src="webapp-bottom-nav.js"></script>

    <nav class="bottom-navigation">
        <a href="index.html" class="bottom-nav-item active" data-page="home" title="Dashboard">
            <i class="fas fa-home"></i>
            <span>In√≠cio</span>
        </a>
        <a href="ordens.html" class="bottom-nav-item" data-page="ordens" title="Minhas Ordens">
            <i class="fas fa-list-check"></i>
            <span>Ordens</span>
        </a>
        <a href="novaordem.html" class="bottom-nav-item" data-page="novaordem" title="Nova Ordem">
            <i class="fas fa-plus-circle"></i>
            <span>Nova</span>
        </a>
        <a href="clientes.html" class="bottom-nav-item" data-page="clientes" title="Clientes">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
        <a href="#" class="bottom-nav-item" data-page="menu" onclick="toggleMobileMenu(event)" title="Menu">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </a>
    </nav>
</body>
</html>


