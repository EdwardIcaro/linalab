<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinaX - Login</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Alpine.js via CDN (no build step required) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
</head>
<body class="auth-body">

    <div id="toast-container"></div>

    <!-- Modal de Alerta Customizado (Alpine.js controlled) -->
    <div x-data="alertModal()" x-cloak>
        <div
            class="custom-modal-overlay"
            x-show="isOpen"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            @keydown.escape.window="close()"
        >
            <div class="custom-modal-content" style="max-width: 420px;">
                <div class="custom-modal-icon icon-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="custom-modal-title" x-text="title">Acesso Bloqueado</h3>
                <p class="custom-modal-message" x-text="message">Sua conta está temporariamente desativada.</p>
                <div class="custom-modal-actions" style="justify-content: center;">
                    <button class="btn btn-primary" @click="close()">Entendi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Login Container -->
    <div class="auth-container" x-data="loginForm()" x-init="init()">
        <div class="auth-header">
            <a href="#" class="logo">
                <i class="fas fa-car-wash"></i>
                <h1>LinaX</h1>
            </a>
            <h2>Bem-vindo de volta!</h2>
            <p>Faça login para continuar gerenciando seu negócio.</p>
        </div>

        <div class="auth-card">
            <!-- Error Message Display -->
            <div
                x-show="errorMessage"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                class="alert alert-error"
                style="margin-bottom: 1rem; padding: 0.75rem 1rem; background: var(--error-bg, #fee2e2); border: 1px solid var(--error-border, #fecaca); border-radius: 8px; color: var(--error-text, #dc2626);"
            >
                <i class="fas fa-exclamation-circle"></i>
                <span x-text="errorMessage"></span>
            </div>

            <form @submit.prevent="submitLogin">
                <div class="form-group">
                    <label for="email" class="form-label">E-mail</label>
                    <div class="input-group">
                        <input
                            type="email"
                            id="email"
                            class="form-input"
                            placeholder="seu@email.com"
                            x-model="email"
                            :disabled="isLoading"
                            required
                        >
                        <i class="input-icon fas fa-envelope"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password" class="form-label">Senha</label>
                    <div class="input-group">
                        <input
                            type="password"
                            id="password"
                            class="form-input"
                            placeholder="••••••••"
                            x-model="password"
                            :disabled="isLoading"
                            required
                        >
                        <i class="input-icon fas fa-lock"></i>
                    </div>
                </div>

                <div class="form-extra-options">
                    <div class="remember-me">
                        <input
                            type="checkbox"
                            id="rememberMe"
                            x-model="rememberMe"
                            :disabled="isLoading"
                        >
                        <label for="rememberMe">Lembrar-me</label>
                    </div>
                </div>

                <button
                    type="submit"
                    class="btn-primary"
                    :disabled="isLoading || !isFormValid"
                    :class="{ 'btn-loading': isLoading }"
                >
                    <!-- Loading Spinner -->
                    <template x-if="isLoading">
                        <i class="fas fa-spinner fa-spin"></i>
                    </template>
                    <!-- Normal Icon -->
                    <template x-if="!isLoading">
                        <i class="fas fa-sign-in-alt"></i>
                    </template>
                    <span x-text="isLoading ? 'Entrando...' : 'Entrar'"></span>
                </button>
            </form>
        </div>

        <div class="auth-link">
            Não tem uma conta? <a href="signup.html">Crie uma agora</a>
        </div>
    </div>

    <script src="api.js"></script>
    <script src="utils.js"></script>
    <script>
        /**
         * Alpine.js Component: Alert Modal
         * Provides a reusable modal for displaying alerts
         */
        function alertModal() {
            return {
                isOpen: false,
                title: '',
                message: '',

                show(options) {
                    this.title = options.title || 'Alerta';
                    this.message = options.message || '';
                    this.isOpen = true;
                },

                close() {
                    this.isOpen = false;
                }
            };
        }

        /**
         * Alpine.js Component: Login Form
         * Encapsulates all login form state and logic
         */
        function loginForm() {
            return {
                // Form State
                email: '',
                password: '',
                rememberMe: false,

                // UI State
                isLoading: false,
                errorMessage: '',

                // Computed: Form validation
                get isFormValid() {
                    return this.email.length > 0 && this.password.length > 0;
                },

                /**
                 * Initialize component - load remembered email
                 */
                init() {
                    const savedEmail = localStorage.getItem('rememberedEmail');
                    if (savedEmail) {
                        this.email = savedEmail;
                        this.rememberMe = true;
                    }
                },

                /**
                 * Clear error message
                 */
                clearError() {
                    this.errorMessage = '';
                },

                /**
                 * Show alert modal
                 */
                showAlert(options) {
                    // Find the alert modal component and trigger it
                    const modal = document.querySelector('[x-data="alertModal()"]');
                    if (modal && modal.__x) {
                        modal.__x.$data.show(options);
                    }
                },

                /**
                 * Handle form submission
                 */
                async submitLogin() {
                    // Clear previous errors
                    this.clearError();

                    // Set loading state
                    this.isLoading = true;

                    try {
                        // Call API
                        const data = await window.api.login(this.email, this.password);

                        // Store authentication data
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('usuarioNome', data.usuario.nome);
                        const resolvedRole = (data.usuario.role === 'LINA_OWNER')
                            ? 'LINA_OWNER'
                            : (data.usuario.empresas && data.usuario.empresas.length > 0 ? 'OWNER' : data.usuario.role);
                        localStorage.setItem('userRole', resolvedRole);
                        localStorage.setItem('permissoes', JSON.stringify(data.usuario.permissoes || []));

                        // Handle "Remember Me"
                        if (this.rememberMe) {
                            localStorage.setItem('rememberedEmail', this.email);
                        } else {
                            localStorage.removeItem('rememberedEmail');
                        }

                        // Route based on user role and type
                        await this.handleRedirect(data);

                    } catch (error) {
                        console.error('Login error:', error);
                        this.handleError(error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                /**
                 * Handle post-login redirect logic
                 */
                async handleRedirect(data) {
                    // Admin/Owner goes to admin dashboard
                    if (data.usuario.role === 'LINA_OWNER') {
                        window.location.href = 'admin/dashboard.html';
                        return;
                    }

                    // Subaccount user (has empresaId) goes directly to dashboard
                    if (data.usuario.empresaId) {
                        localStorage.setItem('empresaId', data.usuario.empresaId);
                        window.location.href = 'index.html';
                        return;
                    }

                    // Owner user - check for empresas
                    try {
                        const empresas = await window.api.getEmpresasDoUsuario();
                        if (empresas && empresas.length > 0) {
                            window.location.href = 'selecionar-empresa.html';
                        } else {
                            window.location.href = 'nova-empresa.html';
                        }
                    } catch (err) {
                        // If we can't fetch empresas, go to selection page
                        window.location.href = 'selecionar-empresa.html';
                    }
                },

                /**
                 * Handle login errors
                 */
                handleError(error) {
                    // Check for deactivated account error
                    if (error?.error?.includes('desativada')) {
                        this.showAlert({
                            title: 'Acesso Bloqueado',
                            message: error.error
                        });
                        return;
                    }

                    // Display inline error for other cases
                    this.errorMessage = error?.message || error?.error || 'Erro de conexão. Tente novamente.';

                    // Also show toast for visibility
                    if (typeof showToast === 'function') {
                        showToast(this.errorMessage, 'error');
                    }
                }
            };
        }
    </script>

    <style>
        /* Hide Alpine.js elements until loaded (prevents FOUC) */
        [x-cloak] {
            display: none !important;
        }

        /* Loading button state */
        .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Smooth transitions for Alpine */
        .transition {
            transition-property: all;
        }
        .ease-out {
            transition-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
        .ease-in {
            transition-timing-function: cubic-bezier(0.4, 0, 1, 1);
        }
        .duration-200 {
            transition-duration: 200ms;
        }
        .duration-150 {
            transition-duration: 150ms;
        }
        .duration-300 {
            transition-duration: 300ms;
        }
        .opacity-0 {
            opacity: 0;
        }
        .opacity-100 {
            opacity: 1;
        }
        .transform {
            transform: translateX(0);
        }
        .-translate-y-2 {
            transform: translateY(-0.5rem);
        }
        .translate-y-0 {
            transform: translateY(0);
        }

        /* Inline alert styling */
        .alert {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .alert-error {
            --error-bg: rgba(220, 38, 38, 0.1);
            --error-border: rgba(220, 38, 38, 0.2);
            --error-text: #dc2626;
        }

        /* Spinner animation */
        .fa-spin {
            animation: fa-spin 1s infinite linear;
        }
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>

