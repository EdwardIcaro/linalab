<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinaX - Extrato</title>
  <script src="api.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #8B5CF6;
      --primary-dark: #7C3AED;
      --primary-light: #A78BFA;
      --success: #10B981;
      --success-light: #D1FAE5;
      --danger: #EF4444;
      --danger-light: #FEE2E2;
      --warning: #F59E0B;
      --warning-light: #FEF3C7;
      --info: #3B82F6;
      --info-light: #DBEAFE;

      --bg-main: #F5F5F7;
      --bg-card: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --text-muted: #9CA3AF;
      --border: #E5E7EB;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
      min-height: 100vh;
    }

    /* =================== LOADER =================== */
    .loader-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--bg-main);
    }

    .loader-icon {
      width: 48px;
      height: 48px;
      border: 3px solid var(--primary-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loader-text {
      margin-top: 20px;
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* =================== ERROR =================== */
    .error-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .error-icon {
      font-size: 48px;
      color: var(--danger);
      margin-bottom: 20px;
    }

    .error-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .error-message {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
      max-width: 320px;
    }

    /* =================== HEADER =================== */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 24px 20px;
      border-radius: 0 0 var(--radius-xl) var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    .header-greeting {
      font-size: 13px;
      font-weight: 500;
      opacity: 0.9;
      margin-bottom: 2px;
    }

    .header-name {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .balance-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .balance-label {
      font-size: 12px;
      font-weight: 500;
      opacity: 0.9;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .balance-value {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .balance-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      opacity: 0.8;
      padding: 4px;
      transition: opacity 0.2s;
    }

    .balance-toggle:hover {
      opacity: 1;
    }

    .balance-value.hidden-value {
      filter: blur(8px);
      user-select: none;
    }

    .token-timer {
      margin-top: 12px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      opacity: 0.9;
    }

    .token-timer i {
      font-size: 14px;
    }

    .token-timer.expiring-soon {
      background: rgba(245, 158, 11, 0.2);
      color: #FFF;
    }

    .token-timer.permanent {
      background: rgba(16, 185, 129, 0.2);
    }

    /* =================== PERIOD SUMMARY =================== */
    .period-summary {
      padding: 16px 20px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .period-card {
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      padding: 12px 10px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: center;
    }

    .period-card:active {
      transform: scale(0.98);
    }

    .period-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      margin: 0 auto 8px;
    }

    .period-icon.week {
      background: #EEF2FF;
      color: #6366F1;
    }

    .period-icon.month {
      background: #D1FAE5;
      color: #059669;
    }

    .period-icon.debt {
      background: var(--danger-light);
      color: var(--danger);
    }

    .period-label {
      font-size: 10px;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .period-value {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* =================== SECTION HEADER =================== */
    .section-header {
      padding: 20px 20px 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* =================== TRANSACTIONS =================== */
    .transactions {
      padding: 0 20px 20px 20px;
    }

    .transaction-day {
      margin-bottom: 20px;
    }

    .day-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      padding-left: 4px;
    }

    .transaction-item {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-sm);
      border-left: 3px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: default;
    }

    .transaction-item.clickable {
      cursor: pointer;
    }

    .transaction-item.clickable:active {
      transform: scale(0.98);
    }

    .transaction-item.credit {
      border-left-color: var(--success);
    }

    .transaction-item.payment {
      border-left-color: var(--info);
    }

    .transaction-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .transaction-icon.credit {
      background: var(--success-light);
      color: var(--success);
    }

    .transaction-icon.payment {
      background: var(--info-light);
      color: var(--info);
    }

    .transaction-details {
      flex: 1;
      min-width: 0;
    }

    .transaction-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .transaction-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .transaction-value {
      font-size: 16px;
      font-weight: 700;
      text-align: right;
      white-space: nowrap;
    }

    .transaction-value.credit {
      color: var(--success);
    }

    .transaction-value.payment {
      color: var(--info);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      padding: 3px 7px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .multi-wash-badge {
      background: var(--warning-light);
      color: var(--warning);
    }

    .multi-wash-badge i {
      font-size: 9px;
    }

    .status-badge.FINALIZADO {
      background: var(--success-light);
      color: #065F46;
    }

    .status-badge.EM_ANDAMENTO {
      background: #FEF3C7;
      color: #92400E;
    }

    .status-badge.AGUARDANDO_PAGAMENTO {
      background: #DBEAFE;
      color: #1E40AF;
    }

    .status-badge.PENDENTE {
      background: #F3F4F6;
      color: #4B5563;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
    }

    .empty-icon {
      font-size: 48px;
      color: var(--text-muted);
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .empty-text {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* =================== MODAL =================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 10;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-summary {
      background: var(--bg-main);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 20px;
    }

    .modal-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-summary-row:last-child {
      margin-bottom: 0;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .modal-summary-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .modal-summary-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-summary-value.total {
      font-size: 18px;
      color: var(--info);
    }

    .modal-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .modal-order-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 8px;
    }

    .modal-order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .modal-order-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-order-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--success);
    }

    .modal-order-services {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .modal-order-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    /* Desktop */
    @media (min-width: 641px) {
      .header {
        padding: 32px 24px;
      }

      .header-name {
        font-size: 28px;
      }

      .balance-value {
        font-size: 36px;
      }

      .period-summary {
        padding: 20px 24px;
        gap: 12px;
      }

      .period-card {
        padding: 16px 14px;
      }

      .period-icon {
        width: 32px;
        height: 32px;
        font-size: 15px;
        margin-bottom: 10px;
      }

      .period-label {
        font-size: 11px;
      }

      .period-value {
        font-size: 18px;
      }

      .section-header {
        padding: 24px 24px 16px 24px;
      }

      .section-title {
        font-size: 18px;
      }

      .section-subtitle {
        font-size: 13px;
      }

      .transactions {
        padding: 0 24px 24px 24px;
      }

      .day-header {
        font-size: 13px;
      }

      .transaction-item {
        padding: 16px;
        gap: 16px;
      }

      .transaction-icon {
        width: 48px;
        height: 48px;
        font-size: 20px;
      }

      .transaction-title {
        font-size: 15px;
        gap: 8px;
      }

      .transaction-subtitle {
        font-size: 13px;
      }

      .transaction-value {
        font-size: 18px;
      }

      .badge {
        font-size: 11px;
      }

      .modal-content {
        border-radius: var(--radius-xl);
        max-height: 85vh;
      }

      .modal-overlay {
        align-items: center;
      }
    }
  </style>
<link rel="stylesheet" href="webapp-mobile.css">
<link rel="stylesheet" href="fix-responsive.css">
</head>
<body>

  <!-- LOADER -->
  <div id="loader" class="loader-screen">
    <div class="loader-icon"></div>
    <div class="loader-text">Carregando seu extrato...</div>
  </div>

  <!-- ERROR -->
  <div id="error" class="error-screen hidden">
    <div class="error-icon">
      <i id="error-icon" class="fas fa-user-lock"></i>
    </div>
    <h1 id="error-title" class="error-title">Acesso Desativado</h1>
    <p id="error-message" class="error-message">
      Seu link de acesso foi desativado. Por favor, entre em contato com o administrador.
    </p>
  </div>

  <!-- CONTENT -->
  <div id="content" class="container hidden">
    <!-- Header com saldo -->
    <div class="header">
      <div class="header-greeting">Olá,</div>
      <div id="lavadorNome" class="header-name">Carregando...</div>

      <div class="balance-card">
        <div class="balance-label">
          <span>Saldo Disponível</span>
          <button onclick="toggleBalance()" class="balance-toggle">
            <i id="balance-eye" class="fas fa-eye"></i>
          </button>
        </div>
        <div id="saldoTotal" class="balance-value">R$ 0,00</div>

        <!-- Token Timer -->
        <div id="tokenTimer" class="token-timer hidden">
          <i class="fas fa-clock"></i>
          <span id="tokenTimerText">Carregando...</span>
        </div>
      </div>
    </div>

    <!-- Resumo por período -->
    <div class="period-summary">
      <div class="period-card">
        <div class="period-icon week">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div class="period-label">Esta Semana</div>
        <div id="ganhoSemana" class="period-value">R$ 0,00</div>
      </div>

      <div class="period-card">
        <div class="period-icon month">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="period-label">Este Mês</div>
        <div id="ganhoMes" class="period-value">R$ 0,00</div>
      </div>

      <div class="period-card">
        <div class="period-icon debt">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="period-label">Dívida Atual</div>
        <div id="dividaTotal" class="period-value">R$ 0,00</div>
      </div>
    </div>

    <!-- Seção de transações -->
    <div class="section-header">
      <div class="section-title">
        <i class="fas fa-receipt"></i>
        Extrato
      </div>
      <div id="transactionsCount" class="section-subtitle">0 transações</div>
    </div>

    <div id="transactions" class="transactions">
      <!-- Transactions will be rendered here -->
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="empty-state hidden">
      <div class="empty-icon">
        <i class="fas fa-inbox"></i>
      </div>
      <div class="empty-title">Nenhuma transação encontrada</div>
      <div class="empty-text">Suas comissões aparecerão aqui</div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Detalhes do Pagamento</h2>
        <button class="modal-close" onclick="closePaymentModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-summary">
          <div class="modal-summary-row">
            <span class="modal-summary-label">Total de Lavagens</span>
            <span id="modalTotalOrdens" class="modal-summary-value">0</span>
          </div>
          <div class="modal-summary-row">
            <span class="modal-summary-label">Dívidas Descontadas</span>
            <span id="modalTotalAdiantamentos" class="modal-summary-value">R$ 0,00</span>
          </div>
          <div class="modal-summary-row">
            <span class="modal-summary-label">Valor Pago</span>
            <span id="modalValorPago" class="modal-summary-value total">R$ 0,00</span>
          </div>
        </div>

        <div class="modal-section-title">Lavagens Incluídas</div>
        <div id="modalOrdersList">
          <!-- Orders will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== UTILS ====================
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value || 0);
    }

    function formatDate(dateStr) {
      // Parse da data vinda do backend (já está em UTC)
      const date = new Date(dateStr);

      // Obter data/hora atual em São Paulo
      const formatter = new Intl.DateTimeFormat('pt-BR', {
        timeZone: 'America/Sao_Paulo',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      const todayParts = formatter.formatToParts(new Date());
      const todayYear = parseInt(todayParts.find(p => p.type === 'year').value);
      const todayMonth = parseInt(todayParts.find(p => p.type === 'month').value) - 1;
      const todayDay = parseInt(todayParts.find(p => p.type === 'day').value);

      // Converter data recebida para São Paulo
      const dateParts = formatter.formatToParts(date);
      const dateYear = parseInt(dateParts.find(p => p.type === 'year').value);
      const dateMonth = parseInt(dateParts.find(p => p.type === 'month').value) - 1;
      const dateDay = parseInt(dateParts.find(p => p.type === 'day').value);

      // Criar datas apenas com dia/mês/ano para comparação
      const dateOnly = new Date(dateYear, dateMonth, dateDay);
      const todayOnly = new Date(todayYear, todayMonth, todayDay);
      const yesterdayOnly = new Date(todayYear, todayMonth, todayDay - 1);

      console.log('[formatDate] Debug:', {
        input: dateStr,
        dateStr: `${dateDay}/${dateMonth+1}/${dateYear}`,
        todayStr: `${todayDay}/${todayMonth+1}/${todayYear}`,
        dateTime: dateOnly.getTime(),
        todayTime: todayOnly.getTime(),
        diff: (dateOnly.getTime() - todayOnly.getTime()) / (1000 * 60 * 60 * 24)
      });

      if (dateOnly.getTime() === todayOnly.getTime()) {
        return 'Hoje';
      } else if (dateOnly.getTime() === yesterdayOnly.getTime()) {
        return 'Ontem';
      } else {
        return date.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: 'long',
          timeZone: 'America/Sao_Paulo'
        });
      }
    }

    function toLocaleDateISOString(dateInput = new Date()) {
      // Converter para timezone de São Paulo
      const date = new Date(dateInput);
      const dateStr = date.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' });
      const dateBrasilia = new Date(dateStr);

      const year = dateBrasilia.getFullYear();
      const month = String(dateBrasilia.getMonth() + 1).padStart(2, '0');
      const day = String(dateBrasilia.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function toggleBalance() {
      const balanceEl = document.getElementById('saldoTotal');
      const eyeIcon = document.getElementById('balance-eye');

      balanceEl.classList.toggle('hidden-value');

      if (balanceEl.classList.contains('hidden-value')) {
        eyeIcon.className = 'fas fa-eye-slash';
      } else {
        eyeIcon.className = 'fas fa-eye';
      }
    }

    // ==================== MULTI-WASH LOGIC ====================
    function normalizeOrderWashers(order) {
      if (!order) return [];

      if (Array.isArray(order.ordemLavadores) && order.ordemLavadores.length > 0) {
        return order.ordemLavadores.map(ol => ({
          id: ol.lavador.id,
          nome: ol.lavador.nome,
          comissao: ol.lavador.comissao
        }));
      }

      if (order.lavadorId && order.lavador) {
        return [{
          id: order.lavadorId,
          nome: order.lavador.nome,
          comissao: order.lavador.comissao
        }];
      }

      return [];
    }

    function getCommissionPercent(order) {
      if (order?.lavador?.comissao) {
        return order.lavador.comissao;
      }
      if (order?.comissao && order?.valorTotal) {
        return (order.comissao / order.valorTotal) * 100;
      }
      return 0;
    }

    function getWasherShare(order, washerId, lavadorComissao) {
      const washers = normalizeOrderWashers(order);
      if (!washers.length || !washerId) return 0;

      if (washers.length === 1) {
        const percent = lavadorComissao || getCommissionPercent(order);
        return (order.valorTotal || 0) * (percent / 100);
      }

      const percent = lavadorComissao || getCommissionPercent(order);
      const totalCents = Math.round((order?.valorTotal || 0) * (percent / 100) * 100);
      if (totalCents <= 0) return 0;

      const base = Math.floor(totalCents / washers.length);
      let remainder = totalCents % washers.length;

      const shareMap = {};
      washers.forEach(washer => {
        let cents = base;
        if (remainder > 0) {
          cents += 1;
          remainder -= 1;
        }
        shareMap[washer.id] = cents / 100;
      });

      return shareMap[washerId] || 0;
    }

    function isMultiWash(order) {
      return Array.isArray(order.ordemLavadores) && order.ordemLavadores.length > 1;
    }

    // ==================== STATE ====================
    let lavadorData = null;
    let currentLavadorId = null;
    let tokenTimerInterval = null;

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', async () => {
      const token = new URLSearchParams(window.location.search).get('token');
      if (!token) {
        showError('Link Inválido', 'Por favor, use o link fornecido pelo administrador.', 'fa-link');
        return;
      }

      try {
        const data = await window.api.getLavadorPublico(token);
        if (data) {
          lavadorData = data;
          // Usar o lavadorId retornado pelo backend
          currentLavadorId = data.lavadorId;
          console.log('[lavador-publico] Dados carregados:', {
            lavadorId: currentLavadorId,
            nome: data.nome,
            ordens: data.ordens.length,
            fechamentos: data.fechamentos?.length || 0,
            adiantamentosNaoQuitados: data.adiantamentosNaoQuitados?.length || 0
          });
          renderUI();
        } else {
          showError();
        }
      } catch (e) {
        console.error('Erro na API:', e);
        if (e.error?.includes('inativo')) {
          showError('Acesso Desativado', 'Seu link foi desativado. Entre em contato com o administrador.', 'fa-user-lock');
        } else if (e.error?.includes('expirado')) {
          showError('Link Expirado', 'Seu link expirou. Solicite um novo link ao administrador.', 'fa-clock');
        } else {
          showError('Acesso Inválido', 'O link é inválido. Solicite um novo link ao administrador.', 'fa-ban');
        }
      }
    });

    // ==================== UI ====================
    function showError(title = 'Acesso Inválido', message = 'O link é inválido ou expirou.', icon = 'fa-ban') {
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-icon').className = `fas ${icon}`;
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
    }

    function renderUI() {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');

      document.getElementById('lavadorNome').textContent = lavadorData.nome;

      calculatePeriodSummary();
      renderTransactions();
      startTokenTimer();
    }

    // ==================== TOKEN TIMER ====================
    function startTokenTimer() {
      const timerEl = document.getElementById('tokenTimer');
      const timerTextEl = document.getElementById('tokenTimerText');

      if (!lavadorData.tokenExpiresAt) {
        // Token permanente
        timerEl.classList.remove('hidden');
        timerEl.classList.add('permanent');
        timerTextEl.innerHTML = '<i class="fas fa-infinity"></i> Link Permanente';
        return;
      }

      timerEl.classList.remove('hidden');

      function updateTimer() {
        const now = new Date();
        const expiresAt = new Date(lavadorData.tokenExpiresAt);
        const diff = expiresAt.getTime() - now.getTime();

        if (diff <= 0) {
          timerTextEl.textContent = 'Link expirado';
          timerEl.classList.add('expiring-soon');
          clearInterval(tokenTimerInterval);
          // Mostrar mensagem de expiração
          setTimeout(() => {
            showError('Link Expirado', 'Este link expirou. Solicite um novo link ao administrador.', 'fa-clock');
          }, 1000);
          return;
        }

        // Calcular tempo restante
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        let text = '';
        if (hours > 0) {
          text = `Expira em ${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          text = `Expira em ${minutes}m ${seconds}s`;
        } else {
          text = `Expira em ${seconds}s`;
        }

        timerTextEl.textContent = text;

        // Adicionar classe de alerta se falta menos de 1 hora
        if (diff < 60 * 60 * 1000) {
          timerEl.classList.add('expiring-soon');
        }
      }

      updateTimer();
      tokenTimerInterval = setInterval(updateTimer, 1000);
    }

    function calculatePeriodSummary() {
      const now = new Date();
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0, 0, 0, 0);

      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

      let ganhoSemana = 0;
      let ganhoMes = 0;
      let totalCreditos = 0;

      // Calcular ganhos das ordens
      lavadorData.ordens.forEach(ordem => {
        if (['FINALIZADO', 'EM_ANDAMENTO', 'AGUARDANDO_PAGAMENTO'].includes(ordem.status)) {
          const ganho = getWasherShare(ordem, currentLavadorId, lavadorData.comissao);
          const ordemDate = new Date(ordem.createdAt);

          totalCreditos += ganho;

          if (ordemDate >= weekStart) {
            ganhoSemana += ganho;
          }
          if (ordemDate >= monthStart) {
            ganhoMes += ganho;
          }
        }
      });

      // Calcular dívida total (adiantamentos não quitados)
      let dividaTotal = 0;
      if (lavadorData.adiantamentosNaoQuitados) {
        dividaTotal = lavadorData.adiantamentosNaoQuitados.reduce((sum, a) => sum + a.valor, 0);
      }

      // Saldo é apenas os créditos (não descontamos nada aqui, pois só mostramos pagamentos já feitos)
      const saldoTotal = totalCreditos;

      document.getElementById('ganhoSemana').textContent = formatCurrency(ganhoSemana);
      document.getElementById('ganhoMes').textContent = formatCurrency(ganhoMes);
      document.getElementById('dividaTotal').textContent = formatCurrency(dividaTotal);
      document.getElementById('saldoTotal').textContent = formatCurrency(saldoTotal);

      console.log('[calculatePeriodSummary]', {
        ganhoSemana,
        ganhoMes,
        dividaTotal,
        saldoTotal
      });
    }

    function renderTransactions() {
      const container = document.getElementById('transactions');
      const emptyState = document.getElementById('emptyState');

      const transactions = [];

      // Adicionar ordens como créditos
      lavadorData.ordens.forEach(ordem => {
        if (['FINALIZADO', 'EM_ANDAMENTO', 'AGUARDANDO_PAGAMENTO'].includes(ordem.status)) {
          const ganho = getWasherShare(ordem, currentLavadorId, lavadorData.comissao);

          if (ganho > 0) {
            transactions.push({
              type: 'credit',
              date: ordem.createdAt,
              title: ordem.veiculo?.modelo || 'Veículo',
              subtitle: ordem.items.map(i => i.servico?.nome || i.adicional?.nome).filter(Boolean).join(', '),
              value: ganho,
              status: ordem.status,
              isMultiWash: isMultiWash(ordem),
              washersCount: normalizeOrderWashers(ordem).length
            });
          }
        }
      });

      // Adicionar fechamentos de comissão como "Pagamento Realizado"
      if (lavadorData.fechamentos && lavadorData.fechamentos.length > 0) {
        lavadorData.fechamentos.forEach(fechamento => {
          const totalOrdens = (fechamento.ordensPagas?.length || 0) + (fechamento.ordemLavadoresPagos?.length || 0);

          transactions.push({
            type: 'payment',
            date: fechamento.data,
            title: 'Pagamento Realizado',
            subtitle: `${totalOrdens} lavagen${totalOrdens === 1 ? '' : 's'}`,
            value: fechamento.valorPago,
            clickable: true,
            fechamentoData: fechamento
          });
        });
      }

      transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

      document.getElementById('transactionsCount').textContent =
        `${transactions.length} transaç${transactions.length === 1 ? 'ão' : 'ões'}`;

      if (transactions.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      emptyState.classList.add('hidden');

      const groupedByDay = {};
      transactions.forEach(t => {
        const dayKey = toLocaleDateISOString(t.date);
        if (!groupedByDay[dayKey]) {
          groupedByDay[dayKey] = [];
        }
        groupedByDay[dayKey].push(t);
      });

      container.innerHTML = '';
      Object.keys(groupedByDay).sort((a, b) => b.localeCompare(a)).forEach(dayKey => {
        const dayTransactions = groupedByDay[dayKey];

        const dayDiv = document.createElement('div');
        dayDiv.className = 'transaction-day';

        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        dayHeader.textContent = formatDate(dayKey);
        dayDiv.appendChild(dayHeader);

        dayTransactions.forEach(t => {
          const item = document.createElement('div');
          item.className = `transaction-item ${t.type}`;

          if (t.clickable) {
            item.classList.add('clickable');
            item.onclick = () => openPaymentModal(t.fechamentoData);
          }

          let icon = '';
          if (t.type === 'credit') {
            icon = '<i class="fas fa-arrow-down"></i>';
          } else if (t.type === 'payment') {
            icon = '<i class="fas fa-dollar-sign"></i>';
          }

          const badges = [];
          if (t.isMultiWash) {
            badges.push(`<span class="badge multi-wash-badge"><i class="fas fa-users"></i> ${t.washersCount}x</span>`);
          }
          if (t.status) {
            const statusText = t.status.replace('_', ' ');
            badges.push(`<span class="badge status-badge ${t.status}">${statusText}</span>`);
          }

          const valuePrefix = t.type === 'credit' ? '+' : '';
          const valueClass = t.type === 'payment' ? 'payment' : t.type;

          item.innerHTML = `
            <div class="transaction-icon ${t.type}">
              ${icon}
            </div>
            <div class="transaction-details">
              <div class="transaction-title">
                ${t.title}
                ${badges.join(' ')}
              </div>
              <div class="transaction-subtitle">${t.subtitle}</div>
            </div>
            <div class="transaction-value ${valueClass}">
              ${valuePrefix} ${formatCurrency(t.value)}
            </div>
          `;

          dayDiv.appendChild(item);
        });

        container.appendChild(dayDiv);
      });
    }

    // ==================== MODAL ====================
    function openPaymentModal(fechamento) {
      const modal = document.getElementById('paymentModal');

      console.log('[openPaymentModal] Fechamento completo:', fechamento);
      console.log('[openPaymentModal] adiantamentosQuitados:', fechamento.adiantamentosQuitados);

      // Calcular totais
      const totalOrdens = (fechamento.ordensPagas?.length || 0) + (fechamento.ordemLavadoresPagos?.length || 0);

      // Calcular total de adiantamentos quitados
      let totalAdiantamentos = 0;
      if (fechamento.adiantamentosQuitados && Array.isArray(fechamento.adiantamentosQuitados)) {
        totalAdiantamentos = fechamento.adiantamentosQuitados.reduce((sum, a) => {
          console.log('[modal] Adiantamento:', a);
          return sum + (a.valor || 0);
        }, 0);
      }

      console.log('[openPaymentModal] Total adiantamentos calculado:', totalAdiantamentos);

      document.getElementById('modalTotalOrdens').textContent = totalOrdens;
      document.getElementById('modalTotalAdiantamentos').textContent = formatCurrency(totalAdiantamentos);
      document.getElementById('modalValorPago').textContent = formatCurrency(fechamento.valorPago);

      console.log('[openPaymentModal] Totais finais:', {
        totalOrdens,
        totalAdiantamentos,
        valorPago: fechamento.valorPago
      });

      // Renderizar ordens
      const ordersList = document.getElementById('modalOrdersList');
      ordersList.innerHTML = '';

      let totalComissaoCalculada = 0;

      // Ordens principais (onde o lavador é o principal)
      if (fechamento.ordensPagas && Array.isArray(fechamento.ordensPagas)) {
        fechamento.ordensPagas.forEach(ordem => {
          console.log('[modal] Ordem principal:', ordem);

          // Para ordens principais, o lavador é o principal da ordem
          // Calcular a comissão usando o valorTotal e a comissão do lavador
          let comissao = 0;

          // Se a ordem tem ordemLavadores (multi-wash), calcular divisão
          if (Array.isArray(ordem.ordemLavadores) && ordem.ordemLavadores.length > 0) {
            comissao = getWasherShare(ordem, currentLavadorId, lavadorData.comissao);
          } else {
            // Ordem solo - lavador principal ganha comissão total
            comissao = (ordem.valorTotal || 0) * ((lavadorData.comissao || 0) / 100);
          }

          totalComissaoCalculada += comissao;

          const services = ordem.items?.map(i => i.servico?.nome || i.adicional?.nome).filter(Boolean).join(', ') || 'Sem serviços';
          const isMulti = Array.isArray(ordem.ordemLavadores) && ordem.ordemLavadores.length > 1;

          console.log('[modal] Ordem comissão calculada:', comissao);

          ordersList.innerHTML += `
            <div class="modal-order-item">
              <div class="modal-order-header">
                <div class="modal-order-title">${ordem.veiculo?.modelo || 'Veículo'}</div>
                <div class="modal-order-value">${formatCurrency(comissao)}</div>
              </div>
              <div class="modal-order-services">${services}</div>
              <div class="modal-order-meta">
                ${isMulti ? `<span class="badge multi-wash-badge"><i class="fas fa-users"></i> ${ordem.ordemLavadores.length}x</span>` : ''}
                <span class="badge status-badge FINALIZADO">FINALIZADO</span>
              </div>
            </div>
          `;
        });
      }

      // Ordens multi-wash (onde o lavador é secundário)
      if (fechamento.ordemLavadoresPagos && Array.isArray(fechamento.ordemLavadoresPagos)) {
        fechamento.ordemLavadoresPagos.forEach(ol => {
          console.log('[modal] Ordem multi-wash:', ol);

          const ordem = ol.ordem;

          // Calcular comissão dividida
          const comissao = getWasherShare(ordem, currentLavadorId, lavadorData.comissao);
          totalComissaoCalculada += comissao;

          const services = ordem.items?.map(i => i.servico?.nome || i.adicional?.nome).filter(Boolean).join(', ') || 'Sem serviços';
          const washersCount = normalizeOrderWashers(ordem).length;

          console.log('[modal] Multi-wash comissão calculada:', comissao);

          ordersList.innerHTML += `
            <div class="modal-order-item">
              <div class="modal-order-header">
                <div class="modal-order-title">${ordem.veiculo?.modelo || 'Veículo'}</div>
                <div class="modal-order-value">${formatCurrency(comissao)}</div>
              </div>
              <div class="modal-order-services">${services}</div>
              <div class="modal-order-meta">
                <span class="badge multi-wash-badge"><i class="fas fa-users"></i> ${washersCount}x</span>
                <span class="badge status-badge FINALIZADO">FINALIZADO</span>
              </div>
            </div>
          `;
        });
      }

      console.log('[modal] Total comissão calculada:', totalComissaoCalculada);

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closePaymentModal() {
      const modal = document.getElementById('paymentModal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Fechar modal ao clicar fora
    document.getElementById('paymentModal').addEventListener('click', (e) => {
      if (e.target.id === 'paymentModal') {
        closePaymentModal();
      }
    });
  </script>
<script src="mobile-nav.js"></script>
<script src="webapp-bottom-nav.js"></script>
<nav class="bottom-navigation">
    <a href="index.html" class="bottom-nav-item" data-page="home" title="Dashboard">
        <i class="fas fa-home"></i>
        <span>Início</span>
    </a>
    <a href="ordens.html" class="bottom-nav-item" data-page="ordens" title="Minhas Ordens">
        <i class="fas fa-list-check"></i>
        <span>Ordens</span>
    </a>
    <a href="novaordem.html" class="bottom-nav-item" data-page="novaordem" title="Nova Ordem">
        <i class="fas fa-plus-circle"></i>
        <span>Nova</span>
    </a>
    <a href="clientes.html" class="bottom-nav-item" data-page="clientes" title="Clientes">
        <i class="fas fa-users"></i>
        <span>Clientes</span>
    </a>
    <a href="#" class="bottom-nav-item" data-page="menu" onclick="toggleMobileMenu(event)" title="Menu">
        <i class="fas fa-bars"></i>
        <span>Menu</span>
    </a>
</nav>
</body>
</html>
