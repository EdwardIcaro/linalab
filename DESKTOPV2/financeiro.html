<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinaX - Financeiro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
    <style>
        /* ==========================================
           CSS VARIABLES - Finance Theme
           ========================================== */
        :root {
            --finance-bg: #f8fafc;
            --finance-card: #ffffff;
            --finance-border: #e2e8f0;
            --finance-shadow: 0 1px 3px rgba(0,0,0,0.08);
            --finance-shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --finance-text: #1e293b;
            --finance-text-secondary: #64748b;
            --finance-text-muted: #94a3b8;

            /* Finance Colors */
            --finance-green: #10b981;
            --finance-green-light: rgba(16, 185, 129, 0.1);
            --finance-red: #ef4444;
            --finance-red-light: rgba(239, 68, 68, 0.1);
            --finance-blue: #3b82f6;
            --finance-blue-light: rgba(59, 130, 246, 0.1);
            --finance-orange: #f59e0b;
            --finance-orange-light: rgba(245, 158, 11, 0.1);
            --finance-purple: #8b5cf6;
            --finance-purple-light: rgba(139, 92, 246, 0.1);
            --finance-cyan: #06b6d4;
            --finance-cyan-light: rgba(6, 182, 212, 0.1);

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        /* Alpine cloak */
        [x-cloak] { display: none !important; }

        /* ==========================================
           LAYOUT
           ========================================== */
        .finance-container {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ==========================================
           BALANCE HERO
           ========================================== */
        .balance-hero {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 1100px) {
            .balance-hero { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .balance-hero { grid-template-columns: 1fr; }
        }

        .balance-card {
            background: var(--finance-card);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            border: 1px solid var(--finance-border);
            box-shadow: var(--finance-shadow);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .balance-card.green::before { background: var(--finance-green); }
        .balance-card.red::before { background: var(--finance-red); }
        .balance-card.blue::before { background: var(--finance-blue); }
        .balance-card.orange::before { background: var(--finance-orange); }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .balance-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .balance-card.green .balance-icon { background: var(--finance-green-light); color: var(--finance-green); }
        .balance-card.red .balance-icon { background: var(--finance-red-light); color: var(--finance-red); }
        .balance-card.blue .balance-icon { background: var(--finance-blue-light); color: var(--finance-blue); }
        .balance-card.orange .balance-icon { background: var(--finance-orange-light); color: var(--finance-orange); }

        .balance-label {
            font-size: 13px;
            color: var(--finance-text-secondary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .balance-value {
            font-size: 28px;
            font-weight: 700;
        }

        .balance-card.green .balance-value { color: var(--finance-green); }
        .balance-card.red .balance-value { color: var(--finance-red); }
        .balance-card.blue .balance-value { color: var(--finance-blue); }
        .balance-card.orange .balance-value { color: var(--finance-orange); }

        .balance-breakdown {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--finance-border);
            font-size: 12px;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--finance-text-secondary);
        }

        .breakdown-item i {
            font-size: 10px;
        }

        /* ==========================================
           TABS NAVIGATION
           ========================================== */
        .tabs-container {
            background: var(--finance-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--finance-border);
            box-shadow: var(--finance-shadow);
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid var(--finance-border);
            padding: 0 24px;
            background: var(--finance-bg);
        }

        .tabs-extra-actions {
            display: flex;
            justify-content: flex-end;
            padding: 16px 24px;
            background: #fff;
            border-bottom: 1px solid var(--finance-border);
        }

        .tab-btn {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--finance-text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: var(--finance-text);
        }

        .tab-btn.active {
            color: var(--finance-cyan);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--finance-cyan);
            border-radius: 3px 3px 0 0;
        }

        .tab-btn i {
            font-size: 16px;
        }

        .tabs-content {
            padding: 24px;
        }

        /* ==========================================
           FILTERS BAR
           ========================================== */
        .filters-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-presets {
            display: flex;
            gap: 8px;
        }

        .preset-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            background: var(--finance-bg);
            border: 1px solid var(--finance-border);
            color: var(--finance-text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover, .preset-btn.active {
            background: var(--finance-cyan-light);
            border-color: var(--finance-cyan);
            color: var(--finance-cyan);
        }

        .filter-input {
            padding: 10px 14px;
            border: 1px solid var(--finance-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--finance-card);
            color: var(--finance-text);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--finance-cyan);
        }

        .filter-select {
            padding: 10px 14px;
            border: 1px solid var(--finance-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--finance-card);
            color: var(--finance-text);
            min-width: 150px;
        }

        .filter-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        /* ==========================================
           TRANSACTION TABLE
           ========================================== */
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transactions-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--finance-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--finance-bg);
            border-bottom: 1px solid var(--finance-border);
        }

        .transactions-table td {
            padding: 16px;
            font-size: 14px;
            color: var(--finance-text);
            border-bottom: 1px solid var(--finance-border);
        }

        .transactions-table tr:last-child td {
            border-bottom: none;
        }

        .transactions-table tr:hover {
            background: var(--finance-bg);
        }

        /* Transaction Type Badge */
        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-badge.entrada { background: var(--finance-green-light); color: var(--finance-green); }
        .type-badge.saida { background: var(--finance-red-light); color: var(--finance-red); }
        .type-badge.sangria { background: var(--finance-orange-light); color: var(--finance-orange); }
        .type-badge.fechamento { background: var(--finance-blue-light); color: var(--finance-blue); }
        .type-badge.pendente { background: var(--finance-purple-light); color: var(--finance-purple); }

        /* Value Colors */
        .value-positive { color: var(--finance-green); font-weight: 600; }
        .value-negative { color: var(--finance-red); font-weight: 600; }
        .value-pending { color: var(--finance-purple); font-weight: 600; }

        /* Action Buttons */
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--finance-text-secondary);
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--finance-bg);
        }

        .action-btn.edit:hover { color: var(--finance-blue); }
        .action-btn.delete:hover { color: var(--finance-red); }
        .action-btn.view:hover { color: var(--finance-cyan); }

        /* ==========================================
           CAIXA (REGISTER) TAB
           ========================================== */
        .register-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 32px;
            background: linear-gradient(135deg, var(--finance-green) 0%, #059669 100%);
            border-radius: var(--radius-lg);
            color: white;
            margin-bottom: 24px;
        }

        .register-status.closed {
            background: linear-gradient(135deg, var(--finance-red) 0%, #dc2626 100%);
        }

        .register-status-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .register-status-text h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .register-status-text p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* Register Actions Grid */
        .register-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .register-actions { grid-template-columns: 1fr; }
        }

        .register-action-card {
            background: var(--finance-card);
            border: 2px solid var(--finance-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .register-action-card:hover {
            border-color: var(--finance-cyan);
            transform: translateY(-2px);
        }

        .register-action-card i {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .register-action-card.sangria i { color: var(--finance-orange); }
        .register-action-card.suprimento i { color: var(--finance-green); }
        .register-action-card.fechar i { color: var(--finance-red); }

        .register-action-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--finance-text);
            margin-bottom: 4px;
        }

        .register-action-card p {
            font-size: 13px;
            color: var(--finance-text-secondary);
        }

        /* Payment Methods Summary */
        .payment-methods-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .payment-methods-grid { grid-template-columns: 1fr; }
        }

        .payment-method-card {
            background: var(--finance-bg);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
        }

        .payment-method-card i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--finance-cyan);
        }

        .payment-method-card .label {
            font-size: 13px;
            color: var(--finance-text-secondary);
            margin-bottom: 4px;
        }

        .payment-method-card .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--finance-green);
        }

        /* ==========================================
           MODALS
           ========================================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: var(--finance-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--finance-shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.wide {
            max-width: 700px;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--finance-border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--finance-text);
        }

        .modal-title i {
            color: var(--finance-cyan);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--finance-bg);
            cursor: pointer;
            font-size: 18px;
            color: var(--finance-text-secondary);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--finance-red-light);
            color: var(--finance-red);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--finance-text);
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--finance-border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            background: var(--finance-card);
            color: var(--finance-text);
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--finance-cyan);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 480px) {
            .form-row { grid-template-columns: 1fr; }
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--finance-border);
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--finance-bg);
            color: var(--finance-text);
            border: 1px solid var(--finance-border);
        }

        .btn-secondary:hover {
            background: var(--finance-border);
        }

        .btn-primary {
            background: var(--finance-cyan);
            color: white;
        }

        .btn-primary:hover {
            background: #0891b2;
        }

        .btn-danger {
            background: var(--finance-red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Fechamento Summary */
        .fechamento-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .fechamento-item {
            background: var(--finance-bg);
            padding: 16px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .fechamento-item .label {
            font-size: 12px;
            color: var(--finance-text-secondary);
            margin-bottom: 4px;
        }

        .fechamento-item .value {
            font-size: 20px;
            font-weight: 700;
        }

        .fechamento-item .value.positive { color: var(--finance-green); }
        .fechamento-item .value.negative { color: var(--finance-red); }

        .fechamento-total {
            background: linear-gradient(135deg, var(--finance-cyan) 0%, #0891b2 100%);
            padding: 20px;
            border-radius: var(--radius-md);
            text-align: center;
            color: white;
        }

        .fechamento-total .label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .fechamento-total .value {
            font-size: 28px;
            font-weight: 700;
        }

        /* ==========================================
           SKELETON LOADERS
           ========================================== */
        .skeleton {
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            background: linear-gradient(90deg, var(--finance-border) 25%, var(--finance-bg) 50%, var(--finance-border) 75%);
            background-size: 200% 100%;
            border-radius: 6px;
        }

        @keyframes skeleton-pulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid var(--finance-border);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--finance-text-muted);
        }

        .empty-state i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        .empty-state h4 {
            font-size: 16px;
            color: var(--finance-text-secondary);
            margin-bottom: 8px;
        }

        /* Spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body id="financeiro-page" data-permission="ver_financeiro">
    <!-- Screen Lock Modal -->
    <div id="screenLockModal" class="screen-lock-overlay">
        <div class="screen-lock-content">
            <i class="fas fa-lock screen-lock-icon"></i>
            <h2>Acesso Negado</h2>
            <p>Voce nao tem permissao para visualizar esta pagina. Redirecionando...</p>
        </div>
    </div>

    <!-- Navigation Menu -->
    <nav class="nav-menu-card" style="margin: 32px;">
        <a href="index.html" class="nav-menu-item" data-permission="ver_dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="ordens.html" class="nav-menu-item" data-permission="gerenciar_ordens">
            <i class="fas fa-list-alt"></i>
            <span>Ordens</span>
        </a>
        <a href="novaordem.html" class="nav-menu-item" data-permission="gerenciar_ordens">
            <i class="fas fa-plus-circle"></i>
            <span>Nova Ordem</span>
        </a>
        <a href="clientes.html" class="nav-menu-item" data-permission="gerenciar_clientes">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
        <a href="funcionarios.html" class="nav-menu-item" data-permission="gerenciar_funcionarios">
            <i class="fas fa-user-tie"></i>
            <span>Funcionários</span>
        </a>
        <a href="financeiro.html" class="nav-menu-item active" data-permission="ver_financeiro">
            <i class="fas fa-chart-pie"></i>
            <span>Financeiro</span>
        </a>
        <a href="configuracoes.html" class="nav-menu-item" data-permission="gerenciar_configuracoes">
            <i class="fas fa-cog"></i>
            <span>Configurações</span>
        </a>
    </nav>

    <!-- Main Finance Dashboard -->
    <main class="main-content" x-data="financeDashboard()" x-init="init()" x-cloak @keydown.window.escape.prevent="handleEscape()">
        <div class="finance-container">
            <!-- Balance Cards -->
            <section class="balance-hero">
                <!-- Total Revenue -->
                <div class="balance-card green">
                    <div class="balance-header">
                        <div class="balance-icon">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="balance-label">Total Recebido</div>
                    <template x-if="isLoading">
                        <div class="skeleton" style="height: 32px; width: 120px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="balance-value" x-text="formatCurrency(balance.totalReceived)"></div>
                    </template>
                    <div class="balance-breakdown" x-show="!isLoading">
                        <div class="breakdown-item">
                            <i class="fas fa-money-bill"></i>
                            <span x-text="formatCurrency(balance.cash)"></span>
                        </div>
                        <div class="breakdown-item">
                            <i class="fas fa-credit-card"></i>
                            <span x-text="formatCurrency(balance.card)"></span>
                        </div>
                        <div class="breakdown-item">
                            <i class="fas fa-qrcode"></i>
                            <span x-text="formatCurrency(balance.pix)"></span>
                        </div>
                    </div>
                </div>

                <!-- Total Expenses -->
                <div class="balance-card red">
                    <div class="balance-header">
                        <div class="balance-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="balance-label">Total de Saidas</div>
                    <template x-if="isLoading">
                        <div class="skeleton" style="height: 32px; width: 100px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="balance-value" x-text="formatCurrency(balance.totalExpenses)"></div>
                    </template>
                    <div class="balance-breakdown" x-show="!isLoading">
                        <div class="breakdown-item">
                            <span>Despesas: </span>
                            <span x-text="formatCurrency(balance.expenses)"></span>
                        </div>
                        <div class="breakdown-item">
                            <span>Sangrias: </span>
                            <span x-text="formatCurrency(balance.sangrias)"></span>
                        </div>
                    </div>
                </div>

                <!-- Net Balance -->
                <div class="balance-card blue">
                    <div class="balance-header">
                        <div class="balance-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="balance-label">Saldo Liquido</div>
                    <template x-if="isLoading">
                        <div class="skeleton" style="height: 32px; width: 100px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="balance-value" x-text="formatCurrency(balance.netBalance)"></div>
                    </template>
                </div>

                <!-- Pending -->
                <div class="balance-card orange">
                    <div class="balance-header">
                        <div class="balance-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="balance-label">Pendencias</div>
                    <template x-if="isLoading">
                        <div class="skeleton" style="height: 32px; width: 80px;"></div>
                    </template>
                    <template x-if="!isLoading">
                        <div class="balance-value" x-text="formatCurrency(balance.pending)"></div>
                    </template>
                </div>
            </section>

            <!-- Tabs Container -->
            <section class="tabs-container">
                <!-- Tabs Header -->
                <div class="tabs-header">
                    <button
                        class="tab-btn"
                        :class="{ 'active': activeTab === 'movimentacoes' }"
                        @click="activeTab = 'movimentacoes'"
                    >
                        <i class="fas fa-exchange-alt"></i>
                        <span>Movimentacoes</span>
                    </button>
                    <button
                        class="tab-btn"
                        :class="{ 'active': activeTab === 'caixa' }"
                        @click="activeTab = 'caixa'"
                    >
                        <i class="fas fa-cash-register"></i>
                        <span>Controle de Caixa</span>
                    </button>
                    <button
                        class="tab-btn"
                        :class="{ 'active': activeTab === 'pendencias' }"
                        @click="activeTab = 'pendencias'; loadPendencias()"
                    >
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Pendencias</span>
                        <span
                            x-show="pendenciasCount > 0"
                            class="type-badge pendente"
                            style="padding: 2px 8px; font-size: 11px;"
                            x-text="pendenciasCount"
                        ></span>
                    </button>
                </div>

                <div class="tabs-extra-actions">
                    <a href="comissoes.html" class="btn btn-primary">
                        <i class="fas fa-coins"></i>
                        Ver comissões
                    </a>
                </div>

                <!-- Tabs Content -->
                <div class="tabs-content">
                    <!-- TAB 1: Movimentacoes -->
                    <div x-show="activeTab === 'movimentacoes'" x-transition>
                        <!-- Filters -->
                        <div class="filters-bar">
                            <div class="filter-presets">
                                <button
                                    class="preset-btn"
                                    :class="{ 'active': datePreset === 'today' }"
                                    @click="applyDatePreset('today')"
                                >Hoje</button>
                                <button
                                    class="preset-btn"
                                    :class="{ 'active': datePreset === 'week' }"
                                    @click="applyDatePreset('week')"
                                >Esta Semana</button>
                                <button
                                    class="preset-btn"
                                    :class="{ 'active': datePreset === 'month' }"
                                    @click="applyDatePreset('month')"
                                >Este Mes</button>
                            </div>

                            <select class="filter-select" x-model="filters.tipo" @change="loadTransactions()">
                                <option value="">Todos os Tipos</option>
                                <option value="PAGAMENTO">Pagamento (Entrada)</option>
                                <option value="SAIDA">Saida</option>
                                <option value="SANGRIA">Sangria</option>
                                <option value="PENDENTE">Pendencia</option>
                                <option value="FECHAMENTO">Fechamento</option>
                            </select>

                            <input
                                type="date"
                                class="filter-input"
                                x-model="filters.dataInicio"
                                @change="loadTransactions()"
                            >
                            <span style="color: var(--finance-text-secondary);">ate</span>
                            <input
                                type="date"
                                class="filter-input"
                                x-model="filters.dataFim"
                                @change="loadTransactions()"
                            >

                            <div class="filter-actions">
                                <button id="btn-enter-expense" class="btn btn-secondary" type="button" @click="openTransactionModal('saida')">
                                    <i class="fas fa-arrow-up"></i>
                                    Lancar Despesa
                                </button>
                            </div>
                        </div>

                        <!-- Transactions Table -->
                        <div style="overflow-x: auto;">
                            <!-- Loading State -->
                            <template x-if="isLoadingTransactions">
                                <div>
                                    <template x-for="i in 5" :key="'skel-' + i">
                                        <div class="skeleton-row">
                                            <div class="skeleton" style="height: 16px; width: 100px;"></div>
                                            <div class="skeleton" style="height: 24px; width: 80px;"></div>
                                            <div class="skeleton" style="height: 16px; width: 200px;"></div>
                                            <div class="skeleton" style="height: 16px; width: 80px;"></div>
                                            <div class="skeleton" style="height: 16px; width: 100px;"></div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Empty State -->
                            <template x-if="!isLoadingTransactions && transactions.length === 0">
                                <div class="empty-state">
                                    <i class="fas fa-receipt"></i>
                                    <h4>Nenhuma movimentacao encontrada</h4>
                                    <p>Ajuste os filtros ou registre uma nova transacao.</p>
                                </div>
                            </template>

                            <!-- Table -->
                            <table class="transactions-table" x-show="!isLoadingTransactions && transactions.length > 0">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Descricao</th>
                                        <th>Forma Pag.</th>
                                        <th style="text-align: right;">Valor</th>
                                        <th style="width: 100px;">Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="tx in transactions" :key="tx.id">
                                        <tr>
                                            <td x-text="formatDateTime(tx.data)"></td>
                                            <td>
                                                <span
                                                    class="type-badge"
                                                    :class="getTypeBadgeClass(tx.tipo)"
                                                    x-text="getTypeLabel(tx.tipo, tx.formaPagamento)"
                                                ></span>
                                            </td>
                                            <td x-text="tx.descricao"></td>
                                            <td x-text="tx.formaPagamento || 'N/A'"></td>
                                            <td style="text-align: right;">
                                                <span
                                                    :class="getValueClass(tx.tipo)"
                                                    x-text="(tx.tipo === 'PAGAMENTO' ? '+ ' : tx.tipo === 'PENDENTE' ? '' : '- ') + formatCurrency(tx.valor)"
                                                ></span>
                                            </td>
                                            <td>
                                                <template x-if="tx.ordemId">
                                                    <a :href="'ordens.html?id=' + tx.ordemId" class="action-btn view" title="Ver Ordem">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </template>
                                                <template x-if="tx.tipo === 'SAIDA'">
                                                    <button class="action-btn edit" @click="openEditModal(tx)" title="Editar">
                                                        <i class="fas fa-pencil-alt"></i>
                                                    </button>
                                                </template>
                                                <template x-if="tx.tipo === 'SAIDA'">
                                                    <button class="action-btn delete" @click="deleteTransaction(tx.id)" title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 2: Controle de Caixa -->
                    <div x-show="activeTab === 'caixa'" x-transition>
                        <!-- Register Status -->
                        <div class="register-status" :class="{ 'closed': !isRegisterOpen }">
                            <div class="register-status-icon">
                                <i :class="isRegisterOpen ? 'fas fa-lock-open' : 'fas fa-lock'"></i>
                            </div>
                            <div class="register-status-text">
                                <h3 x-text="isRegisterOpen ? 'Caixa Aberto' : 'Caixa Fechado'"></h3>
                                <p x-text="isRegisterOpen ? 'O caixa esta operando normalmente' : 'O caixa de hoje foi fechado'"></p>
                            </div>
                        </div>

                        <!-- Register Actions -->
                        <div class="register-actions">
                            <button id="btn-sangria" type="button" class="register-action-card sangria" @click="openTransactionModal('sangria')">
                                <i class="fas fa-arrow-down"></i>
                                <h4>Sangria</h4>
                                <p>Retirar dinheiro do caixa</p>
                            </button>
                            <button id="btn-suprimento" type="button" class="register-action-card suprimento" @click="openTransactionModal('suprimento')">
                                <i class="fas fa-arrow-up"></i>
                                <h4>Suprimento</h4>
                                <p>Adicionar troco ao caixa</p>
                            </button>
                            <button id="btn-fechar-caixa" type="button" class="register-action-card fechar" @click="openFechamentoModal()">
                                <i class="fas fa-door-closed"></i>
                                <h4>Fechar Caixa</h4>
                                <p>Encerrar o dia de trabalho</p>
                            </button>
                        </div>

                        <!-- Today's Summary -->
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--finance-text);">
                            <i class="fas fa-chart-bar" style="color: var(--finance-cyan); margin-right: 8px;"></i>
                            Resumo do Dia
                        </h3>

                        <div class="payment-methods-grid">
                            <div class="payment-method-card">
                                <i class="fas fa-money-bill-wave"></i>
                                <div class="label">Dinheiro</div>
                                <div class="value" x-text="formatCurrency(daySummary.dinheiro)"></div>
                            </div>
                            <div class="payment-method-card">
                                <i class="fas fa-credit-card"></i>
                                <div class="label">Cartao</div>
                                <div class="value" x-text="formatCurrency(daySummary.cartao)"></div>
                            </div>
                            <div class="payment-method-card">
                                <i class="fas fa-qrcode"></i>
                                <div class="label">PIX</div>
                                <div class="value" x-text="formatCurrency(daySummary.pix)"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: Pendencias -->
                    <div x-show="activeTab === 'pendencias'" x-transition>
                        <!-- Loading -->
                        <template x-if="isLoadingPendencias">
                            <div>
                                <template x-for="i in 3" :key="'pend-skel-' + i">
                                    <div class="skeleton-row">
                                        <div class="skeleton" style="height: 16px; width: 150px;"></div>
                                        <div class="skeleton" style="height: 16px; width: 100px;"></div>
                                        <div class="skeleton" style="height: 16px; width: 80px;"></div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Empty -->
                        <template x-if="!isLoadingPendencias && pendencias.length === 0">
                            <div class="empty-state">
                                <i class="fas fa-check-circle" style="color: var(--finance-green);"></i>
                                <h4>Nenhuma pendencia!</h4>
                                <p>Todas as ordens foram pagas corretamente.</p>
                            </div>
                        </template>

                        <!-- Pendencias Table -->
                        <table class="transactions-table" x-show="!isLoadingPendencias && pendencias.length > 0">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Veiculo</th>
                                    <th>Data</th>
                                    <th style="text-align: right;">Valor</th>
                                    <th>Acao</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="pend in pendencias" :key="pend.id">
                                    <tr>
                                        <td x-text="pend.cliente?.nome || 'N/A'"></td>
                                        <td x-text="pend.veiculo?.placa || 'N/A'"></td>
                                        <td x-text="formatDate(pend.dataFinalizado || pend.createdAt)"></td>
                                        <td style="text-align: right;" class="value-pending" x-text="formatCurrency(pend.valorTotal)"></td>
                                        <td>
                                            <a :href="'ordens.html?id=' + pend.id" class="btn btn-primary" style="padding: 8px 16px;">
                                                Ver Ordem
                                            </a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- ==========================================
             MODALS
             ========================================== -->

        <!-- Transaction Modal (Saida/Sangria/Suprimento) -->
        <div
            class="modal-overlay"
            :class="{ active: transactionModal.isOpen }"
            x-show="transactionModal.isOpen"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            @click.self="closeTransactionModal()"
        >
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i :class="getTransactionModalIcon()"></i>
                        <span x-text="getTransactionModalTitle()"></span>
                    </h2>
                    <button type="button" class="modal-close" @click="closeTransactionModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form @submit.prevent="saveTransaction()">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor *</label>
                            <input
                                type="number"
                                step="0.01"
                                class="form-input"
                                x-model="transactionModal.valor"
                                required
                                x-ref="transactionValor"
                            >
                        </div>
                        <div class="form-group" x-show="transactionModal.type === 'saida'">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" x-model="transactionModal.formaPagamento">
                                <option value="DINHEIRO">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="CARTAO">Cartao</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" x-show="transactionModal.type === 'saida'">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" x-model="transactionModal.categoria" @change="onCategoriaChange()">
                            <option value="Despesa">Despesa (Geral)</option>
                            <option value="Adiantamento">Adiantamento (Vale)</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Responsável (Fornecedor / Funcionário)</label>
                        <input
                            type="text"
                            class="form-input"
                            placeholder="Selecione o responsável"
                            x-model="transactionModal.fornecedorNome"
                            list="responsaveis-list"
                            @input="syncResponsavelSelection()"
                            @blur="syncResponsavelSelection()"
                            @change="syncResponsavelSelection()"
                            required
                            x-ref="transactionResponsavelInput"
                        >
                        <datalist id="responsaveis-list">
                        </datalist>
                        <p class="modal-hint" x-show="transactionModal.categoria === 'Adiantamento'">
                            Esse valor será debitado automaticamente do lavador selecionado.
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descricao *</label>
                        <input
                            type="text"
                            class="form-input"
                            placeholder="Ex: Compra de material de limpeza"
                            x-model="transactionModal.descricao"
                            required
                        >
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" @click="closeTransactionModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" :disabled="transactionModal.isSaving">
                            <template x-if="transactionModal.isSaving">
                                <i class="fas fa-spinner spinner"></i>
                            </template>
                            <span x-text="transactionModal.isSaving ? 'Salvando...' : 'Salvar'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Fechamento Modal -->
        <div
            class="modal-overlay"
            :class="{ active: fechamentoModal.isOpen }"
            x-show="fechamentoModal.isOpen"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            @click.self="closeFechamentoModal()"
        >
            <div class="modal-content wide" @click.stop>
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-door-closed"></i>
                        Fechar Caixa do Dia
                    </h2>
                    <button type="button" class="modal-close" @click="closeFechamentoModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Loading -->
                <template x-if="fechamentoModal.isLoading">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner spinner" style="font-size: 32px; color: var(--finance-cyan);"></i>
                        <p style="margin-top: 16px; color: var(--finance-text-secondary);">Carregando resumo...</p>
                    </div>
                </template>

                <!-- Summary -->
                <div x-show="!fechamentoModal.isLoading">
                    <div class="fechamento-grid">
                        <div class="fechamento-item">
                            <div class="label">Dinheiro</div>
                            <div class="value positive" x-text="formatCurrency(fechamentoModal.resumo.totalDinheiro)"></div>
                        </div>
                        <div class="fechamento-item">
                            <div class="label">Cartao</div>
                            <div class="value positive" x-text="formatCurrency(fechamentoModal.resumo.totalCartao)"></div>
                        </div>
                        <div class="fechamento-item">
                            <div class="label">PIX</div>
                            <div class="value positive" x-text="formatCurrency(fechamentoModal.resumo.totalPix)"></div>
                        </div>
                        <div class="fechamento-item">
                            <div class="label">Saidas / Sangrias</div>
                            <div class="value negative" x-text="'- ' + formatCurrency(fechamentoModal.resumo.totalSaidas)"></div>
                        </div>
                    </div>

                    <div class="fechamento-total">
                        <div class="label">Saldo Final Esperado (Dinheiro)</div>
                        <div class="value" x-text="formatCurrency(fechamentoModal.resumo.saldoDinheiro)"></div>
                    </div>

                    <div style="margin-top: 16px; padding: 16px; background: var(--finance-orange-light); border-radius: var(--radius-md); text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--finance-orange);"></i>
                        <span style="color: var(--finance-text); margin-left: 8px;">Esta acao nao pode ser desfeita.</span>
                    </div>
                </div>

                <div class="modal-actions" x-show="!fechamentoModal.isLoading">
                    <button type="button" class="btn btn-secondary" @click="closeFechamentoModal()">
                        Cancelar
                    </button>
                    <button class="btn btn-danger" @click="confirmarFechamento()" :disabled="fechamentoModal.isClosing">
                        <template x-if="fechamentoModal.isClosing">
                            <i class="fas fa-spinner spinner"></i>
                        </template>
                        <template x-if="!fechamentoModal.isClosing">
                            <i class="fas fa-lock"></i>
                        </template>
                        <span x-text="fechamentoModal.isClosing ? 'Fechando...' : 'Confirmar Fechamento'"></span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="api.js"></script>
    <script src="utils.js"></script>
    <script src="theme.js"></script>

    <script>
        /**
         * ============================================================
         * Alpine.js Component: Finance Dashboard
         * ============================================================
         *
         * A reactive financial module with tabs for transactions,
         * register control, and pending payments management.
         *
         * SANGRIA LOGIC - IMMEDIATE STATE UPDATE:
         * ---------------------------------------
         * When a Sangria (cash withdrawal) is registered, we update
         * the local state immediately before the API call completes.
         * This provides instant feedback to the user.
         *
         * Steps:
         * 1. User enters sangria amount and submits
         * 2. We optimistically update balance.sangrias and balance.netBalance
         * 3. We add a temporary transaction to the transactions array
         * 4. API call is made in background
         * 5. On success: reload full data to sync with server
         * 6. On failure: revert the optimistic update and show error
         *
         * This pattern is common in fintech apps where perceived
         * performance is critical for user trust.
         *
         * ============================================================
         */
        function financeDashboard() {
            console.log('[financeDashboard] factory start');
            const createTransactionModalState = () => ({
                isOpen: false,
                isSaving: false,
                type: 'saida',
                editId: null,
                valor: '',
                formaPagamento: 'DINHEIRO',
                categoria: 'Despesa',
                descricao: '',
                lavadorId: '',
                fornecedorNome: ''
            });

            const component = {
                // ==========================================
                // STATE
                // ==========================================
                isLoading: true,
                isLoadingTransactions: true,
                isLoadingPendencias: false,

                // Tabs
                activeTab: 'movimentacoes',

                // Balance Summary
                balance: {
                    totalReceived: 0,
                    totalExpenses: 0,
                    netBalance: 0,
                    pending: 0,
                    cash: 0,
                    card: 0,
                    pix: 0,
                    expenses: 0,
                    sangrias: 0
                },

                // Day Summary (for Caixa tab)
                daySummary: {
                    dinheiro: 0,
                    cartao: 0,
                    pix: 0
                },

                // Transactions
                transactions: [],
                pendencias: [],
                pendenciasCount: 0,

                // Filters
                filters: {
                    dataInicio: '',
                    dataFim: '',
                    tipo: ''
                },
                datePreset: 'today',

                // Register Status
                isRegisterOpen: true,

                // Lookups
                lavadores: [],
                fornecedores: [],

                // Transaction Modal
                transactionModal: createTransactionModalState(),

                // Fechamento Modal
                fechamentoModal: {
                    isOpen: false,
                    isLoading: false,
                    isClosing: false,
                    resumo: {
                        totalDinheiro: 0,
                        totalCartao: 0,
                        totalPix: 0,
                        totalSaidas: 0,
                        saldoDinheiro: 0
                    }
                },

                // ==========================================
                // LIFECYCLE
                // ==========================================
                async init() {
                    console.log('[financeDashboard] init');
                    // Check authentication
                    if (!window.api.isAuthenticated()) {
                        window.location.href = 'login.html';
                        return;
                    }

                    // Initialize UI
                    this.initializeUI();

                    // Apply default date filter
                    this.applyDatePreset('today');

                    // Load lookup data
                    await this.loadLookups();

                    // Load pendencias count
                    this.loadPendenciasCount();
                },

                initializeUI() {
                    // Permissions
                    if (typeof enforcePermission === 'function') {
                        enforcePermission('ver_financeiro');
                    }
                    if (typeof updateMenuVisibility === 'function') {
                        updateMenuVisibility();
                    }
                    if (typeof handleImpersonationBanner === 'function') {
                        handleImpersonationBanner();
                    }

                    // User menu
                    const trigger = document.getElementById('user-menu-trigger');
                    const dropdown = document.getElementById('user-menu-dropdown');
                    const avatar = document.getElementById('user-info-avatar');
                    const info = document.getElementById('user-info-dropdown');

                    const userName = localStorage.getItem('usuarioNome') || 'Usuario';
                    const empresaNome = localStorage.getItem('empresaNome') || 'N/A';

                    if (avatar) avatar.textContent = userName.charAt(0).toUpperCase();
                    if (info) {
                        info.innerHTML = `
                            <div style="padding: 8px 12px;">
                                <p style="font-weight: 600;">${userName}</p>
                                <p style="font-size: 12px; color: var(--finance-text-secondary);">${empresaNome}</p>
                            </div>
                        `;
                    }

                    if (trigger && dropdown) {
                        trigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            dropdown.classList.toggle('active');
                        });
                        document.addEventListener('click', () => dropdown.classList.remove('active'));
                    }
                },

            async loadLookups() {
                try {
                    const [lavadoresData, fornecedoresData] = await Promise.all([
                        window.api.getLavadoresSimple(),
                        window.api.getFornecedores()
                    ]);
                    this.lavadores = lavadoresData.lavadores || [];
                    this.fornecedores = fornecedoresData || [];
                    console.log('[financeDashboard] lavadores carregados:', this.lavadores.length, this.lavadores);
                    console.log('[financeDashboard] fornecedores carregados:', this.fornecedores.length, this.fornecedores);
                } catch (error) {
                    console.error('Error loading lookups:', error);
                }
            },

                // ==========================================
                // DATE PRESETS
                // ==========================================
                applyDatePreset(preset) {
                    this.datePreset = preset;
                    const today = new Date();
                    let startDate = new Date();
                    let endDate = new Date();

                    if (preset === 'today') {
                        // Today
                    } else if (preset === 'week') {
                        const dayOfWeek = today.getDay();
                        const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        startDate.setDate(today.getDate() + diffToMonday);
                        endDate.setDate(startDate.getDate() + 6);
                    } else if (preset === 'month') {
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    }

                    this.filters.dataInicio = this.toDateString(startDate);
                    this.filters.dataFim = this.toDateString(endDate);

                    this.loadTransactions();
                },

                toDateString(date) {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                },

                // ==========================================
                // DATA LOADING
                // ==========================================
                async loadTransactions() {
                    console.log('[financeDashboard] loadTransactions iniciado');
                    this.isLoadingTransactions = true;
                    this.isLoading = true;

                    try {
                        const response = await window.api.getHistoricoCaixa({
                            dataInicio: this.filters.dataInicio,
                            dataFim: this.filters.dataFim,
                            tipo: this.filters.tipo
                        });

                        console.log('[financeDashboard] Resposta getHistoricoCaixa:', response);

                        this.transactions = response.registros || [];
                        const totais = response.totais || {};

                        // Update balance
                        this.balance.totalReceived = totais.totalEntradas || 0;
                        this.balance.totalExpenses = totais.totalSaidas || 0;
                        this.balance.netBalance = this.balance.totalReceived - this.balance.totalExpenses;
                        this.balance.expenses = totais.detalheSaidas?.saidas || 0;
                        this.balance.sangrias = totais.detalheSaidas?.sangrias || 0;

                        // Calculate by payment method from transactions
                        this.balance.cash = 0;
                        this.balance.card = 0;
                        this.balance.pix = 0;
                        this.balance.pending = 0;

                        this.transactions.forEach(tx => {
                            if (tx.tipo === 'PAGAMENTO') {
                                if (tx.formaPagamento === 'DINHEIRO') this.balance.cash += tx.valor;
                                else if (tx.formaPagamento === 'CARTAO') this.balance.card += tx.valor;
                                else if (tx.formaPagamento === 'PIX') this.balance.pix += tx.valor;
                            } else if (tx.tipo === 'PENDENTE') {
                                this.balance.pending += tx.valor;
                            }
                        });

                        console.log('[financeDashboard] Balance calculado:', this.balance);

                        // Also load day summary for Caixa tab
                        await this.loadDaySummary();

                    } catch (error) {
                        console.error('Error loading transactions:', error);
                        if (typeof showToast === 'function') {
                            showToast('Erro ao carregar movimentacoes', 'error');
                        }
                    } finally {
                        this.isLoading = false;
                        this.isLoadingTransactions = false;
                    }
                },

                async loadDaySummary() {
                    try {
                        console.log('[financeDashboard] Carregando resumo do dia...');
                        const resumo = await window.api.getResumoDia();
                        console.log('[financeDashboard] Resumo recebido:', resumo);

                        this.daySummary.dinheiro = resumo.totalDinheiro || 0;
                        this.daySummary.cartao = resumo.totalCartao || 0;
                        this.daySummary.pix = resumo.totalPix || 0;

                        console.log('[financeDashboard] daySummary atualizado:', {
                            dinheiro: this.daySummary.dinheiro,
                            cartao: this.daySummary.cartao,
                            pix: this.daySummary.pix
                        });
                    } catch (error) {
                        console.error('[financeDashboard] Erro ao carregar resumo do dia:', error);
                    }
                },

                async loadPendencias() {
                    this.isLoadingPendencias = true;
                    try {
                        const response = await window.api.getOrdens(1, 50, '', 'FINALIZADO', '', '', '', '', 'PENDENTE');
                        this.pendencias = response.ordens || [];
                        this.pendenciasCount = this.pendencias.length;
                    } catch (error) {
                        console.error('Error loading pendencias:', error);
                    } finally {
                        this.isLoadingPendencias = false;
                    }
                },

                async loadPendenciasCount() {
                    try {
                        const response = await window.api.getOrdens(1, 1, '', 'FINALIZADO', '', '', '', '', 'PENDENTE');
                        this.pendenciasCount = response.pagination?.total || 0;
                    } catch (error) {
                        console.error('Error loading pendencias count:', error);
                    }
                },

                // ==========================================
                // TRANSACTION MODAL
                // ==========================================
                resetTransactionModal() {
                    this.transactionModal = createTransactionModalState();
                },

                focusResponsavelInput() {
                    this.$nextTick(() => {
                        this.$refs.transactionResponsavelInput?.focus();
                    });
                },

                activeLavadores() {
                    if (!Array.isArray(this.lavadores)) return [];
                    return this.lavadores.filter((lavador) => {
                        if (lavador.ativo !== undefined) {
                            return lavador.ativo === true || lavador.ativo === 'ATIVO';
                        }
                        if (lavador.status !== undefined) {
                            return ['ATIVO', 'active', 'Active'].includes(String(lavador.status).toUpperCase());
                        }
                        return true;
                        });
                },

                getResponsaveisList() {
                    // Apenas retorna lavadores quando for Adiantamento
                    if (this.transactionModal.categoria === 'Adiantamento') {
                        const lavadores = this.activeLavadores();
                        console.log('[getResponsaveisList] Retornando lavadores:', lavadores.length);
                        return lavadores;
                    }
                    // Para outras categorias, retorna fornecedores
                    console.log('[getResponsaveisList] Retornando fornecedores:', (this.fornecedores || []).length);
                    return this.fornecedores || [];
                },

                updateDatalist() {
                    const datalist = document.getElementById('responsaveis-list');
                    if (!datalist) {
                        console.warn('[financeDashboard] datalist nao encontrado');
                        return;
                    }

                    // Limpar opções existentes
                    datalist.innerHTML = '';

                    // Obter lista apropriada
                    const lista = this.getResponsaveisList();
                    const isAdiantamento = this.transactionModal.categoria === 'Adiantamento';

                    console.log('[financeDashboard] atualizando datalist', {
                        categoria: this.transactionModal.categoria,
                        isAdiantamento: isAdiantamento,
                        count: lista.length,
                        lavadores: this.lavadores.length,
                        fornecedores: this.fornecedores.length,
                        items: lista.map(i => i.nome)
                    });

                    if (!Array.isArray(lista) || lista.length === 0) {
                        console.warn('[financeDashboard] lista vazia para categoria:', this.transactionModal.categoria);
                        return;
                    }

                    // Criar e adicionar opções com melhor exibição
                    lista.forEach((item, index) => {
                        if (item && item.nome) {
                            const option = document.createElement('option');

                            // Capitaliza o nome corretamente
                            const nomeFormatado = item.nome.trim();
                            option.value = nomeFormatado;

                            // Para lavadores (Adiantamento), adiciona informações extras
                            if (isAdiantamento) {
                                // Mostra: "Nome do Lavador - Funcionário"
                                const label = `${nomeFormatado} - Funcionário`;
                                option.setAttribute('label', label);
                            } else {
                                // Para fornecedores, mostra informações adicionais se disponível
                                let label = nomeFormatado;
                                if (item.telefone) {
                                    label += ` - ${item.telefone}`;
                                } else if (item.contato) {
                                    label += ` - ${item.contato}`;
                                }
                                option.setAttribute('label', label);
                            }

                            datalist.appendChild(option);
                        }
                    });

                    console.log('[financeDashboard] ✓ datalist atualizado:', datalist.children.length, 'opcoes', isAdiantamento ? '(LAVADORES)' : '(FORNECEDORES)');
                },

                findLavadorByName(name) {
                    if (!name || !Array.isArray(this.lavadores)) return null;
                    const normalized = String(name).trim().toLowerCase();
                    return this.lavadores.find((lavador) => {
                        const lavadorName = String(lavador.nome || '').toLowerCase();
                        return lavadorName && lavadorName.includes(normalized);
                    }) || null;
                },

                onCategoriaChange() {
                    console.log('[financeDashboard] categoria mudou', this.transactionModal.categoria);
                    const isAdiantamento = this.transactionModal.categoria === 'Adiantamento';
                    if (isAdiantamento) {
                        this.transactionModal.fornecedorNome = '';
                        this.$nextTick(() => {
                            this.updateDatalist();
                            this.focusResponsavelInput();
                        });
                    } else {
                        this.transactionModal.lavadorId = '';
                        this.$nextTick(() => {
                            this.updateDatalist();
                            this.$refs.transactionValor?.focus();
                        });
                    }
                    this.syncResponsavelSelection();
                },

                syncResponsavelSelection() {
                    if (this.transactionModal.categoria === 'Adiantamento') {
                        const matchedLavador = this.findLavadorByName(this.transactionModal.fornecedorNome);
                        console.log('[financeDashboard] syncResponsavelSelection', {
                            categoria: this.transactionModal.categoria,
                            nome: this.transactionModal.fornecedorNome,
                            matchedLavador
                        });
                        if (matchedLavador) {
                            this.transactionModal.lavadorId = matchedLavador.id;
                            this.transactionModal.fornecedorNome = matchedLavador.nome;
                        } else {
                            this.transactionModal.lavadorId = '';
                        }
                    } else {
                        this.transactionModal.lavadorId = '';
                    }
                },

                openTransactionModal(type) {
                    console.log('[financeDashboard] openTransactionModal', type);
                    const modalState = createTransactionModalState();
                    modalState.isOpen = true;
                    modalState.type = type;
                    modalState.categoria = type === 'saida' ? 'Despesa' : 'Outro';
                    modalState.descricao = type === 'sangria'
                        ? 'Sangria de caixa'
                        : (type === 'suprimento' ? 'Suprimento de caixa' : '');
                    this.transactionModal = modalState;

                    this.$nextTick(() => {
                        this.updateDatalist();
                        if (modalState.categoria === 'Adiantamento') {
                            this.focusResponsavelInput();
                        } else {
                            this.$refs.transactionValor?.focus();
                        }
                    });
                },

                openEditModal(tx) {
                    const modalState = createTransactionModalState();
                    modalState.isOpen = true;
                    modalState.type = 'saida';
                    modalState.editId = tx.id;
                    modalState.valor = tx.valor;
                    modalState.formaPagamento = tx.formaPagamento || 'DINHEIRO';
                    modalState.categoria = tx.lavadorId ? 'Adiantamento' : 'Despesa';
                    modalState.descricao = tx.descricao.replace(/\[(Despesa|Adiantamento)\]\s*/, '');
                    modalState.lavadorId = tx.lavadorId || '';
                    modalState.fornecedorNome = tx.fornecedor?.nome || '';
                    this.transactionModal = modalState;

                    this.$nextTick(() => {
                        this.updateDatalist();
                        if (modalState.categoria === 'Adiantamento') {
                            this.focusResponsavelInput();
                        } else {
                            this.$refs.transactionValor?.focus();
                        }
                    });
                },

                closeTransactionModal() {
                    if (!this.transactionModal.isOpen) return;
                    this.transactionModal.isOpen = false;
                    this.$nextTick(() => {
                        if (!this.transactionModal.isOpen) {
                            this.resetTransactionModal();
                        }
                    });
                },

                handleEscape() {
                    if (this.transactionModal.isOpen) {
                        this.closeTransactionModal();
                    }
                },

                getTransactionModalIcon() {
                    const icons = {
                        'saida': 'fas fa-arrow-up',
                        'sangria': 'fas fa-arrow-down',
                        'suprimento': 'fas fa-arrow-up'
                    };
                    return icons[this.transactionModal.type] || 'fas fa-exchange-alt';
                },

                getTransactionModalTitle() {
                    const titles = {
                        'saida': 'Registrar Saida',
                        'sangria': 'Registrar Sangria',
                        'suprimento': 'Registrar Suprimento'
                    };
                    return this.transactionModal.editId ? 'Editar Saida' : (titles[this.transactionModal.type] || 'Nova Transacao');
                },

                isAdiantamentoTransaction() {
                    return this.transactionModal.type === 'saida' && this.transactionModal.categoria === 'Adiantamento';
                },

                /**
                 * SAVE TRANSACTION WITH OPTIMISTIC UPDATE
                 *
                 * For Sangria, we immediately update the local state
                 * to provide instant feedback, then sync with server.
                 */
                async saveTransaction() {
                    const modal = this.transactionModal;

                    // Validation
                    if (modal.categoria === 'Adiantamento' && !modal.lavadorId) {
                        showToast('Selecione um funcionario para o adiantamento.', 'error');
                        return;
                    }

                    modal.isSaving = true;
                    const valor = parseFloat(modal.valor);

                    // Store original state for rollback
                    const originalBalance = { ...this.balance };
                    const originalTransactions = [...this.transactions];

                    try {
                        if (modal.type === 'sangria') {
                            // ========================================
                            // OPTIMISTIC UPDATE FOR SANGRIA
                            // ========================================
                            // Update balance immediately
                            this.balance.sangrias += valor;
                            this.balance.totalExpenses += valor;
                            this.balance.netBalance = this.balance.totalReceived - this.balance.totalExpenses;

                            // Add temporary transaction to list
                            const tempTx = {
                                id: 'temp-' + Date.now(),
                                data: new Date().toISOString(),
                                tipo: 'SANGRIA',
                                descricao: modal.descricao || 'Sangria de caixa',
                                valor: valor,
                                formaPagamento: 'DINHEIRO'
                            };
                            this.transactions.unshift(tempTx);

                            // Now make API call
                            await window.api.createSangria({
                                valor: valor,
                                descricao: modal.descricao || 'Sangria de caixa'
                            });

                            showToast('Sangria registrada com sucesso!', 'success');

                        } else if (modal.type === 'suprimento') {
                            // Suprimento uses the saida endpoint with special type
                            await window.api.createSaida({
                                valor: valor,
                                formaPagamento: 'DINHEIRO',
                                tipo: 'Suprimento',
                                descricao: modal.descricao || 'Suprimento de caixa'
                            });
                            showToast('Suprimento registrado com sucesso!', 'success');

                        } else {
                            // Regular Saida
                            const data = {
                                valor: valor,
                                formaPagamento: modal.formaPagamento,
                                tipo: modal.categoria,
                                descricao: modal.descricao,
                                fornecedorNome: modal.fornecedorNome,
                                lavadorId: modal.lavadorId
                            };

                            if (modal.editId) {
                                await window.api.updateCaixaRegistro(modal.editId, data);
                                showToast('Saida atualizada com sucesso!', 'success');
                            } else {
                                await window.api.createSaida(data);
                                showToast('Saida registrada com sucesso!', 'success');
                            }
                        }

                        this.closeTransactionModal();
                        // Reload to sync with server
                        await this.loadTransactions();

                    } catch (error) {
                        console.error('Error saving transaction:', error);
                        showToast('Erro ao salvar transacao.', 'error');

                        // Rollback optimistic update on error
                        if (modal.type === 'sangria') {
                            this.balance = originalBalance;
                            this.transactions = originalTransactions;
                        }
                    } finally {
                        modal.isSaving = false;
                    }
                },

                async deleteTransaction(id) {
                    if (typeof showCustomConfirm === 'function') {
                        showCustomConfirm({
                            title: 'Confirmar Exclusao',
                            message: 'Tem certeza que deseja excluir este lancamento?',
                            onConfirm: async () => {
                                try {
                                    await window.api.deleteCaixaRegistro(id);
                                    showToast('Lancamento excluido com sucesso.');
                                    this.loadTransactions();
                                } catch (error) {
                                    showToast('Erro ao excluir lancamento.', 'error');
                                }
                            }
                        });
                    } else if (confirm('Tem certeza que deseja excluir este lancamento?')) {
                        try {
                            await window.api.deleteCaixaRegistro(id);
                            showToast('Lancamento excluido com sucesso.');
                            this.loadTransactions();
                        } catch (error) {
                            showToast('Erro ao excluir lancamento.', 'error');
                        }
                    }
                },

                // ==========================================
                // FECHAMENTO MODAL
                // ==========================================
                async openFechamentoModal() {
                    console.log('[financeDashboard] openFechamentoModal');
                    this.fechamentoModal.isOpen = true;
                    this.fechamentoModal.isLoading = true;

                    try {
                        console.log('[financeDashboard] Buscando resumo para fechamento...');
                        const resumo = await window.api.getResumoDia();
                        console.log('[financeDashboard] Resumo recebido do backend:', resumo);

                        this.fechamentoModal.resumo = {
                            totalDinheiro: resumo.totalDinheiro || 0,
                            totalCartao: resumo.totalCartao || 0,
                            totalPix: resumo.totalPix || 0,
                            totalSaidas: resumo.totalSaidas || 0,
                            saldoDinheiro: resumo.saldoDinheiro || 0
                        };

                        console.log('[financeDashboard] Modal de fechamento atualizado com:', this.fechamentoModal.resumo);
                    } catch (error) {
                        console.error('[financeDashboard] Erro ao carregar resumo para fechamento:', error);
                        showToast('Erro ao carregar resumo.', 'error');
                    } finally {
                        this.fechamentoModal.isLoading = false;
                    }
                },

                closeFechamentoModal() {
                    this.fechamentoModal.isOpen = false;
                },

                async confirmarFechamento() {
                    this.fechamentoModal.isClosing = true;

                    try {
                        await window.api.createFechamento({});
                        showToast('Caixa fechado com sucesso!', 'success');
                        this.isRegisterOpen = false;
                        this.closeFechamentoModal();
                        this.loadTransactions();
                    } catch (error) {
                        console.error('Error closing register:', error);
                        showToast('Erro ao fechar o caixa.', 'error');
                    } finally {
                        this.fechamentoModal.isClosing = false;
                    }
                },

                // ==========================================
                // FORMATTERS
                // ==========================================
                formatCurrency(value) {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value || 0);
                },

                formatDateTime(dateString) {
                    return new Date(dateString).toLocaleString('pt-BR');
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString('pt-BR');
                },

                getTypeBadgeClass(tipo) {
                    const classes = {
                        'PAGAMENTO': 'entrada',
                        'SAIDA': 'saida',
                        'SANGRIA': 'sangria',
                        'FECHAMENTO': 'fechamento',
                        'PENDENTE': 'pendente'
                    };
                    return classes[tipo] || '';
                },

                getTypeLabel(tipo, formaPagamento) {
                    if (formaPagamento === 'DEBITO_FUNCIONARIO') return 'DEBITO OS';
                    return tipo;
                },

                getValueClass(tipo) {
                    if (tipo === 'PAGAMENTO') return 'value-positive';
                    if (tipo === 'PENDENTE') return 'value-pending';
                    return 'value-negative';
          }
            };
            window.financeDashboardInstance = component;
            return component;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const ensureInstance = () => window.financeDashboardInstance;
            const openTransaction = (type) => ensureInstance()?.openTransactionModal(type);
            document.getElementById('btn-sangria')?.addEventListener('click', (event) => {
                event.stopPropagation();
                openTransaction('sangria');
            });
            document.getElementById('btn-suprimento')?.addEventListener('click', (event) => {
                event.stopPropagation();
                openTransaction('suprimento');
            });
            document.getElementById('btn-fechar-caixa')?.addEventListener('click', () => ensureInstance()?.openFechamentoModal());
            document.getElementById('btn-enter-expense')?.addEventListener('click', () => openTransaction('saida'));
        });

  // Global logout function
        function logout() {
            if (typeof showCustomConfirm === 'function') {
                showCustomConfirm({
                    title: 'Confirmar Saida',
                    message: 'Tem certeza que deseja sair do sistema?',
                    onConfirm: () => window.api.logout()
                });
            } else {
                window.api.logout();
            }
        }
    </script>
    <script src="nav-menu-helper.js"></script>
</body>
</html>


