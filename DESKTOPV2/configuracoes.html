<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinaX - Configurações</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="configuracoes.css">
    <script src="utils.js"></script>
    <script src="api.js"></script>
    <!-- theme.js removed - now opt-in only (enable via Aparência tab) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body id="config-page" data-permission="gerenciar_configuracoes">
    <!-- Navigation Menu -->
    <nav class="nav-menu-card" style="margin: 32px;">
        <a href="index.html" class="nav-menu-item" data-permission="ver_dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="ordens.html" class="nav-menu-item" data-permission="gerenciar_ordens">
            <i class="fas fa-list-alt"></i>
            <span>Ordens</span>
        </a>
        <a href="novaordem.html" class="nav-menu-item" data-permission="gerenciar_ordens">
            <i class="fas fa-plus-circle"></i>
            <span>Nova Ordem</span>
        </a>
        <a href="clientes.html" class="nav-menu-item" data-permission="gerenciar_clientes">
            <i class="fas fa-users"></i>
            <span>Clientes</span>
        </a>
        <a href="funcionarios.html" class="nav-menu-item" data-permission="gerenciar_funcionarios">
            <i class="fas fa-user-tie"></i>
            <span>Funcionários</span>
        </a>
        <a href="financeiro.html" class="nav-menu-item" data-permission="ver_financeiro">
            <i class="fas fa-chart-pie"></i>
            <span>Financeiro</span>
        </a>
        <a href="configuracoes.html" class="nav-menu-item active" data-permission="gerenciar_configuracoes">
            <i class="fas fa-cog"></i>
            <span>Configurações</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="main-content" x-data="configApp()">
        <header class="main-header">
            <div class="header-title">
                <h2>Configurações</h2>
                <p>Gerencie os dados da sua empresa, tabela de preços e preferências do sistema.</p>
            </div>
        </header>

        <!-- Modern Tab Navigation -->
        <div class="tabs">
            <button
                class="tab-button"
                :class="{ 'active': activeTab === 'empresa' }"
                @click="activeTab = 'empresa'"
            >
                <i class="fas fa-building mr-2"></i> Dados da Empresa
            </button>
            <button
                class="tab-button"
                :class="{ 'active': activeTab === 'precos' }"
                @click="activeTab = 'precos'"
            >
                <i class="fas fa-tags mr-2"></i> Tabela de Preços
            </button>
            <button
                class="tab-button"
                :class="{ 'active': activeTab === 'aparencia' }"
                @click="activeTab = 'aparencia'"
            >
                <i class="fas fa-palette mr-2"></i> Aparência
            </button>
            <button
                class="tab-button"
                :class="{ 'active': activeTab === 'preferencias' }"
                @click="activeTab = 'preferencias'"
                x-show="canViewTab('preferencias')"
            >
                <i class="fas fa-cog mr-2"></i> Preferências
            </button>
            <button
                class="tab-button"
                :class="{ 'active': activeTab === 'usuarios' }"
                @click="activeTab = 'usuarios'"
                x-show="canViewTab('usuarios')"
            >
                <i class="fas fa-user-shield mr-2"></i> Usuários e Permissões
            </button>
            <button
                class="tab-button"
                :class="{ 'active': activeTab === 'tokens' }"
                @click="activeTab = 'tokens'"
                x-show="canViewTab('tokens')"
            >
                <i class="fas fa-key mr-2"></i> Tokens de Acesso
            </button>
        </div>

        <!-- Tab 1: Dados da Empresa -->
        <div x-show="activeTab === 'empresa'" x-transition class="tab-content">
            <div class="card">
                <h3 class="text-xl font-semibold mb-6">
                    <i class="fas fa-building mr-2" style="color: var(--primary-color);"></i>
                    Informações da Empresa
                </h3>
                <form @submit.prevent="saveEmpresa">
                    <div class="form-group">
                        <label for="empresaNome" class="form-label">Nome da Empresa</label>
                        <input
                            type="text"
                            id="empresaNome"
                            class="form-input"
                            x-model="empresaForm.nome"
                            required
                        >
                    </div>

                    <h4 class="text-lg font-semibold mt-6 mb-4">
                        <i class="fas fa-clock mr-2" style="color: var(--primary-color);"></i>
                        Horário de Funcionamento
                    </h4>
                    <p class="text-secondary mb-4">Define o início e o fim do "dia de trabalho" para relatórios e filtros.</p>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="horarioAbertura" class="form-label">Abertura</label>
                            <input
                                type="time"
                                id="horarioAbertura"
                                class="form-input"
                                x-model="empresaForm.horarioAbertura"
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label for="horarioFechamento" class="form-label">Fechamento</label>
                            <input
                                type="time"
                                id="horarioFechamento"
                                class="form-input"
                                x-model="empresaForm.horarioFechamento"
                                required
                            >
                        </div>
                    </div>

                    <button type="submit" class="btn-primary mt-6">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Alterações
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab 2: Tabela de Preços (CRITICAL) -->
        <div x-show="activeTab === 'precos'" x-transition class="tab-content">
            <!-- Services Section -->
            <div class="card mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">
                            <i class="fas fa-spray-can mr-2" style="color: var(--primary-color);"></i>
                            Serviços
                        </h3>
                        <p class="text-sm text-secondary mt-1">Gerencie os serviços disponíveis para cada tipo de veículo</p>
                    </div>
                    <button @click="openServiceModal()" class="btn-primary" x-show="hasPermissionSafe('config_ver_servicos')">
                        <i class="fas fa-plus mr-2"></i> Novo Serviço
                    </button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Preço</th>
                                <th>Tipo de Veículo</th>
                                <th>Categoria</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="services.length === 0">
                                <tr>
                                    <td colspan="5" class="text-center p-8 text-secondary">
                                        <i class="fas fa-inbox fa-3x mb-4" style="opacity: 0.3;"></i>
                                        <p>Nenhum serviço cadastrado ainda.</p>
                                        <p class="text-sm mt-2">Clique em "Novo Serviço" para começar.</p>
                                    </td>
                                </tr>
                            </template>
                            <template x-for="service in services" :key="service.id">
                                <tr>
                                    <td x-text="service.nome"></td>
                                    <td><strong class="font-semibold" x-text="formatCurrency(service.preco)"></strong></td>
                                    <td x-text="service.tiposVeiculo && service.tiposVeiculo.length > 0 ? service.tiposVeiculo[0].nome : 'N/A'"></td>
                                    <td>
                                        <template x-if="service.tiposVeiculo && service.tiposVeiculo.some(t => t.categoria)">
                                            <div>
                                                <template x-for="tipo in service.tiposVeiculo.filter(t => t.categoria)" :key="tipo.categoria">
                                                    <span class="subtipo-badge" x-text="tipo.categoria"></span>
                                                </template>
                                            </div>
                                        </template>
                                        <template x-if="!service.tiposVeiculo || !service.tiposVeiculo.some(t => t.categoria)">
                                            <span class="text-secondary">Todos</span>
                                        </template>
                                    </td>
                                    <td class="actions-cell">
                                        <button @click="openServiceModal(service)" class="btn-sm btn-secondary" title="Editar" x-show="hasPermissionSafe('config_ver_servicos')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button @click="deleteService(service.id)" class="btn-sm btn-danger" title="Excluir" x-show="hasPermissionSafe('config_ver_servicos')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Adicionais Section -->
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">
                            <i class="fas fa-plus-circle mr-2" style="color: var(--primary-color);"></i>
                            Adicionais
                        </h3>
                        <p class="text-sm text-secondary mt-1">Itens extras que podem ser adicionados aos serviços</p>
                    </div>
                    <button @click="openAdicionalModal()" class="btn-primary" x-show="hasPermissionSafe('config_ver_servicos')">
                        <i class="fas fa-plus mr-2"></i> Novo Adicional
                    </button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Preço</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="adicionais.length === 0">
                                <tr>
                                    <td colspan="3" class="text-center p-8 text-secondary">
                                        <i class="fas fa-inbox fa-3x mb-4" style="opacity: 0.3;"></i>
                                        <p>Nenhum adicional cadastrado ainda.</p>
                                        <p class="text-sm mt-2">Clique em "Novo Adicional" para começar.</p>
                                    </td>
                                </tr>
                            </template>
                            <template x-for="adicional in adicionais" :key="adicional.id">
                                <tr>
                                    <td x-text="adicional.nome"></td>
                                    <td><strong class="font-semibold" x-text="formatCurrency(adicional.preco)"></strong></td>
                                    <td class="actions-cell">
                                        <button @click="openAdicionalModal(adicional)" class="btn-sm btn-secondary" title="Editar" x-show="hasPermissionSafe('config_ver_servicos')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button @click="deleteAdicional(adicional.id)" class="btn-sm btn-danger" title="Excluir" x-show="hasPermissionSafe('config_ver_servicos')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 3: Aparência -->
        <div x-show="activeTab === 'aparencia'" x-transition class="tab-content">
            <div class="card">
                <h3 class="text-xl font-semibold mb-6">
                    <i class="fas fa-palette mr-2" style="color: var(--primary-color);"></i>
                    Personalização da Marca
                </h3>
                <p class="text-secondary mb-6">Customize as cores do sistema para refletir a identidade visual da sua empresa.</p>

                <form @submit.prevent="saveTheme">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <!-- Primary Color Picker -->
                        <div class="form-group">
                            <label for="corPrimaria" class="form-label">
                                <i class="fas fa-circle mr-2" :style="{ color: theme.corPrimaria }"></i>
                                Cor Primária
                            </label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input
                                    type="color"
                                    id="corPrimaria"
                                    x-model="theme.corPrimaria"
                                    style="width: 80px; height: 50px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer;"
                                >
                                <input
                                    type="text"
                                    x-model="theme.corPrimaria"
                                    class="form-input"
                                    placeholder="#FF5733"
                                    pattern="^#[0-9A-Fa-f]{6}$"
                                    maxlength="7"
                                    @input="theme.corPrimaria = $event.target.value.toUpperCase()"
                                    style="flex: 1;"
                                >
                            </div>
                            <p class="text-sm text-secondary mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Usada em botões principais, destaques e elementos de ação
                            </p>
                        </div>

                        <!-- Secondary Color Picker -->
                        <div class="form-group">
                            <label for="corSecundaria" class="form-label">
                                <i class="fas fa-circle mr-2" :style="{ color: theme.corSecundaria }"></i>
                                Cor Secundária
                            </label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input
                                    type="color"
                                    id="corSecundaria"
                                    x-model="theme.corSecundaria"
                                    style="width: 80px; height: 50px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer;"
                                >
                                <input
                                    type="text"
                                    x-model="theme.corSecundaria"
                                    class="form-input"
                                    placeholder="#1F2937"
                                    pattern="^#[0-9A-Fa-f]{6}$"
                                    maxlength="7"
                                    @input="theme.corSecundaria = $event.target.value.toUpperCase()"
                                    style="flex: 1;"
                                >
                            </div>
                            <p class="text-sm text-secondary mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Usada em textos, bordas e elementos secundários
                            </p>
                        </div>
                    </div>

                    <!-- Live Preview Card -->
                    <div class="mb-6">
                        <label class="form-label mb-3">
                            <i class="fas fa-eye mr-2"></i>
                            Pré-visualização
                        </label>
                        <div style="background: linear-gradient(135deg, rgba(243, 244, 246, 0.5) 0%, rgba(255, 255, 255, 1) 100%); padding: 32px; border-radius: 16px; border: 2px solid var(--border-color);">
                            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                                <!-- Preview Button Primary -->
                                <button
                                    type="button"
                                    :style="{
                                        background: `linear-gradient(135deg, ${theme.corPrimaria} 0%, ${adjustBrightness(theme.corPrimaria, -20)} 100%)`,
                                        color: 'white',
                                        padding: '12px 24px',
                                        borderRadius: '10px',
                                        border: 'none',
                                        fontWeight: '600',
                                        boxShadow: `0 4px 12px ${theme.corPrimaria}40`,
                                        cursor: 'pointer'
                                    }"
                                >
                                    <i class="fas fa-check mr-2"></i>
                                    Botão Primário
                                </button>

                                <!-- Preview Badge -->
                                <div
                                    :style="{
                                        background: `${theme.corPrimaria}20`,
                                        color: theme.corPrimaria,
                                        padding: '8px 16px',
                                        borderRadius: '8px',
                                        border: `1px solid ${theme.corPrimaria}30`,
                                        fontWeight: '600',
                                        fontSize: '14px'
                                    }"
                                >
                                    <i class="fas fa-tag mr-2"></i>
                                    Badge
                                </div>

                                <!-- Preview Text -->
                                <div :style="{ color: theme.corSecundaria, fontWeight: '500' }">
                                    <i class="fas fa-font mr-2"></i>
                                    Texto Secundário
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reset to Default Button -->
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save mr-2"></i>
                            Salvar Personalização
                        </button>
                        <button
                            type="button"
                            @click="resetTheme()"
                            class="btn btn-secondary"
                        >
                            <i class="fas fa-undo mr-2"></i>
                            Restaurar Padrão
                        </button>
                    </div>

                    <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fbbf24;">
                        <p class="text-sm" style="color: #92400e; margin: 0;">
                            <i class="fas fa-lightbulb mr-2"></i>
                            <strong>Dica:</strong> As cores serão aplicadas imediatamente após salvar. Você pode usar o botão "Restaurar Padrão" para voltar às cores originais.
                        </p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab 4: Preferências -->
        <div x-show="activeTab === 'preferencias' && canViewTab('preferencias')" x-transition class="tab-content">
            <div class="card">
                <h3 class="text-xl font-semibold mb-6">
                    <i class="fas fa-cog mr-2" style="color: var(--primary-color);"></i>
                    Preferências Gerais
                </h3>

                <form @submit.prevent="savePreferencias">
                    <!-- Seção de Finalização e Exigências -->
                    <div class="secao-preferencia">
                        <h4 class="text-lg font-semibold mb-4">
                            <i class="fas fa-clipboard-check mr-2" style="color: var(--primary-color);"></i>
                            Finalização de Ordens
                        </h4>

                        <div class="notification-preference-list">
                            <div class="notification-preference-item">
                                <div>
                                    <label for="finalizacaoAutomatica" class="form-label" style="margin-bottom: 4px;">
                                        Finalização Automática de Ordens
                                    </label>
                                    <p class="text-sm text-secondary">
                                        Se habilitado, no "fim do dia de trabalho", o sistema irá alterar ordens "pendentes" ou "em andamento" de dias anteriores para "finalizado" com pagamento "PENDENTE".
                                    </p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="finalizacaoAutomatica" x-model="preferencias.finalizacaoAutomatica">
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <div class="notification-preference-item">
                                <div>
                                    <label for="exigirLavadorParaFinalizar" class="form-label" style="margin-bottom: 4px;">
                                        Exigir Lavador para Finalizar Ordem
                                    </label>
                                    <p class="text-sm text-secondary">
                                        Se habilitado, o sistema impedirá a finalização de uma ordem de serviço que não tenha um lavador atribuído.
                                    </p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="exigirLavadorParaFinalizar" x-model="preferencias.exigirLavadorParaFinalizar">
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <div class="notification-preference-item">
                                <div>
                                    <label for="paginaInicialPadrao" class="form-label" style="margin-bottom: 4px;">
                                        Página Inicial Padrão
                                    </label>
                                    <p class="text-sm text-secondary">
                                        Escolha para qual página você será redirecionado após o login.
                                    </p>
                                </div>
                                <select id="paginaInicialPadrao" x-model="preferencias.paginaInicialPadrao" class="form-select" style="max-width: 300px;">
                                    <option value="index.html">Dashboard</option>
                                    <option value="ordens.html">Ordens de Serviço</option>
                                    <option value="selecionar-tipo-veiculo.html">Nova Ordem</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Formas de Pagamento -->
                    <div class="secao-preferencia" style="margin-top: 32px;">
                        <h4 class="text-lg font-semibold mb-4">
                            <i class="fas fa-credit-card mr-2" style="color: var(--primary-color);"></i>
                            Formas de Pagamento Aceitas
                        </h4>
                        <p class="text-sm text-secondary mb-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            Selecione quais formas de pagamento estarão disponíveis no momento de finalizar uma ordem de serviço.
                        </p>

                        <div class="payment-methods-grid">
                            <!-- Dinheiro -->
                            <label class="payment-method-card" for="paymentDinheiro" :class="{ 'active': preferencias.paymentMethods.DINHEIRO }">
                                <div class="payment-method-info">
                                    <div class="payment-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div>
                                        <div class="form-label" style="margin-bottom: 4px;">Dinheiro</div>
                                        <span class="text-sm text-secondary">Pagamento em espécie</span>
                                    </div>
                                </div>
                                <label class="switch" @click.stop>
                                    <input type="checkbox" id="paymentDinheiro" x-model="preferencias.paymentMethods.DINHEIRO">
                                    <span class="slider round"></span>
                                </label>
                            </label>

                            <!-- PIX -->
                            <label class="payment-method-card" for="paymentPix" :class="{ 'active': preferencias.paymentMethods.PIX }">
                                <div class="payment-method-info">
                                    <div class="payment-icon" style="background: linear-gradient(135deg, rgba(50, 188, 173, 0.2) 0%, rgba(50, 188, 173, 0.1) 100%);">
                                        <i class="fab fa-pix" style="color: #32BCAD;"></i>
                                    </div>
                                    <div>
                                        <div class="form-label" style="margin-bottom: 4px;">PIX</div>
                                        <span class="text-sm text-secondary">Pagamento instantâneo</span>
                                    </div>
                                </div>
                                <label class="switch" @click.stop>
                                    <input type="checkbox" id="paymentPix" x-model="preferencias.paymentMethods.PIX">
                                    <span class="slider round"></span>
                                </label>
                            </label>

                            <!-- Cartão -->
                            <label class="payment-method-card" for="paymentCartao" :class="{ 'active': preferencias.paymentMethods.CARTAO }">
                                <div class="payment-method-info">
                                    <div class="payment-icon" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);">
                                        <i class="fas fa-credit-card" style="color: #3b82f6;"></i>
                                    </div>
                                    <div>
                                        <div class="form-label" style="margin-bottom: 4px;">Cartão</div>
                                        <span class="text-sm text-secondary">Débito ou crédito</span>
                                    </div>
                                </div>
                                <label class="switch" @click.stop>
                                    <input type="checkbox" id="paymentCartao" x-model="preferencias.paymentMethods.CARTAO">
                                    <span class="slider round"></span>
                                </label>
                            </label>

                            <!-- Débito de Funcionário -->
                            <label class="payment-method-card" for="paymentDebitoFuncionario" :class="{ 'active': preferencias.paymentMethods.DEBITO_FUNCIONARIO }">
                                <div class="payment-method-info">
                                    <div class="payment-icon" style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(249, 115, 22, 0.1) 100%);">
                                        <i class="fas fa-user-tag" style="color: #f97316;"></i>
                                    </div>
                                    <div>
                                        <div class="form-label" style="margin-bottom: 4px;">Débito de Funcionário</div>
                                        <span class="text-sm text-secondary">Lançar como adiantamento</span>
                                    </div>
                                </div>
                                <label class="switch" @click.stop>
                                    <input type="checkbox" id="paymentDebitoFuncionario" x-model="preferencias.paymentMethods.DEBITO_FUNCIONARIO">
                                    <span class="slider round"></span>
                                </label>
                            </label>
                        </div>

                        <div style="margin-top: 16px; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fbbf24;">
                            <p class="text-sm" style="color: #92400e; margin: 0;">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>Atenção:</strong> Desabilitar uma forma de pagamento a removerá das opções ao finalizar ordens de serviço.
                            </p>
                        </div>
                    </div>

                    <!-- Seção de Preferências de Notificação -->
                    <div class="secao-preferencia secao-notificacao" style="margin-top: 32px;">
                        <h4 class="text-lg font-semibold mb-4">
                            <i class="fas fa-bell mr-2" style="color: var(--primary-color);"></i>
                            Notificações no Painel
                        </h4>
                        <p class="text-sm text-secondary mb-4">Escolha quais notificações você deseja receber no sino de notificações.</p>
                        <div class="notification-preference-list">
                            <!-- Notificação: Ordem Criada -->
                            <div class="notification-preference-item">
                                <label for="notifOrdemCriada" class="form-label">Ordem de Serviço Criada</label>
                                <label class="switch">
                                    <input type="checkbox" id="notifOrdemCriada" x-model="preferencias.notifications.ordemCriada">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <!-- Notificação: Ordem Editada -->
                            <div class="notification-preference-item">
                                <label for="notifOrdemEditada" class="form-label">Ordem de Serviço Editada</label>
                                <label class="switch">
                                    <input type="checkbox" id="notifOrdemEditada" x-model="preferencias.notifications.ordemEditada">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <!-- Notificação: Ordem Deletada -->
                            <div class="notification-preference-item">
                                <label for="notifOrdemDeletada" class="form-label">Ordem de Serviço Deletada</label>
                                <label class="switch">
                                    <input type="checkbox" id="notifOrdemDeletada" x-model="preferencias.notifications.ordemDeletada">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <!-- Notificação: Finalização Automática -->
                            <div class="notification-preference-item">
                                <label for="notifFinalizacaoAutomatica" class="form-label">Aviso de Finalização Automática</label>
                                <label class="switch">
                                    <input type="checkbox" id="notifFinalizacaoAutomatica" x-model="preferencias.notifications.finalizacaoAutomatica">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary mt-6">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Preferências
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab 5: Usuários e Permissões -->
        <div x-show="activeTab === 'usuarios' && canViewTab('usuarios')" x-transition class="tab-content">
            <!-- Seção de Roles -->
            <div class="card mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-semibold">
                            <i class="fas fa-user-tag mr-2" style="color: var(--primary-color);"></i>
                            Funções (Roles)
                        </h3>
                        <p class="text-secondary text-sm mt-1">Defina funções com permissões específicas para organizar sua equipe</p>
                    </div>
                    <button @click="openRoleModal()" class="btn-primary" x-show="hasPermissionSafe('config_ver_usuarios')">
                        <i class="fas fa-plus mr-2"></i> Nova Função
                    </button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Usuários</th>
                                <th>Permissões</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="roles.length === 0">
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-secondary">
                                        <i class="fas fa-inbox mr-2"></i>
                                        Nenhuma função cadastrada. Clique em "Nova Função" para começar.
                                    </td>
                                </tr>
                            </template>
                            <template x-for="role in roles" :key="role.id">
                                <tr>
                                    <td><strong x-text="role.nome"></strong></td>
                                    <td x-text="role._count?.usuarios || 0"></td>
                                    <td>
                                        <template x-if="role.permissoes && role.permissoes.length > 0">
                                            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                <template x-for="perm in role.permissoes.slice(0, 3)" :key="perm.name">
                                                    <span class="subtipo-badge" x-text="perm.nome.replace(/_/g, ' ')"></span>
                                                </template>
                                                <template x-if="role.permissoes.length > 3">
                                                    <span class="subtipo-badge" x-text="`+${role.permissoes.length - 3}`"></span>
                                                </template>
                                            </div>
                                        </template>
                                        <template x-if="!role.permissoes || role.permissoes.length === 0">
                                            <span class="text-secondary text-sm">Nenhuma</span>
                                        </template>
                                    </td>
                                    <td class="actions-cell">
                                        <button @click="openRoleModal(role)" class="btn-sm btn-secondary" title="Editar" x-show="hasPermissionSafe('config_ver_usuarios')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button @click="deleteRole(role.id, role.nome)" class="btn-sm btn-danger" title="Excluir" x-show="hasPermissionSafe('config_ver_usuarios')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Seção de Usuários -->
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-semibold">
                            <i class="fas fa-users mr-2" style="color: var(--primary-color);"></i>
                            Usuários (Subcontas)
                        </h3>
                        <p class="text-secondary text-sm mt-1">Gerencie usuários com acesso ao sistema</p>
                    </div>
                    <button @click="openUserModal()" class="btn-primary" x-show="hasPermissionSafe('config_ver_usuarios')">
                        <i class="fas fa-user-plus mr-2"></i> Novo Usuário
                    </button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Função</th>
                                <th>Desconto Máx.</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="users.length === 0">
                                <tr>
                                    <td colspan="5" class="text-center p-4 text-secondary">
                                        <i class="fas fa-inbox mr-2"></i>
                                        Nenhum usuário cadastrado. Clique em "Novo Usuário" para começar.
                                    </td>
                                </tr>
                            </template>
                            <template x-for="user in users" :key="user.id">
                                <tr>
                                    <td x-text="user.nome"></td>
                                    <td x-text="user.email"></td>
                                    <td x-text="user.roleInt?.nome || 'Sem Função'"></td>
                                    <td><span x-text="(user.maxDesconto || 0) + '%'"></span></td>
                                    <td class="actions-cell">
                                        <button @click="openUserModal(user)" class="btn-sm btn-secondary" title="Editar" x-show="hasPermissionSafe('config_ver_usuarios')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button @click="deleteUser(user.id, user.nome)" class="btn-sm btn-danger" title="Excluir" x-show="hasPermissionSafe('config_ver_usuarios')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 6: Tokens de Acesso -->
        <div x-show="activeTab === 'tokens' && canViewTab('tokens')" x-transition class="tab-content">
            <div class="card">
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2">
                        <i class="fas fa-key mr-2" style="color: var(--primary-color);"></i>
                        Gerenciar Tokens de Acesso
                    </h3>
                    <p class="text-secondary text-sm">
                        Gerencie os links de acesso dos funcionários ao painel de lavadores. Ative, desative ou exclua tokens conforme necessário.
                    </p>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Funcionário</th>
                                <th>Link de Acesso</th>
                                <th>Status</th>
                                <th class="actions-cell">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="tokens.length === 0">
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-secondary">
                                        <i class="fas fa-inbox mr-2"></i>
                                        Nenhum token de acesso gerado. Tokens são criados automaticamente na página de Funcionários.
                                    </td>
                                </tr>
                            </template>
                            <template x-for="token in tokens" :key="token.id">
                                <tr>
                                    <td>
                                        <strong x-text="token.lavador.nome"></strong>
                                    </td>
                                    <td>
                                        <a
                                            :href="`${window.location.origin}/lavador-publico.html?token=${token.token}`"
                                            target="_blank"
                                            class="link-like"
                                            style="display: inline-flex; align-items: center; gap: 6px;"
                                        >
                                            <i class="fas fa-external-link-alt"></i>
                                            <span>Acessar Link</span>
                                        </a>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" x-show="hasPermissionSafe('config_ver_tokens')"
                                            :value="token.ativo ? 'true' : 'false'"
                                            @change="updateTokenStatus(token.id, $event.target.value === 'true')"
                                            style="max-width: 120px;"
                                        >
                                            <option value="true">Ativo</option>
                                            <option value="false">Inativo</option>
                                        </select>
                                    </td>
                                    <td class="actions-cell">
                                        <button
                                            @click="copyTokenLink(token.token)"
                                            class="btn-sm btn-secondary"
                                            title="Copiar Link"
                                        >
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button @click="deleteToken(token.id, token.lavador.nome)" class="btn-sm btn-danger" x-show="hasPermissionSafe('config_ver_tokens')"
                                            title="Excluir"
                                        >
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; border: 1px solid #3b82f6;">
                    <p class="text-sm" style="color: #1e40af; margin: 0;">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Como funciona:</strong> Os tokens são gerados automaticamente na página de Funcionários quando você clica em "Gerar Token de Acesso". Use esta página para gerenciar os tokens existentes.
                    </p>
                </div>
            </div>
        </div>

        <!-- Service Modal -->
        <div
            x-show="modals.service"
            :class="{ 'active': modals.service }"
            x-transition
            @click.self="closeServiceModal()"
            class="modal-overlay"
        >
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h2 class="modal-title" x-text="serviceForm.id ? 'Editar Serviço' : 'Novo Serviço'"></h2>
                    <button @click="closeServiceModal()" class="modal-close">&times;</button>
                </div>
                <form @submit.prevent="saveService">
                    <div class="form-group">
                        <label for="serviceName" class="form-label">Nome do Serviço</label>
                        <input
                            type="text"
                            id="serviceName"
                            class="form-input"
                            x-model="serviceForm.nome"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="servicePrice" class="form-label">Preço (R$)</label>
                        <input
                            type="number"
                            step="0.01"
                            min="0.01"
                            id="servicePrice"
                            class="form-input"
                            x-model="serviceForm.preco"
                            required
                        >
                        <p class="text-sm text-secondary mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            O preço deve ser maior que zero
                        </p>
                    </div>
                    <div class="form-group">
                        <label for="serviceTipoPrincipal" class="form-label">Tipo de Veículo</label>
                        <select
                            id="serviceTipoPrincipal"
                            class="form-select"
                            x-model="serviceForm.tipoVeiculo"
                            @change="updateSubtipoOptions()"
                            required
                        >
                            <option value="">Selecione...</option>
                            <option value="CARRO">Carro</option>
                            <option value="MOTO">Moto</option>
                        </select>
                    </div>
                    <div class="form-group" x-show="serviceForm.tipoVeiculo === 'CARRO' && subtipoOptions.length > 0">
                        <label class="form-label">Categorias (Subtipos)</label>
                        <p class="text-sm text-secondary mb-3">Selecione as categorias de carro para este serviço</p>
                        <div class="checkbox-group">
                            <template x-for="subtipo in subtipoOptions" :key="subtipo.categoria">
                                <div class="checkbox-item">
                                    <input
                                        type="checkbox"
                                        :id="'subtipo-' + subtipo.categoria"
                                        :value="subtipo.categoria"
                                        x-model="serviceForm.subtiposVeiculo"
                                    >
                                    <label :for="'subtipo-' + subtipo.categoria" x-text="subtipo.categoria"></label>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" @click="closeServiceModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-2"></i>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Adicional Modal -->
        <div
            x-show="modals.adicional"
            :class="{ 'active': modals.adicional }"
            x-transition
            @click.self="closeAdicionalModal()"
            class="modal-overlay"
        >
            <div class="modal-content" @click.stop>
                <div class="modal-header">
                    <h2 class="modal-title" x-text="adicionalForm.id ? 'Editar Adicional' : 'Novo Adicional'"></h2>
                    <button @click="closeAdicionalModal()" class="modal-close">&times;</button>
                </div>
                <form @submit.prevent="saveAdicional">
                    <div class="form-group">
                        <label for="adicionalName" class="form-label">Nome do Adicional</label>
                        <input
                            type="text"
                            id="adicionalName"
                            class="form-input"
                            x-model="adicionalForm.nome"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="adicionalPrice" class="form-label">Preço (R$)</label>
                        <input
                            type="number"
                            step="0.01"
                            min="0.01"
                            id="adicionalPrice"
                            class="form-input"
                            x-model="adicionalForm.preco"
                            required
                        >
                        <p class="text-sm text-secondary mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            O preço deve ser maior que zero
                        </p>
                    </div>
                    <div class="modal-actions">
                        <button type="button" @click="closeAdicionalModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-2"></i>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div
            x-show="modals.confirm"
            :class="{ 'active': modals.confirm }"
            x-transition
            @click.self="modals.confirm = false"
            class="modal-overlay"
        >
            <div class="modal-content" style="max-width: 400px; text-align: center;" @click.stop>
                <div class="modal-header" style="justify-content: center; border-bottom: none;">
                    <h2 class="modal-title" x-text="confirmModal.title"></h2>
                </div>
                <p class="text-secondary my-4" x-text="confirmModal.message"></p>
                <div class="modal-actions" style="justify-content: center; border-top: none; margin-top: 16px;">
                    <button @click="modals.confirm = false" class="btn btn-secondary">Cancelar</button>
                    <button @click="confirmModal.onConfirm(); modals.confirm = false" class="btn btn-danger">
                        <i class="fas fa-trash mr-2"></i>
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

    <!-- Role Modal -->
    <div
        x-show="modals.role"
        :class="{ 'active': modals.role }"
        x-transition
        @click.self="closeRoleModal()"
        class="modal-overlay"
    >
        <div class="modal-content" @click.stop style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" x-text="roleForm.id ? 'Editar Função' : 'Nova Função'"></h2>
                <button @click="closeRoleModal()" class="modal-close">&times;</button>
            </div>
            <form @submit.prevent="saveRole">
                <div class="form-group">
                    <label for="roleName" class="form-label">Nome da Função</label>
                    <input
                        type="text"
                        id="roleName"
                        class="form-input"
                        x-model="roleForm.nome"
                        placeholder="Ex: Gerente, Operador, Financeiro"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="form-label">Permissões</label>
                    <p class="text-sm text-secondary mb-4">Selecione o que usuários com esta função podem ver e fazer</p>
                    <div class="permissions-accordion">
                        <template x-for="perm in allPermissions" :key="perm.name">
                            <div class="permission-group" :class="{ 'expanded': expandedPermissions.includes(perm.name) }">
                                <div class="permission-group-header" @click="togglePermissionGroup(perm.name)">
                                    <label class="flex items-center gap-3 cursor-pointer" @click.stop>
                                        <input
                                            type="checkbox"
                                            class="form-checkbox master-checkbox"
                                            :value="perm.name"
                                            x-model="roleForm.selectedPermissions"
                                            @change="handleMasterCheckboxChange(perm)"
                                        >
                                        <i class="fas mr-2" :class="perm.icon" style="color: var(--primary-color);"></i>
                                        <span class="permission-group-title" x-text="perm.label"></span>
                                    </label>
                                    <template x-if="perm.sub_permissions">
                                        <i class="fas fa-chevron-down expand-icon"></i>
                                    </template>
                                </div>
                                <template x-if="perm.sub_permissions">
                                    <div class="sub-permissions-list">
                                        <template x-for="sub in perm.sub_permissions" :key="sub.name">
                                            <label class="sub-permission-item">
                                                <input
                                                    type="checkbox"
                                                    class="form-checkbox sub-checkbox"
                                                    :value="sub.name"
                                                    x-model="roleForm.selectedPermissions"
                                                    @change="handleSubCheckboxChange(perm, sub)"
                                                >
                                                <span x-text="sub.label"></span>
                                            </label>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" @click="closeRoleModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div
        x-show="modals.user"
        :class="{ 'active': modals.user }"
        x-transition
        @click.self="closeUserModal()"
        class="modal-overlay"
    >
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h2 class="modal-title" x-text="userForm.id ? 'Editar Usuário' : 'Novo Usuário'"></h2>
                <button @click="closeUserModal()" class="modal-close">&times;</button>
            </div>
            <form @submit.prevent="saveUser">
                <div class="form-group">
                    <label for="userName" class="form-label">Nome de Usuário (para login)</label>
                    <input
                        type="text"
                        id="userName"
                        class="form-input"
                        x-model="userForm.nome"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="userEmail" class="form-label">Email</label>
                    <input
                        type="email"
                        id="userEmail"
                        class="form-input"
                        x-model="userForm.email"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="userPassword" class="form-label">Senha</label>
                    <input
                        type="password"
                        id="userPassword"
                        class="form-input"
                        x-model="userForm.senha"
                        :required="!userForm.id"
                        :placeholder="userForm.id ? 'Deixe em branco para não alterar' : ''"
                    >
                    <template x-if="userForm.id">
                        <p class="text-sm text-secondary mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Preencha apenas se desejar alterar a senha
                        </p>
                    </template>
                </div>
                <div class="form-group">
                    <label for="userRoleSelect" class="form-label">Função (Role)</label>
                    <select
                        id="userRoleSelect"
                        class="form-select"
                        x-model="userForm.roleId"
                        required
                    >
                        <option value="">Selecione uma função</option>
                        <template x-for="role in roles" :key="role.id">
                            <option :value="role.id" x-text="role.nome"></option>
                        </template>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userMaxDesconto" class="form-label">Desconto Máximo Permitido (%)</label>
                    <input
                        type="number"
                        id="userMaxDesconto"
                        class="form-input"
                        x-model="userForm.maxDesconto"
                        min="0"
                        max="100"
                        placeholder="Ex: 10 para 10%"
                    >
                    <p class="text-sm text-secondary mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Define a porcentagem máxima de desconto que este usuário pode aplicar em uma OS
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" @click="closeUserModal()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        function configApp() {
            return {
                activeTab: 'empresa',

                // Modals state
                modals: {
                    service: false,
                    adicional: false,
                    confirm: false,
                    role: false,
                    user: false
                },

                // Data
                services: [],
                adicionais: [],
                tiposVeiculo: [],
                subtipoOptions: [],
                roles: [],
                users: [],
                tokens: [],
                expandedPermissions: [],

                // Forms
                empresaForm: {
                    nome: '',
                    horarioAbertura: '07:00',
                    horarioFechamento: '19:00'
                },

                preferencias: {
                    finalizacaoAutomatica: false,
                    exigirLavadorParaFinalizar: false,
                    paginaInicialPadrao: 'index.html',
                    paymentMethods: {
                        DINHEIRO: true,
                        PIX: true,
                        CARTAO: true,
                        DEBITO_FUNCIONARIO: false
                    },
                    notifications: {
                        ordemCriada: true,
                        ordemEditada: true,
                        ordemDeletada: false,
                        finalizacaoAutomatica: true
                    }
                },

                theme: {
                    corPrimaria: '#F59E0B',
                    corSecundaria: '#1F2937'
                },

                serviceForm: {
                    id: null,
                    nome: '',
                    preco: '',
                    tipoVeiculo: '',
                    subtiposVeiculo: []
                },

                adicionalForm: {
                    id: null,
                    nome: '',
                    preco: ''
                },

                confirmModal: {
                    title: '',
                    message: '',
                    onConfirm: () => {}
                },

                roleForm: {
                    id: null,
                    nome: '',
                    selectedPermissions: []
                },

                userForm: {
                    id: null,
                    nome: '',
                    email: '',
                    senha: '',
                    roleId: '',
                    maxDesconto: 0
                },

                allPermissions: [
                    { label: 'Dashboard', name: 'ver_dashboard', icon: 'fa-home' },
                    { label: 'Ordens', name: 'gerenciar_ordens', icon: 'fa-list-alt' },
                    { label: 'Clientes', name: 'gerenciar_clientes', icon: 'fa-users' },
                    { label: 'Funcionários', name: 'gerenciar_funcionarios', icon: 'fa-user-tie' },
                    { label: 'Financeiro', name: 'ver_financeiro', icon: 'fa-chart-pie' },
                    {
                        label: 'Configurações',
                        name: 'gerenciar_configuracoes',
                        icon: 'fa-cog',
                        sub_permissions: [
                            { name: 'config_ver_servicos', label: 'Serviços e Adicionais' },
                            { name: 'config_ver_empresa', label: 'Dados da Empresa' },
                            { name: 'config_ver_tokens', label: 'Tokens de Acesso' },
                            { name: 'config_ver_usuarios', label: 'Usuários e Permissões' },
                            { name: 'config_ver_preferencias', label: 'Preferências' }
                        ]
                    }
                ],
        
                hasPermissionSafe(permission) {
                    const userRole = localStorage.getItem('userRole');
                    if (userRole === 'OWNER' || userRole === 'LINA_OWNER') {
                        return true;
                    }
                    if (typeof hasPermission === 'function') {
                        return hasPermission(permission);
                    }
                    return true;
                },

                canViewTab(tab) {
                    if (tab === 'preferencias') return this.hasPermissionSafe('config_ver_preferencias');
                    if (tab === 'usuarios') return this.hasPermissionSafe('config_ver_usuarios');
                    if (tab === 'tokens') return this.hasPermissionSafe('config_ver_tokens');
                    return true;
                },

                getFirstVisibleTab() {
                    const tabs = ['empresa', 'precos', 'aparencia', 'preferencias', 'usuarios', 'tokens'];
                    return tabs.find(tab => this.canViewTab(tab)) || 'empresa';
                },

                setActiveTab(tab) {
                    this.activeTab = this.canViewTab(tab) ? tab : this.getFirstVisibleTab();
                },

                // Initialize
                async init() {
                    console.log('[Config] ========================================');
                    console.log('[Config] Initializing configuracoes page...');
                    console.log('[Config] ========================================');

                    // CRITICAL: Auth check must happen first
                    if (!window.api.isAuthenticated()) {
                        console.warn('[Config] ⚠️ Not authenticated - redirecting to login');
                        window.location.href = 'login.html';
                        return;
                    }
                    console.log('[Config] ✅ User authenticated');

                    // CRITICAL: Wrap in try-catch to prevent silent crashes
                    try {
                        // Permission check DISABLED - settings page is accessible to all authenticated users
                        // if (typeof enforcePermission === 'function') {
                        //     enforcePermission('gerenciar_configuracoes');
                        // }

                        if (typeof handleImpersonationBanner === 'function') {
                            handleImpersonationBanner();
                        }

                        // Initialize UI components
                        console.log('[Config] Initializing UI components...');
                        if (window.initializeUserMenu) window.initializeUserMenu();
                        if (window.updateMenuVisibility) window.updateMenuVisibility();
                        if (window.initializeNotificationSystem) window.initializeNotificationSystem();

                        // Load all data (with error handling inside loadData)
                        console.log('[Config] Loading all data from API...');
                        await this.loadData();

                        // Restore active tab from localStorage
                        const savedTab = localStorage.getItem('activeConfigTab');
                        if (savedTab && ['empresa', 'precos', 'aparencia', 'preferencias', 'usuarios', 'tokens'].includes(savedTab)) {
                            this.setActiveTab(savedTab);
                            console.log('[Config] Restored active tab:', savedTab);
                        } else {
                            this.setActiveTab(this.activeTab);
                        }

                        console.log('[Config] ========================================');
                        console.log('[Config] ✅ Initialization complete!');
                        console.log('[Config] ========================================');
                    } catch (error) {
                        // SAFE MODE: Show error WITHOUT redirecting - allows debugging
                        console.error('[Config] ❌ Fatal initialization error:', error);
                        console.error('[Config] Error stack:', error.stack);

                        // Show persistent error message to user
                        if (typeof showToast === 'function') {
                            showToast('Erro ao carregar configurações. Veja o console para detalhes.', 'error');
                        } else {
                            // Fallback if toast is not available
                            alert('Erro ao carregar configurações.\n\nDetalhes no console (F12):\n' + error.message);
                        }

                        // DO NOT REDIRECT - Allow user to see the page and debug
                        // Component will remain in a safe fallback state
                    }
                },

                // Load all data
                async loadData() {
                    console.log('[Config] Starting loadData()...');
                    try {
                        await Promise.all([
                            this.loadEmpresaData(),
                            this.loadPreferencias(),
                            this.loadServices(),
                            this.loadAdicionais(),
                            this.loadTiposVeiculo(),
                            this.loadTheme(),
                            this.loadRolesAndUsers(),
                            this.loadTokens()
                        ]);
                        console.log('[Config] ✅ All data loaded successfully');
                        console.log('[Config] Services:', this.services.length, 'items');
                        console.log('[Config] Adicionais:', this.adicionais.length, 'items');
                        console.log('[Config] Tipos de Veículo:', this.tiposVeiculo.length, 'items');
                        console.log('[Config] Roles:', this.roles.length, 'items');
                        console.log('[Config] Users:', this.users.length, 'items');
                        console.log('[Config] Tokens:', this.tokens.length, 'items');
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar dados:', error);
                        console.error('[Config] Error stack:', error.stack);
                        showToast('Erro ao carregar dados. Tente recarregar a página.', 'error');
                    }
                },

                async loadEmpresaData() {
                    try {
                        const empresaId = localStorage.getItem('empresaId');
                        console.log('[Config] Loading empresa data for ID:', empresaId);
                        const empresa = await window.api.getEmpresaById(empresaId);
                        console.log('[Config] ✅ Empresa data:', empresa);
                        this.empresaForm.nome = empresa.nome;
                        this.empresaForm.horarioAbertura = empresa.horarioAbertura || '07:00';
                        this.empresaForm.horarioFechamento = empresa.horarioFechamento || '19:00';
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar dados da empresa:', error);
                        showToast('Erro ao carregar dados da empresa.', 'error');
                    }
                },

                async loadPreferencias() {
                    try {
                        const empresaId = localStorage.getItem('empresaId');
                        console.log('[Config] Loading preferencias...');
                        const empresa = await window.api.getEmpresaById(empresaId);
                        console.log('[Config] ✅ Preferencias data:', empresa);

                        // Load business logic settings
                        this.preferencias.finalizacaoAutomatica = empresa.finalizacaoAutomatica || false;
                        this.preferencias.exigirLavadorParaFinalizar = empresa.exigirLavadorParaFinalizar || false;
                        this.preferencias.paginaInicialPadrao = empresa.paginaInicialPadrao || 'index.html';

                        // Load payment methods config
                        const paymentConfig = empresa.paymentMethodsConfig || {};
                        this.preferencias.paymentMethods = {
                            DINHEIRO: paymentConfig.DINHEIRO !== false,
                            PIX: paymentConfig.PIX !== false,
                            CARTAO: paymentConfig.CARTAO !== false,
                            DEBITO_FUNCIONARIO: paymentConfig.DEBITO_FUNCIONARIO === true
                        };

                        // Load notification preferences
                        const notifPrefs = empresa.notificationPreferences || {};
                        this.preferencias.notifications = {
                            ordemCriada: notifPrefs.ordemCriada !== false,
                            ordemEditada: notifPrefs.ordemEditada !== false,
                            ordemDeletada: notifPrefs.ordemDeletada === true,
                            finalizacaoAutomatica: notifPrefs.finalizacaoAutomatica !== false
                        };

                        console.log('[Config] Preferencias loaded:', this.preferencias);
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar preferências:', error);
                        showToast('Erro ao carregar preferências.', 'error');
                    }
                },

                async loadServices() {
                    try {
                        console.log('[Config] Loading services...');
                        const response = await window.api.getServicos();
                        console.log('[Config] Services API response:', response);
                        this.services = response.servicos || response;
                        console.log('[Config] ✅ Services loaded:', this.services.length, 'items');
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar serviços:', error);
                        console.error('[Config] Error details:', error.message, error.stack);
                        showToast('Erro ao carregar serviços.', 'error');
                    }
                },

                async loadAdicionais() {
                    try {
                        console.log('[Config] Loading adicionais...');
                        const response = await window.api.getAdicionais();
                        console.log('[Config] Adicionais API response:', response);
                        this.adicionais = response.adicionais || response;
                        console.log('[Config] ✅ Adicionais loaded:', this.adicionais.length, 'items');
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar adicionais:', error);
                        showToast('Erro ao carregar adicionais.', 'error');
                    }
                },

                async loadTiposVeiculo() {
                    try {
                        const response = await window.api.getTiposVeiculo();
                        this.tiposVeiculo = response.tiposVeiculo || response;
                    } catch (error) {
                        console.error('Erro ao carregar tipos de veículo:', error);
                    }
                },

                async loadTheme() {
                    try {
                        const themeData = await window.api.getThemeConfig();
                        this.theme.corPrimaria = themeData.corPrimaria || '#F59E0B';
                        this.theme.corSecundaria = themeData.corSecundaria || '#1F2937';

                        // Apply theme to document immediately
                        this.applyThemeToDocument();
                    } catch (error) {
                        console.error('Erro ao carregar tema:', error);
                        // Silent fail - use default colors
                    }
                },

                // Empresa actions
                async saveEmpresa() {
                    try {
                        const empresaId = localStorage.getItem('empresaId');
                        await window.api.updateEmpresa(empresaId, this.empresaForm);

                        localStorage.setItem('empresaNome', this.empresaForm.nome);
                        showToast('Dados da empresa salvos com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao salvar dados da empresa:', error);
                        showToast('Erro ao salvar dados da empresa.', 'error');
                    }
                },

                // Preferencias actions
                async savePreferencias() {
                    try {
                        const empresaId = localStorage.getItem('empresaId');

                        const data = {
                            finalizacaoAutomatica: this.preferencias.finalizacaoAutomatica,
                            exigirLavadorParaFinalizar: this.preferencias.exigirLavadorParaFinalizar,
                            paginaInicialPadrao: this.preferencias.paginaInicialPadrao,
                            paymentMethodsConfig: this.preferencias.paymentMethods,
                            notificationPreferences: this.preferencias.notifications
                        };

                        console.log('[Config] Saving preferencias:', data);
                        await window.api.updateEmpresa(empresaId, data);

                        // Update localStorage
                        localStorage.setItem('paginaInicialPadrao', data.paginaInicialPadrao);
                        localStorage.setItem('exigirLavadorParaFinalizar', data.exigirLavadorParaFinalizar);

                        showToast('Preferências salvas com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao salvar preferências:', error);
                        showToast('Erro ao salvar preferências.', 'error');
                    }
                },

                // Roles and Users actions
                async loadRolesAndUsers() {
                    try {
                        console.log('[Config] Loading roles and users...');
                        const response = await window.api.call('GET', 'roles');
                        console.log('[Config] Roles API response:', response);
                        this.roles = response.roles || [];
                        this.users = response.usuarios || [];
                        console.log('[Config] ✅ Roles and users loaded');
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar roles e usuários:', error);
                        // Don't show toast - this might be because backend doesn't have the endpoint yet
                        // Silent fail is acceptable for this feature
                        this.roles = [];
                        this.users = [];
                    }
                },

                openRoleModal(role = null) {
                    if (role) {
                        this.roleForm.id = role.id;
                        this.roleForm.nome = role.nome;
                        this.roleForm.selectedPermissions = role.permissoes?.map(p => p.name) || [];
                    } else {
                        this.roleForm = {
                            id: null,
                            nome: '',
                            selectedPermissions: []
                        };
                    }
                    this.modals.role = true;
                },

                closeRoleModal() {
                    this.modals.role = false;
                    this.roleForm = {
                        id: null,
                        nome: '',
                        selectedPermissions: []
                    };
                    this.expandedPermissions = [];
                },

                async saveRole() {
                    try {
                        const data = {
                            id: this.roleForm.id || null,
                            nome: this.roleForm.nome,
                            permissoes: this.roleForm.selectedPermissions
                        };

                        console.log('[Config] Saving role:', data);
                        await window.api.call('POST', 'roles', data);
                        showToast('Função salva com sucesso!', 'success');
                        this.closeRoleModal();
                        await this.loadRolesAndUsers();
                    } catch (error) {
                        console.error('Erro ao salvar função:', error);
                        showToast(error.message || 'Erro ao salvar função.', 'error');
                    }
                },

                deleteRole(id, nome) {
                    this.confirmModal = {
                        title: 'Excluir Função',
                        message: `Tem certeza que deseja excluir a função "${nome}"? Apenas funções sem usuários podem ser excluídas.`,
                        onConfirm: async () => {
                            try {
                                await window.api.call('DELETE', `roles/${id}`);
                                showToast('Função excluída com sucesso!', 'success');
                                await this.loadRolesAndUsers();
                            } catch (error) {
                                console.error('Erro ao excluir função:', error);
                                showToast(error.message || 'Erro ao excluir função.', 'error');
                            }
                            this.modals.confirm = false;
                        }
                    };
                    this.modals.confirm = true;
                },

                openUserModal(user = null) {
                    if (user) {
                        this.userForm = {
                            id: user.id,
                            nome: user.nome,
                            email: user.email,
                            senha: '',
                            roleId: user.roleInt?.id || '',
                            maxDesconto: user.maxDesconto || 0
                        };
                    } else {
                        this.userForm = {
                            id: null,
                            nome: '',
                            email: '',
                            senha: '',
                            roleId: '',
                            maxDesconto: 0
                        };
                    }
                    this.modals.user = true;
                },

                closeUserModal() {
                    this.modals.user = false;
                    this.userForm = {
                        id: null,
                        nome: '',
                        email: '',
                        senha: '',
                        roleId: '',
                        maxDesconto: 0
                    };
                },

                async saveUser() {
                    try {
                        const data = {
                            nome: this.userForm.nome,
                            email: this.userForm.email,
                            roleId: this.userForm.roleId,
                            maxDesconto: this.userForm.maxDesconto || 0
                        };

                        if (this.userForm.senha) {
                            data.senha = this.userForm.senha;
                        }

                        console.log('[Config] Saving user:', data);

                        if (this.userForm.id) {
                            await window.api.call('PATCH', `roles/subaccount/${this.userForm.id}`, data);
                            showToast('Usuário atualizado com sucesso!', 'success');
                        } else {
                            await window.api.call('POST', 'roles/subaccount', data);
                            showToast('Usuário criado com sucesso!', 'success');
                        }

                        this.closeUserModal();
                        await this.loadRolesAndUsers();
                    } catch (error) {
                        console.error('Erro ao salvar usuário:', error);
                        showToast(error.message || 'Erro ao salvar usuário.', 'error');
                    }
                },

                deleteUser(id, nome) {
                    this.confirmModal = {
                        title: 'Excluir Usuário',
                        message: `Tem certeza que deseja excluir o usuário "${nome}" permanentemente?`,
                        onConfirm: async () => {
                            try {
                                await window.api.call('DELETE', `roles/subaccount/${id}`);
                                showToast('Usuário excluído com sucesso!', 'success');
                                await this.loadRolesAndUsers();
                            } catch (error) {
                                console.error('Erro ao excluir usuário:', error);
                                showToast(error.message || 'Erro ao excluir usuário.', 'error');
                            }
                            this.modals.confirm = false;
                        }
                    };
                    this.modals.confirm = true;
                },

                togglePermissionGroup(permName) {
                    const index = this.expandedPermissions.indexOf(permName);
                    if (index > -1) {
                        this.expandedPermissions.splice(index, 1);
                    } else {
                        this.expandedPermissions.push(permName);
                    }
                },

                handleMasterCheckboxChange(perm) {
                    if (perm.sub_permissions) {
                        const isChecked = this.roleForm.selectedPermissions.includes(perm.name);
                        if (isChecked) {
                            // Add all sub-permissions
                            perm.sub_permissions.forEach(sub => {
                                if (!this.roleForm.selectedPermissions.includes(sub.name)) {
                                    this.roleForm.selectedPermissions.push(sub.name);
                                }
                            });
                        } else {
                            // Remove all sub-permissions
                            perm.sub_permissions.forEach(sub => {
                                const index = this.roleForm.selectedPermissions.indexOf(sub.name);
                                if (index > -1) {
                                    this.roleForm.selectedPermissions.splice(index, 1);
                                }
                            });
                        }
                    }
                },

                handleSubCheckboxChange(perm, sub) {
                    // Check if any sub-permission is checked
                    const anySubChecked = perm.sub_permissions.some(s =>
                        this.roleForm.selectedPermissions.includes(s.name)
                    );

                    // Update master checkbox based on sub-checkboxes
                    const masterIndex = this.roleForm.selectedPermissions.indexOf(perm.name);
                    if (anySubChecked && masterIndex === -1) {
                        this.roleForm.selectedPermissions.push(perm.name);
                    } else if (!anySubChecked && masterIndex > -1) {
                        this.roleForm.selectedPermissions.splice(masterIndex, 1);
                    }
                },

                // Tokens actions
                async loadTokens() {
                    try {
                        console.log('[Config] Loading tokens...');
                        const response = await window.api.getLavadorTokens();
                        console.log('[Config] Tokens API response:', response);
                        this.tokens = response.tokens || [];
                        console.log('[Config] ✅ Tokens loaded:', this.tokens.length, 'items');
                    } catch (error) {
                        console.error('[Config] ❌ Erro ao carregar tokens:', error);
                        // Silent fail - tokens might not exist yet
                        this.tokens = [];
                    }
                },

                async copyTokenLink(token) {
                    try {
                        const link = `${window.location.origin}/lavador-publico.html?token=${token}`;
                        await navigator.clipboard.writeText(link);
                        showToast('Link copiado para a área de transferência!', 'success');
                    } catch (error) {
                        console.error('Erro ao copiar link:', error);
                        showToast('Falha ao copiar o link.', 'error');
                    }
                },

                async updateTokenStatus(tokenId, ativo) {
                    try {
                        console.log('[Config] Updating token status:', tokenId, ativo);
                        await window.api.updateLavadorTokenStatus(tokenId, { ativo });
                        showToast(`Token ${ativo ? 'ativado' : 'desativado'} com sucesso!`, 'success');
                        await this.loadTokens();
                    } catch (error) {
                        console.error('Erro ao alterar status do token:', error);
                        showToast('Erro ao alterar status do token.', 'error');
                        await this.loadTokens(); // Reload to revert UI
                    }
                },

                deleteToken(tokenId, lavadorNome) {
                    this.confirmModal = {
                        title: 'Excluir Token',
                        message: `Tem certeza que deseja excluir permanentemente o token de acesso de "${lavadorNome}"? Esta ação não pode ser desfeita.`,
                        onConfirm: async () => {
                            try {
                                await window.api.deleteLavadorToken(tokenId);
                                showToast('Token excluído com sucesso!', 'success');
                                await this.loadTokens();
                            } catch (error) {
                                console.error('Erro ao excluir token:', error);
                                showToast(error.message || 'Erro ao excluir token.', 'error');
                            }
                            this.modals.confirm = false;
                        }
                    };
                    this.modals.confirm = true;
                },

                // Service actions
                openServiceModal(service = null) {
                    if (service) {
                        this.serviceForm.id = service.id;
                        this.serviceForm.nome = service.nome;
                        this.serviceForm.preco = service.preco;

                        const tipoPrincipal = service.tiposVeiculo && service.tiposVeiculo.length > 0
                            ? service.tiposVeiculo[0].nome
                            : '';
                        this.serviceForm.tipoVeiculo = tipoPrincipal;

                        if (tipoPrincipal === 'CARRO') {
                            this.updateSubtipoOptions();
                            const categorias = service.tiposVeiculo
                                .map(t => t.categoria)
                                .filter(Boolean);
                            this.serviceForm.subtiposVeiculo = categorias;
                        } else {
                            this.serviceForm.subtiposVeiculo = [];
                        }
                    } else {
                        this.serviceForm = {
                            id: null,
                            nome: '',
                            preco: '',
                            tipoVeiculo: '',
                            subtiposVeiculo: []
                        };
                        this.subtipoOptions = [];
                    }
                    this.modals.service = true;
                },

                closeServiceModal() {
                    this.modals.service = false;
                    this.serviceForm = {
                        id: null,
                        nome: '',
                        preco: '',
                        tipoVeiculo: '',
                        subtiposVeiculo: []
                    };
                    this.subtipoOptions = [];
                },

                updateSubtipoOptions() {
                    if (this.serviceForm.tipoVeiculo === 'CARRO') {
                        this.subtipoOptions = this.tiposVeiculo.filter(t =>
                            t.nome === 'CARRO' && t.categoria
                        );
                    } else {
                        this.subtipoOptions = [];
                        this.serviceForm.subtiposVeiculo = [];
                    }
                },

                async saveService() {
                    // Validate price
                    const preco = parseFloat(this.serviceForm.preco);
                    if (isNaN(preco) || preco <= 0) {
                        showToast('O preço deve ser maior que zero.', 'error');
                        return;
                    }

                    try {
                        const data = {
                            nome: this.serviceForm.nome,
                            preco: preco,
                            tipoVeiculo: this.serviceForm.tipoVeiculo
                        };

                        if (this.serviceForm.tipoVeiculo === 'CARRO' && this.serviceForm.subtiposVeiculo.length > 0) {
                            data.subtiposVeiculo = this.serviceForm.subtiposVeiculo;
                        }

                        if (this.serviceForm.id) {
                            await window.api.updateServico(this.serviceForm.id, data);
                            showToast('Serviço atualizado com sucesso!', 'success');
                        } else {
                            await window.api.createServico(data);
                            showToast('Serviço criado com sucesso!', 'success');
                        }

                        this.closeServiceModal();
                        await this.loadServices();
                    } catch (error) {
                        console.error('Erro ao salvar serviço:', error);
                        showToast(error.message || 'Erro ao salvar serviço.', 'error');
                    }
                },

                deleteService(id) {
                    this.confirmModal = {
                        title: 'Excluir Serviço',
                        message: 'Tem certeza que deseja excluir este serviço? Esta ação não pode ser desfeita.',
                        onConfirm: async () => {
                            try {
                                await window.api.deleteServico(id);
                                showToast('Serviço excluído com sucesso!', 'success');
                                await this.loadServices();
                            } catch (error) {
                                console.error('Erro ao excluir serviço:', error);
                                showToast(error.message || 'Erro ao excluir serviço.', 'error');
                            }
                        }
                    };
                    this.modals.confirm = true;
                },

                // Adicional actions
                openAdicionalModal(adicional = null) {
                    if (adicional) {
                        this.adicionalForm = {
                            id: adicional.id,
                            nome: adicional.nome,
                            preco: adicional.preco
                        };
                    } else {
                        this.adicionalForm = {
                            id: null,
                            nome: '',
                            preco: ''
                        };
                    }
                    this.modals.adicional = true;
                },

                closeAdicionalModal() {
                    this.modals.adicional = false;
                    this.adicionalForm = {
                        id: null,
                        nome: '',
                        preco: ''
                    };
                },

                async saveAdicional() {
                    // Validate price
                    const preco = parseFloat(this.adicionalForm.preco);
                    if (isNaN(preco) || preco <= 0) {
                        showToast('O preço deve ser maior que zero.', 'error');
                        return;
                    }

                    try {
                        const data = {
                            nome: this.adicionalForm.nome,
                            preco: preco
                        };

                        if (this.adicionalForm.id) {
                            await window.api.updateAdicional(this.adicionalForm.id, data);
                            showToast('Adicional atualizado com sucesso!', 'success');
                        } else {
                            await window.api.createAdicional(data);
                            showToast('Adicional criado com sucesso!', 'success');
                        }

                        this.closeAdicionalModal();
                        await this.loadAdicionais();
                    } catch (error) {
                        console.error('Erro ao salvar adicional:', error);
                        showToast('Erro ao salvar adicional.', 'error');
                    }
                },

                deleteAdicional(id) {
                    this.confirmModal = {
                        title: 'Excluir Adicional',
                        message: 'Tem certeza que deseja excluir este adicional? Esta ação não pode ser desfeita.',
                        onConfirm: async () => {
                            try {
                                await window.api.deleteAdicional(id);
                                showToast('Adicional excluído com sucesso!', 'success');
                                await this.loadAdicionais();
                            } catch (error) {
                                console.error('Erro ao excluir adicional:', error);
                                showToast(error.message || 'Erro ao excluir adicional.', 'error');
                            }
                        }
                    };
                    this.modals.confirm = true;
                },

                // Theme actions
                async saveTheme() {
                    try {
                        // Validate HEX format
                        const hexRegex = /^#[0-9A-F]{6}$/i;
                        if (!hexRegex.test(this.theme.corPrimaria)) {
                            showToast('Cor primária inválida. Use formato HEX (ex: #FF5733)', 'error');
                            return;
                        }
                        if (!hexRegex.test(this.theme.corSecundaria)) {
                            showToast('Cor secundária inválida. Use formato HEX (ex: #1F2937)', 'error');
                            return;
                        }

                        await window.api.updateThemeConfig({
                            corPrimaria: this.theme.corPrimaria.toUpperCase(),
                            corSecundaria: this.theme.corSecundaria.toUpperCase()
                        });

                        // CRITICAL: Enable custom theme system-wide
                        if (typeof window.enableCustomTheme === 'function') {
                            window.enableCustomTheme();
                        } else {
                            localStorage.setItem('customThemeEnabled', 'true');
                        }

                        // Apply immediately to document
                        this.applyThemeToDocument();

                        showToast('Tema personalizado salvo com sucesso! Recarregue as páginas para aplicar.', 'success');
                    } catch (error) {
                        console.error('Erro ao salvar tema:', error);
                        showToast(error.error || 'Erro ao salvar personalização do tema.', 'error');
                    }
                },

                resetTheme() {
                    this.theme.corPrimaria = '#F59E0B';
                    this.theme.corSecundaria = '#1F2937';

                    // CRITICAL: Disable custom theme when resetting to default
                    if (typeof window.disableCustomTheme === 'function') {
                        window.disableCustomTheme();
                    } else {
                        localStorage.removeItem('customThemeEnabled');
                    }

                    // Apply default theme to document
                    this.applyThemeToDocument();

                    showToast('Tema padrão restaurado com sucesso!', 'success');
                },

                applyThemeToDocument() {
                    // Apply primary color
                    document.documentElement.style.setProperty('--primary-color', this.theme.corPrimaria);
                    document.documentElement.style.setProperty('--primary-purple', this.theme.corPrimaria);

                    // Apply secondary color
                    document.documentElement.style.setProperty('--text-primary', this.theme.corSecundaria);
                    document.documentElement.style.setProperty('--text-secondary', this.theme.corSecundaria);

                    // Generate lighter version for backgrounds
                    const primaryLight = this.theme.corPrimaria + '15'; // Add alpha for transparency
                    document.documentElement.style.setProperty('--primary-color-light', primaryLight);
                },

                adjustBrightness(hex, percent) {
                    // Remove # if present
                    hex = hex.replace('#', '');

                    // Convert to RGB
                    const r = parseInt(hex.substring(0, 2), 16);
                    const g = parseInt(hex.substring(2, 4), 16);
                    const b = parseInt(hex.substring(4, 6), 16);

                    // Adjust brightness
                    const newR = Math.max(0, Math.min(255, r + (r * percent / 100)));
                    const newG = Math.max(0, Math.min(255, g + (g * percent / 100)));
                    const newB = Math.max(0, Math.min(255, b + (b * percent / 100)));

                    // Convert back to hex
                    const toHex = (n) => {
                        const hex = Math.round(n).toString(16);
                        return hex.length === 1 ? '0' + hex : hex;
                    };

                    return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
                },

                // Utilities
                formatCurrency(value) {
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value || 0);
                }
            }
        }

        // Watch for tab changes and save to localStorage
        document.addEventListener('alpine:init', () => {
            Alpine.data('configApp', configApp);
        });

        // Save active tab to localStorage
        document.addEventListener('click', (e) => {
            const tabButton = e.target.closest('.tab-button');
            if (tabButton) {
                const app = Alpine.$data(document.querySelector('[x-data]'));
                if (app) {
                    setTimeout(() => {
                        localStorage.setItem('activeConfigTab', app.activeTab);
                    }, 0);
                }
            }
        });

        // Notification system
        window.initializeNotificationSystem = function() {
            const bell = document.getElementById('notification-bell');
            const panel = document.getElementById('notification-panel');

            if (!bell || !panel) return;

            bell.addEventListener('click', (e) => {
                e.stopPropagation();
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    markAllAsRead();
                }
            });

            document.addEventListener('click', (e) => {
                if (!panel.contains(e.target) && !bell.contains(e.target)) {
                    panel.classList.remove('active');
                }
            });

            loadNotifications();
            setInterval(loadNotifications, 30000);
        };

        async function loadNotifications() {
            try {
                const response = await window.api.getNotificacoes({ limit: 5 });
                const notifications = response.notificacoes || [];
                const panel = document.getElementById('notification-panel');
                const dot = document.getElementById('notification-dot');

                if (!panel || !dot) return;

                panel.innerHTML = '<div class="notification-panel-header"><h4>Notificações</h4></div>';

                if (notifications.length > 0) {
                    const hasUnread = notifications.some(n => !n.lida);
                    dot.style.display = hasUnread ? 'block' : 'none';

                    notifications.forEach(n => {
                        const item = document.createElement('div');
                        item.className = `notification-item ${n.lida ? '' : 'unread'}`;
                        item.innerHTML = `
                            <div class="notification-content">
                                <p>${n.mensagem}</p>
                                <small class="text-secondary">${new Date(n.createdAt).toLocaleString('pt-BR')}</small>
                            </div>
                        `;
                        panel.appendChild(item);
                    });
                } else {
                    dot.style.display = 'none';
                    panel.innerHTML += '<div class="notification-empty">Nenhuma notificação nova.</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }

        async function markAllAsRead() {
            await window.api.marcarTodasComoLidas();
            document.getElementById('notification-dot').style.display = 'none';
        }

        function logout() {
            window.api.logout();
        }
    </script>
    <script src="nav-menu-helper.js"></script>
</body>
</html>

























